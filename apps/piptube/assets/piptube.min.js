function PipTube(){function T(){m&&clearInterval(m),m=null}function U(a){try{const b=fs.readdir(l('',a))||[];for(let c=0;c<b.length;c++){const d=b[c];const e=o(a,d);try{fs.readdir(l('',e))}catch(a){if(/\.avi$/i.test(d))return!0}}}catch(a){}return!1}function n(){if(!M)return;g.setColor(S),g.drawRect(j),g.drawRect(a)}function V(){if(T(),(typeof drawFooter)[0]!='f'){log('drawFooter function is not defined');return}m=setInterval(drawFooter,P)}function r(){const i=e*h;const j=c.slice(i,i+h);g.setColor(p).fillRect(a),g.setFontMonofonto16().setFontAlign(-1,-1,0);const d=4,f=4,k=5,l=20;j.forEach((e,j)=>{const h=a.y1+j*l+k;let i=X(e);let m=j===b?q:R;e.type==='ptl'&&(m=j===b?D:Q),g.setColor(m);let c=a.x1;e.type==='folder'?(g.drawImage(z,c,h+d),c+=z.width+f):e.type==='up'?(g.drawImage(A,c,h+d),c+=A.width+f):e.type==='file'?(g.drawImage(B,c,h+d),c+=B.width+f):e.type==='ptl'&&(g.drawImage(C,c,h+d),c+=C.width+f);const n=a.x2-2-c;i=W(i,n),g.drawString(i,c,h,!0)}),n()}function W(a,f){if(g.stringWidth(a)<=f)return a;const d='...',h=g.stringWidth(d);let b=0,c=a.length,e=0;while(b<=c){const d=b+c>>1;const i=a.slice(0,d);g.stringWidth(i)+h<=f?(e=d,b=d+1):c=d-1}return a.slice(0,e)+d}function X(b){let a=b.name;return b.type==='file'&&(a=a.replace(/\.avi$/i,'')),a}function l(a,b){return'/'+o(a,b)}function Y(b){const a=b.lastIndexOf('/');return a<=0?'':b.slice(0,a)}function Z(g){const j=Date.now();if(j-y<N)return;if(y=j,d){if(g!==0)return;i();return}if(g!==0)return H(g*-1);const k=e*h;const a=c[k+b];if(!a)return;if(a.type==='ptl'){i(),n();return}if(a.type==='up')return i(),I(Y(f));if(a.type==='folder')return i(),I(o(f,a.name));if(a.type==='file'){a4(a);return}}function _(){i(),K(),E.reboot()}function $(a){if(d)return;H(a)}function a0(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function a1(a){try{return fs.readdir(l('',a)),!0}catch(a){return!1}}function F(a,b){return l(a,b).length>O}function G(i){const a=i||f;a6();let d=[];try{d=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(b){print('Failed to read dir:',a,b),d=[]}const g=[];const h=[];for(let b=0;b<d.length;b++){const c=d[b];const e=o(a,c);a1(e)?U(e)&&g.push(c):/\.avi$/i.test(c)&&h.push(c)}a!==''&&c.push({type:'up',name:'BACK'}),g.forEach(b=>{F(a,b)?c.push({type:'ptl',name:b}):c.push({type:'folder',name:b})}),h.forEach(b=>{F(a,b)?c.push({type:'ptl',name:b}):c.push({type:'file',name:b})}),e=0,b=0,r()}function H(i){if(d)return;const a=e*h;const f=c.slice(a,a+h);const g=Math.floor((c.length-1)/h);b+=i,b<0?e>0?(e--,b=h-1):b=0:b>=f.length&&(e<g?(e++,b=0):b=f.length-1),r()}function I(a){i(),f=a,G(f)}function a2(){if(!(d||k))return;J()}function a3(){try{const a=MODEINFO&&MODEINFO[MODE.DATA];if(!a)return;a.submenu||(a.submenu={});const d=Object.keys(a.submenu);const c=d.find(a=>a.toUpperCase().includes('MAINT'));const b=L.name.toUpperCase();c?(a.submenu[b]=a.submenu[c],delete a.submenu[c]):a.submenu[b]||((typeof submenuBlank)[0]=='f'?a.submenu[b]=submenuBlank(b):a.submenu[b]=function(){}),drawHeader(MODE.DATA)}catch(a){print('patchDataSubtabLabel error:',a)}}function o(a,b){return a?b?a+'/'+b:a:b}function a4(b){try{const c=l(f,b.name);g.setColor(p).fillRect(a.x1-1,a.y1-1,a.x2+2,a.y2+2),Pip.audioStop&&Pip.audioStop(),Pip.videoStop&&Pip.videoStop(),log('Playing video, path: "'+c+'"');const e={x:a.x1,y:a.y1,repeat:!0};Pip.videoStart(c,e),k=c,d=!0}catch(a){log('Error starting video:',a),d=!1,k=null}}function J(){d=!1,k=null,g.setColor(p).fillRect(0,0,t-1,u-1),Pip.mode=MODE.DATA,drawHeader(MODE.DATA),r(),n()}function K(){Pip.removeAllListeners(v),Pip.removeAllListeners(w),Pip.removeAllListeners(x),Pip.removeAllListeners('videoStopped')}function a5(){Pip.on(v,Z),Pip.on(w,$),Pip.on(x,a0),Pip.on('videoStopped',a2),setWatch(()=>_(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function i(){if(!(d||k))return;try{Pip.videoStop()}catch(a){}J()}function a6(){c=[]}const s={};const L=JSON.parse(fs.readFileSync('APPINFO/piptube.info'));const t=g.getWidth();const u=g.getHeight();const M=!1;const j={x1:60,y1:40,x2:t-60,y2:u-20};const a={x1:j.x1+10,y1:j.y1+30,x2:j.x2-10,y2:j.y2-20};const v='knob1';const w='knob2';const x='torch';const N=10;let y=0;const O=56;let f='';let k=null;let d=!1;const P=49.99923706054;let m=null;const z=Graphics.createImage(`
    .......XXXXX..
    XXXXXXX.....XX
    X............X
    X............X
    X............X
    X............X
    X............X
    X............X
    XXXXXXXXXXXXXX
  `);const A=Graphics.createImage(`
    ........X.....
    .......XX.....
    ......XXX.....
    .....XXXX.....
    ....XXXXX.....
    .....XXXX.....
    ......XXX.....
    .......XX.....
    ........X.....
  `);const B=Graphics.createImage(`
    .............. 
    .XXXXXXXXXXXX.
    .X..........X.
    .X..XXXXXX..X.
    .X..X....X..X.
    .X..X....X..X.
    .X..X....X..X.
    .X..XXXXXX..X.
    .X..........X.
    .XXXXXXXXXXXX.
    ..............
  `);const C=Graphics.createImage(`
    ..............
    ..XX......XX..
    ...XX....XX...
    ....XX..XX....
    .....XXXX.....
    ....XX..XX....
    ...XX....XX...
    ..XX......XX..
    ..............
  `);const h=10;let e=0;let b=0;let c=[];const p='#000000';const D='#FF0000';const Q=g.blendColor('#000',D,.5);const q=g.theme.fg;const R=g.blendColor('#000',q,.5);const S=g.blendColor('#000',q,.75);return s.run=function(){settings.idleTimeout=0,Pip.mode=MODE.DATA,drawHeader(Pip.mode),a3(),K(),a5(),G(f),V(),n()},s}PipTube().run()