function PipTube(){function U(){m&&clearInterval(m),m=null}function V(a){try{const b=fs.readdir(l('',a))||[];for(let c=0;c<b.length;c++){const d=b[c];const e=o(a,d);try{fs.readdir(l('',e))}catch(a){if(/\.avi$/i.test(d))return!0}}}catch(a){}return!1}function n(){if(!p)return;g.setColor(G),g.drawRect(j),g.drawRect(a)}function H(){if(U(),(typeof drawFooter)[0]!='f'){log('drawFooter function is not defined');return}m=setInterval(drawFooter,R)}function s(){const i=e*h;const j=c.slice(i,i+h);g.setColor(q).fillRect(a),g.setFontMonofonto16().setFontAlign(-1,-1,0);const d=4,f=4,k=5,l=20;j.forEach((e,j)=>{const h=a.y1+j*l+k;let i=X(e);let m=j===b?r:T;e.type==='ptl'&&(m=j===b?F:S),g.setColor(m);let c=a.x1;e.type==='folder'?(g.drawImage(A,c,h+d),c+=A.width+f):e.type==='up'?(g.drawImage(B,c,h+d),c+=B.width+f):e.type==='file'?(g.drawImage(C,c,h+d),c+=C.width+f):e.type==='ptl'&&(g.drawImage(D,c,h+d),c+=D.width+f);const n=a.x2-2-c;i=W(i,n),g.drawString(i,c,h,!0)}),n()}function W(a,f){if(g.stringWidth(a)<=f)return a;const d='...',h=g.stringWidth(d);let b=0,c=a.length,e=0;while(b<=c){const d=b+c>>1;const i=a.slice(0,d);g.stringWidth(i)+h<=f?(e=d,b=d+1):c=d-1}return a.slice(0,e)+d}function X(b){let a=b.name;return b.type==='file'&&(a=a.replace(/\.avi$/i,'')),a}function l(a,b){return'/'+o(a,b)}function Y(b){const a=b.lastIndexOf('/');return a<=0?'':b.slice(0,a)}function Z(g){const j=Date.now();if(j-z<P)return;if(z=j,d){if(g!==0)return;i();return}if(g!==0)return K(g*-1);const k=e*h;const a=c[k+b];if(!a)return;if(a.type==='ptl')i(),n();else if(a.type==='up')i(),L(Y(f));else if(a.type==='folder')i(),L(o(f,a.name));else if(a.type==='file'){Pip.audioStartVar(Pip.audioBuiltin('CLICK')),a4(a);return}Pip.audioStartVar(Pip.audioBuiltin('OK'))}function _(){i(),N(),E.reboot()}function $(a){if(d)return;K(a)}function a0(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function a1(a){try{return fs.readdir(l('',a)),!0}catch(a){return!1}}function I(a,b){return l(a,b).length>Q}function J(i){const a=i||f;a6();let d=[];try{d=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(b){print('Failed to read dir:',a,b),d=[]}const g=[];const h=[];for(let b=0;b<d.length;b++){const c=d[b];const e=o(a,c);a1(e)?V(e)&&g.push(c):/\.avi$/i.test(c)&&h.push(c)}a!==''&&c.push({type:'up',name:'BACK'}),g.forEach(b=>{I(a,b)?c.push({type:'ptl',name:b}):c.push({type:'folder',name:b})}),h.forEach(b=>{I(a,b)?c.push({type:'ptl',name:b}):c.push({type:'file',name:b})}),e=0,b=0,s()}function K(g){if(d)return;const a=e*h;const f=c.slice(a,a+h);const i=Math.floor((c.length-1)/h);b+=g,b<0?e>0?(e--,b=h-1):b=0:b>=f.length&&(e<i?(e++,b=0):b=f.length-1),g>0?Pip.audioStartVar(Pip.audioBuiltin('PREV')):Pip.audioStartVar(Pip.audioBuiltin('NEXT')),s()}function L(a){i(),f=a,J(f)}function a2(){if(!(d||k))return;M()}function a3(){try{const a=MODEINFO&&MODEINFO[MODE.DATA];if(!a)return;a.submenu||(a.submenu={});const d=Object.keys(a.submenu);const c=d.find(a=>a.toUpperCase().includes('MAINT'));const b=O.name.toUpperCase();c?(a.submenu[b]=a.submenu[c],delete a.submenu[c]):a.submenu[b]||((typeof submenuBlank)[0]=='f'?a.submenu[b]=submenuBlank(b):a.submenu[b]=function(){}),drawHeader(MODE.DATA)}catch(a){print('patchDataSubtabLabel error:',a)}}function o(a,b){return a?b?a+'/'+b:a:b}function a4(b){try{const c=l(f,b.name);g.setColor(q).fillRect(a.x1-1,a.y1-1,a.x2+2,a.y2+2),Pip.audioStop&&Pip.audioStop(),Pip.videoStop&&Pip.videoStop(),p&&log('Playing video, path: "'+c+'"');const e={x:a.x1,y:a.y1,debug:p,repeat:!0};Pip.videoStart(c,e),g.setColor(G),g.drawRect({x:a.x1-1,y:a.y1-1,x2:a.x2+1,y2:a.y2+1}),k=c,d=!0}catch(a){log('Error starting video:',a),d=!1,k=null}}function M(){d=!1,k=null,g.setColor(q).fillRect(0,0,u-1,v-1),Pip.mode=MODE.DATA,drawHeader(MODE.DATA),s(),H(),n()}function N(){Pip.removeAllListeners(w),Pip.removeAllListeners(x),Pip.removeAllListeners(y),Pip.removeAllListeners('videoStopped')}function a5(){Pip.on(w,Z),Pip.on(x,$),Pip.on(y,a0),Pip.on('videoStopped',a2),setWatch(()=>_(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function i(){if(!(d||k))return;try{Pip.videoStop()}catch(a){}M()}function a6(){c=[]}const t={};const O=JSON.parse(fs.readFileSync('APPINFO/piptube.info'));const u=g.getWidth();const v=g.getHeight();const p=!1;const j={x1:60,y1:40,x2:u-60,y2:v-20};const a={x1:j.x1+10,y1:j.y1+30,x2:j.x2-10,y2:j.y2-20};const w='knob1';const x='knob2';const y='torch';const P=10;let z=0;const a7=12;const Q=56;let f='';let k=null;let d=!1;const R=49.99923706054;let m=null;const A=Graphics.createImage(`
    .......XXXXX..
    XXXXXXX.....XX
    X............X
    X............X
    X............X
    X............X
    X............X
    X............X
    XXXXXXXXXXXXXX
  `);const B=Graphics.createImage(`
    ........X.....
    .......XX.....
    ......XXX.....
    .....XXXX.....
    ....XXXXX.....
    .....XXXX.....
    ......XXX.....
    .......XX.....
    ........X.....
  `);const C=Graphics.createImage(`
    ....XXXXX.....
    ...X.....X....
    ..X.......X...
    .X...X.....X..
    .X...XXX...X..
    .X...XXXX..X..
    .X...XXX...X..
    .X...X.....X..
    ..X.......X...
    ...X.....X....
    ....XXXXX.....
  `);const D=Graphics.createImage(`
    ..............
    ..XX......XX..
    ...XX....XX...
    ....XX..XX....
    .....XXXX.....
    ....XX..XX....
    ...XX....XX...
    ..XX......XX..
    ..............
  `);const h=10;let e=0;let b=0;let c=[];const q='#000000';const F='#FF0000';const S=g.blendColor('#000',F,.5);const r=g.theme.fg;const T=g.blendColor('#000',r,.5);const G=g.blendColor('#000',r,.75);return t.run=function(){settings.idleTimeout=0,Pip.mode=MODE.DATA,drawHeader(Pip.mode),a3(),N(),a5(),J(f),H(),n()},t}PipTube().run()