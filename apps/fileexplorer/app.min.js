function FileExplorer(){function B(a,b){return a==='/'||a===''?'/'+b:a+'/'+b}function f(){a.clear(),a.setColor(i).setFont('6x8',2).setFontAlign(0,0).drawString(y+' v'+z,j/2,20),a.setColor(l).setFontAlign(0,0).setFont('6x8',1);let f=d.slice(c,c+t);f.forEach(function(d,m){let n=c+m===b;a.setColor(n?i:l);let f='';let o=d.name==='..'?d.depth:d.depth-v.split('/').length+1;for(let a=0;a<Math.max(0,o);a++)f+='...';let p=d.type==='dir'?'[DIR] ':'[FILE] ';let g=f+p+d.name;let h=a.stringWidth(g);let j=60+h/2;let k=s+m*r;a.drawString(g,j,k),d.path===e&&a.drawString(' (PLAYING)',j+h+4,k)})}function w(a){try{let g=fs.readdir(a)||[];let e=a.split('/').length-1;v=a,d=[],a!==m&&d.push({name:'..',path:a.split('/').slice(0,-1).join('/')||'/',type:'dir',depth:e-1}),g.forEach(c=>{let b=B(a,c);if(u&&(c==='.'||c==='..'||b.includes('/./')||b.includes('/../')))return;let f='file';try{fs.readdir(b),f='dir'}catch(a){}d.push({name:c,path:b,type:f,depth:e})}),b=0,c=0,f()}catch(b){console.log('Failed to load dir:',a)}}function n(){h&&(Pip.videoStop(),h=!1,f())}function o(){n(),b>0&&b--,b<c&&c--,f()}function p(){n(),b<d.length-1&&b++,b>=c+t&&c++,f()}function x(){const c=d[b];if(!c)return;if(c.type==='dir'){w(c.path);return}const g=c.name.toLowerCase();if(h){n();return}if(g.endsWith('.wav')){e===c.path?(Pip.audioStop(),e=null,f()):(Pip.audioStop(),Pip.audioStart(c.path),e=c.path,f());return}if(g.endsWith('.avi')){Pip.audioStop(),Pip.videoStart(c.path,{x:60,y:10}),h=!0,e=null;return}if(g.endsWith('.info')||g.endsWith('.txt')||g.endsWith('.log')||g.endsWith('.js')||g.endsWith('.json')||g.endsWith('.md')){a.clear();let b=fs.readFile(c.path).split('\n');a.setFont('6x8',1).setColor(i).setFontAlign(-1,-1);const d=70;const f=100;const g=20;const h=a.getWidth()-(d+f);b=[].concat.apply([],b.map(b=>b?a.wrapString(b,h):['']));let e=g;const j=a.stringMetrics('X').height+4;b.forEach(b=>{a.drawString(b,d,e),e+=j});return}}function C(){if(BTN_TUNEUP.read()&&o(),BTN_TUNEDOWN.read()&&p(),BTN_PLAY.read()&&x(),BTN_TORCH.read()){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}}function D(){Pip.audioStop(),Pip.videoStop(),e=null,h=!1,bC.clear(1).flip(),E.reboot()}function F(){a.clear(),a.setFont('6x8',2).setFontAlign(0,0).setColor(l).drawString('Loading...',j/2,k/2)}const q={};const a=g;const y='File Explorer';const z='2.2.0';const j=a.getWidth();const k=a.getHeight();const A='#000000';const i=g.theme.fg;const l=g.blendColor(A,i,.5);const r=12;const s=40;const t=Math.floor((k-s)/r);const m='/';let d=[];let b=0;let c=0;let e=null;let h=!1;let u=!1;let v=m;try{const a=require('Storage');const b=a.list();if(b.includes('VERSION')&&b.includes('.bootcde')){const b=a.read('VERSION')||'';const c=parseFloat(b);u=c>=1.29}}catch(a){console.log('Failed to detect JS version:',a)}return q.run=function(){if(global.ui&&global.ui.enableRamScan&&(global.ui.enableRamScan=!1),!Pip.isSDCardInserted()){a.clear(),a.setFont('6x8',2).setFontAlign(0,0).setColor('#F00').drawString('NO SD CARD DETECTED',j/2,k/2);return}F(),setTimeout(function(){w(m),setInterval(C,150)},50),Pip.removeAllListeners('knob1'),Pip.on('knob1',function(a){a<0?p():a>0?o():x()}),Pip.removeAllListeners('knob2'),Pip.on('knob2',function(a){a<0?o():a>0&&p()}),setWatch(()=>D(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},q}FileExplorer().run()