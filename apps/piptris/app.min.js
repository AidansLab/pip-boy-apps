function Piptris(){function am(){k>r&&(r=k,ah())}function Q(){g.setColor(f),g.fillRect(0,0,K,L)}function a6(){let a=0;let b=0;const d=i;while(b++<d){let b=!1;for(let e=i-1;e>=0;e--){let d=!0;for(let f=0;f<c;f++)if(!j[e*c+f]){d=!1;break}if(d){for(let f=0;f<c;f++)B(f,e);for(let f=e;f>0;f--)for(let e=0;e<c;e++)j[f*c+e]=j[(f-1)*c+e];for(let e=0;e<c;e++)j[e]=0;a++,C++,aD(),b=!0;break}}if(!b)break}b>=d&&console.log('Clear line safeguard triggered!');switch(a){case 1:k+=100;break;case 2:k+=300;break;case 3:k+=500;break;case 4:k+=800;break}}function x(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=i||f>=0&&j[f*c+e])return!0}return!1}function a7(e,f){const h=j[f*c+e];h===2?g.setColor(ak):g.setColor(d);const a=[l+e*b,m+f*b,l+(e+1)*b-1,m+(f+1)*b-1];z?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function n(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function s(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?B(a.x+d,a.y+c):a7(a.x+d,a.y+c))}function R(){g.setColor(d);for(let a=0;a<i;a++)for(let b=0;b<c;b++)j[a*c+b]?a7(b,a):B(b,a);y(),ab(),aa(),ao(),ap()}function an(){const c=20;const a=e.x1-60;const b=e.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(Z,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+aj,a,b+c)}function a8(){Q();const a=K/2;const b=L/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(h),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60),a9(a4,a-45,b-75);const c=b-20;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+k,a,c),g.drawString('Level: '+p,a,c+e),g.drawString('Lines: '+C,a,c+e*2),g.setColor(h),g.drawString('High Score: '+r,a,c+e*3+10),T(),S(),V(),G=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(G),ai())},100)}function y(d){if(!(I&&a)||q)return;let c=d&&J?J:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!x({x:c.x,y:c.y+1,shape:c.shape}))c.y++;J={x:c.x,y:c.y,shape:c.shape}}else if(!J)return;let e=d?f:h;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const d=[l+(c.x+f)*b,m+(c.y+a)*b,l+(c.x+f+1)*b-1,m+(c.y+a+1)*b-1];z?g.drawRect(d[0],d[1],d[2],d[3]):g.fillRect(d[0],d[1],d[2],d[3])}}function S(){g.setFont('6x8',1);const e=w.y2-40;const a=180;const i=e-22;const j={ON:'ON',OFF:'OFF'};const z=I?j.ON:j.OFF;const q=8;const r=2;g.setFont('6x'+q,r);const s=g.stringWidth(j.OFF);const t=q*r;const u={x1:a-s/2,y1:i-t/2,x2:a+s/2,y2:i+t};g.setColor(f),g.fillRect(u),o&&n(u),g.setColor(d),g.drawString(z,a,i+4),g.setFont('6x8',1),g.setColor(h);const v='GHOST';const x=g.stringWidth(v);g.drawString(v,a,e);const b=5;const y=8;const k=a-x/2-y-1;const l=e;g.fillPoly([k,l-b,k-b,l+b,k+b,l+b]);const m=a+x/2+y;const p=e;const c=b-1;g.fillPoly([m,p+c,m-c,p-c,m+c,p-c])}function a9(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function ao(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const p=C.toString();const q=16;const j=80;const r=c+q+10;const k=a-j/2;const i=b+c-8;const l=a+j/2;const m=i+r;g.setColor(f),g.fillRect(k,i,l,m),o&&n({x1:k-1,y1:i-1,x2:l+1,y2:m+1}),g.setColor(h),g.drawString('LINES',a,b),g.setColor(d),g.drawString(p,a,b+c)}function aa(){const a=e.x1-65;const c=e.y2-120;const j=20;g.setFont('6x8',2);const k=p.toString();const l=g.stringWidth(k);const s=16;const b=4;const m=a-l/2-b;const i=c+j-b*2;const q=a+l/2+b;const r=i+s+b;g.setColor(f),g.fillRect(m,i,q,r),o&&n({x1:m-1,y1:i-1,x2:q+1,y2:r+1}),g.setColor(h),g.drawString('LEVEL',a,c),g.setColor(d),g.drawString(k,a,c+j)}function ap(){if(!u)return;const c=e.x2+65;const a=e.y1+25;const k=4*b;const i=6;const l=c-k/2-i;const m=a+15-i;const p=c+k/2+i;const q=a+15+k+i;g.setColor(f),g.fillRect(l,m,p,q),o&&n({x1:l-1,y1:m-1,x2:p+1,y2:q+1}),g.setFont('6x8',2),g.setColor(h),g.drawString('NEXT',c,a),g.setColor(d);const j=u.shape;const s=j[0].length*b;const r=c-s/2-2;for(let d=0;d<j.length;d++)for(let e=0;e<j[d].length;e++)if(j[d][e]){const c=[r+e*b,a+20+d*b,r+(e+1)*b-1,a+20+(d+1)*b-1];z?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function T(){const c=w.y2-40;const e=300;const b=10;const q=A.length*b;const r=A[0].length*b;const i=c-q-10;const j=e-r/2;g.setFont('6x8',1),g.setColor(h);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,e,c);const a=6;const u=10;const k=e-t/2-u;const l=c;g.fillPoly([k,l,k+a,l-a,k+a,l+a]);const m=e+t/2+u;const p=c;g.fillPoly([m,p,m-a,p-a,m-a,p+a]);const v={x1:j-2,y1:i-2,x2:j+r+2,y2:i+q+2};g.setColor(f),g.fillRect(v),o&&n(v),g.setColor(d);for(let d=0;d<A.length;d++)for(let f=0;f<A[d].length;f++)if(A[d][f]){const a=j+f*b;const c=i+d*b;const e=a+b-1;const h=c+b-1;z?g.drawRect(a,c,e,h):g.fillRect(a,c,e,h)}}function ab(){const a=e.x2+65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const j=k.toString();const t=g.stringWidth(j);const r=16;const l=100;const s=c+r+10;const m=a-l/2;const i=b+c-8;const p=a+l/2;const q=i+s;g.setColor(f),g.fillRect(m,i,p,q),o&&n({x1:m-1,y1:i-1,x2:p+1,y2:q+1}),g.setColor(h),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(j,a,b+c)}function aq(){Q();const a=K/2;const b=L/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(Z,a,b-50),g.setColor(h),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15),a9(a4,a-34,b-29),r>0&&(g.setColor(h),g.setFont('6x8',2),g.drawString('High Score: '+r,a,b+35)),T(),S(),V()}function ac(){if(!a||q)return;s(!0),a.y++,x(a)?(a.y--,s(!1),ae(a),setTimeout(()=>{if(W(),x(a)){q=!0,clearInterval(v),setTimeout(a8,50);return}},50)):s(!1),n(e);const c=BTN_PLAY.read();const b=c?100:t;O!==b&&(clearInterval(v),v=setInterval(ac,b),O=b)}function ar(){if(!a||q)return;s(!0);while(!x(a))a.y++;a.y--,s(!1),ae(a),a6(),R(),W(),s(!1)}function B(a,c){g.setColor(f),g.fillRect(l+a*b,m+c*b,l+(a+1)*b-1,m+(c+1)*b-1)}function U(){let b=Math.floor(Math.random()*a5.length);let a=a5[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function as(){af()}function at(b){let a=Date.now();if(a-a2<al)return;a2=a,b===0?ar():aA(b)}function au(){ag(),clearInterval(v),bC.clear(1).flip(),E.reboot()}function av(a){ax(a>0?1:-1)}function ad(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aw(){try{let a=fs.readFileSync(_);let b=JSON.parse(a);r=b.highScore||0}catch(a){console.log('No piptris.json, using default high score.'),r=0,ah()}}function ae(a){let b=!1;for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)if(a.shape[d][e]){const f=a.x+e;const g=a.y+d;if(!(isFinite(f)&&isFinite(g))){console.log('Invalid fx/fy',f,g);continue}a.shape[d][e]===2?(o&&console.log('Nuking coords: ',f,g),f>=0&&f<c&&g>=0&&g<i?(j[g*c+f]=0,ay(f,g),b=!0):o&&console.log('Nuke is out of bounds!',f,g)):j[g*c+f]=1}b&&a6()}function ax(c){if(q||!a)return;y(!0);let b=a.x;if(a.x+=c,x(a)){a.x=b,y();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&B(b+e,a.y+d);y(),s(!1),n(e)}function ay(b,d,a){if(((typeof a)[0]!='n'||isNaN(a)||a<1)&&(a=2),H){console.log('Nuke is still nuking...');return}if(H=!0,!(isFinite(b)&&isFinite(d))){console.log('We were sent incorrect nuke coordinates!'),H=!1;return}a=Math.min(Math.max(1,a),3),b=Math.max(0,Math.min(b,c-1)),d=Math.max(0,Math.min(d,i-1));for(let e=-a;e<=a;e++)for(let f=-a;f<=a;f++){let a=b+f;let g=d+e;a>=0&&a<c&&g>=0&&g<i&&(j[g*c+a]=0,B(a,g))}H=!1}function af(){if(!P.length)return;const a=P[Math.floor(Math.random()*P.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function az(){j.fill(0),g.setColor(f),g.fillRect(l,m,l+c*b-1,m+i*b-1)}function aA(f){if(q||!a)return;y(!0);const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,x(a)){a.shape=c,y();return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&B(a.x+g,a.y+e);s(!1),y(),n(e)}function ag(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(M),Pip.removeAllListeners(a3)}function ah(){let a={highScore:r};try{fs.writeFile(_,JSON.stringify(a))}catch(a){console.log('Error saving high score:',a)}}function aB(){Pip.on(D,at),Pip.on(F,av),Pip.on(M,ad),Pip.on(a3,as)}function V(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.on(D,aC),Pip.on(F,X)}function W(){u||(u=U()),a=u,u=U(),R(),x(a)&&(q=!0,am(),clearInterval(v),setTimeout(()=>{a8()},50))}function ai(){clearInterval(v),ag(),af(),q=!1,a=null,o?(p=10,k=1e4):(p=0,k=0),C=p*a1,t=Math.max(N-p*a0,$),O=t,u=U(),Q(),az(),aa(),ab(),n(e),W(),R(),an(),aB(),v=setInterval(ac,t)}function aC(){I=!I,S()}function X(){z=!z,T()}function aD(){let a=Math.floor(C/a1);a>p&&(p=a,t=Math.max(N-p*a0,$),console.log('Level up! New speed:',t,'ms'))}const Y={};const Z='PIPTRIS';const aj='2.6.0';const o=!1;const _='USER/piptris.json';const N=800;let a=null;let t=N;let u=null;let b=15;let O=t;let G=null;let q=!1;let C=0;let v=null;let k=0;let r=0;let z=!1;let H=!1;let I=!1;let J=null;let p=0;const $=100;const a0=50;const a1=10;const K=g.getWidth();const L=g.getHeight();const w={x1:60,x2:K-60,y1:10,y2:L-10};const f='#000000';const ak='#FF0000';const d=g.theme.fg;const h=g.blendColor(f,d,.5);const c=10;const i=20;const j=new Uint8Array(c*i);const l=(w.x1+w.x2)/2-b*c/2;const m=w.y1+(w.y2-w.y1)/2-b*i/2;const e={x1:l-1,y1:m-1,x2:l+c*b,y2:m+i*b};const D='knob1';const F='knob2';const M='torch';const al=30;let a2=0;const a3='audioStopped';const P=['USER/piptris.wav'];const a4='USER/gear.json';const A=[[0,1,0],[1,1,1]];const a5=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],A,[[1,1],[1,1]],[[2]]];return Y.run=function(){bC.clear(),aw(),aq(),V(),Pip.on(M,ad),G=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(G),Pip.removeListener(D,X),Pip.removeListener(F,X),Pip.removeAllListeners(M),ai())},100),setWatch(()=>au(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},Y}Piptris().run()