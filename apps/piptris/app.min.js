function Piptris(){function av(){for(let a=i-2;a>=0;a--)for(let b=0;b<c;b++)if(f[a*c+b]){let d=a;while(d+1<i&&!f[(d+1)*c+b])f[(d+1)*c+b]=f[d*c+b],f[d*c+b]=0,d++}}function aw(){k>t&&(t=k,an())}function U(){g.setColor(h),g.fillRect(0,0,N,O)}function V(){let a=0;let b=0;const d=i;while(b++<d){let b=!1;for(let e=i-1;e>=0;e--){let d=!0;for(let g=0;g<c;g++)if(!f[e*c+g]){d=!1;break}if(d){for(let f=0;f<c;f++)F(f,e);for(let g=e;g>0;g--)for(let e=0;e<c;e++)f[g*c+e]=f[(g-1)*c+e];for(let e=0;e<c;e++)f[e]=0;a++,G++,aQ(),b=!0;break}}if(!b)break}b>=d&&console.log('Clear line safeguard triggered!');switch(a){case 1:k+=100;break;case 2:k+=300;break;case 3:k+=500;break;case 4:k+=800;break}}function A(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,g=a.y+b;if(e<0||e>=c||g>=i||g>=0&&f[g*c+e])return!0}return!1}function af(h,i,j){const k=j!==void 0?j:f[i*c+h];const a=n+h*b;const d=o+i*b;if(k===2)try{g.setColor(H),g.drawImage(x,a,d)}catch(a){console.log('Failed to load nuke image:',a)}else g.setColor(e),C?g.drawRect(a,d,a+b-1,d+b-1):g.fillRect(a,d,a+b-1,d+b-1)}function m(a){g.setColor(e),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function w(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?F(a.x+d,a.y+c):af(a.x+d,a.y+c,a.shape[c][d]))}function W(){g.setColor(e);for(let a=0;a<i;a++)for(let b=0;b<c;b++)f[a*c+b]?af(b,a):F(b,a);B(),Z(),ah(),az(),aA(),ay()}function ax(){const c=20;const a=d.x1-60;const b=d.y1+35;g.setColor(e),g.setFontMonofonto28(),g.drawString(a4,a,b),g.setColor(e),g.setFont('6x8',1),g.drawString('v'+ap,a,b+c)}function ag(){U();const a=N/2;const b=O/2;g.clear(),g.setColor(e),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(l),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60);try{g.setColor(e),g.drawImage(Q,a-45,b-75)}catch(a){console.log('Failed to load gear image:',a)}const c=b-20;const d=18;g.setColor(e),g.setFont('6x8'),g.drawString('Score: '+k,a,c),g.drawString('Level: '+r,a,c+d),g.drawString('Lines: '+G,a,c+d*2),g.setColor(l),g.drawString('High Score: '+t,a,c+d*3+10),Y(),X(),a0(),p=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(p),p=null,ao())},100)}function B(d){if(!(L&&a)||u)return;let c=d&&M?M:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!A({x:c.x,y:c.y+1,shape:c.shape}))c.y++;M={x:c.x,y:c.y,shape:c.shape}}else if(!M)return;let e=d?h:l;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const i=c.shape[a][f];const e=n+(c.x+f)*b;const h=o+(c.y+a)*b;if(!d&&i===2)try{g.setColor(ab),g.drawImage(x,e,h,{scale:b/x.width,transparency:.5})}catch(a){console.log('Failed to load nuke ghost image:',a)}else C?g.drawRect(e,h,e+b-1,h+b-1):g.fillRect(e,h,e+b-1,h+b-1)}}function X(){g.setFont('6x8',1);const d=z.y2-40;const a=180;const f=d-22;const i={ON:'ON',OFF:'OFF'};const y=L?i.ON:i.OFF;const q=8;const r=2;g.setFont('6x'+q,r);const s=g.stringWidth(i.OFF);const t=q*r;const u={x1:a-s/2,y1:f-t/2,x2:a+s/2,y2:f+t};g.setColor(h),g.fillRect(u),j&&m(u),g.setColor(e),g.drawString(y,a,f+4),g.setFont('6x8',1),g.setColor(l);const v='GHOST';const w=g.stringWidth(v);g.drawString(v,a,d);const b=5;const x=8;const k=a-w/2-x-1;const n=d;g.fillPoly([k,n-b,k-b,n+b,k+b,n+b]);const o=a+w/2+x;const p=d;const c=b-1;g.fillPoly([o,p+c,o-c,p-c,o+c,p-c])}function ay(){const a=d.x2+65;const b=d.y1+100;const c=18;if(!a7){const e=100;const f=c*2+50+10;const d={x1:a-e/2-5,y1:b-10,x2:a+e/2,y2:b+f};j&&m({x1:d.x1-1,y1:d.y1-1,x2:d.x2+1,y2:d.y2+1}),g.setColor(h),g.fillRect(d);return}g.setFont('6x8',2),g.setColor(H),g.drawString('INCOMING',a,b),g.drawString('NUKE!',a,b+c);try{const d=50;const e=a-d/2;const f=b+c*2+5;g.setColor(ab),g.drawImage(a6,e,f)}catch(a){console.log('Failed to load radioactive image:',a)}}function az(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const p=G.toString();const q=16;const i=80;const r=c+q+10;const k=a-i/2;const f=b+c-8;const n=a+i/2;const o=f+r;g.setColor(h),g.fillRect(k,f,n,o),j&&m({x1:k-1,y1:f-1,x2:n+1,y2:o+1}),g.setColor(l),g.drawString('LINES',a,b),g.setColor(e),g.drawString(p,a,b+c)}function ah(){const a=d.x1-65;const c=d.y2-120;const i=20;g.setFont('6x8',2);const k=r.toString();const n=g.stringWidth(k);const s=16;const b=4;const o=a-n/2-b;const f=c+i-b*2;const p=a+n/2+b;const q=f+s+b;g.setColor(h),g.fillRect(o,f,p,q),j&&m({x1:o-1,y1:f-1,x2:p+1,y2:q+1}),g.setColor(l),g.drawString('LEVEL',a,c),g.setColor(e),g.drawString(k,a,c+i)}function aA(){if(!s)return;const c=d.x2+65;const f=d.y1+25;const k=4*b;const i=6;const n=c-k/2-i;const o=f+15-i;const p=c+k/2+i;const q=f+15+k+i;g.setColor(h),g.fillRect(n,o,p,q),j&&m({x1:n-1,y1:o-1,x2:p+1,y2:q+1}),g.setFont('6x8',2),g.setColor(l),g.drawString('NEXT',c,f);const a=s.shape;const r=a[0].length*b;const t=c-r/2-2;for(let d=0;d<a.length;d++)for(let h=0;h<a[d].length;h++)if(a[d][h]){const j=a[d][h];const c=t+h*b;const i=f+20+d*b;if(j===2&&x)try{g.setColor(H),g.drawImage(x,c,i,{scale:b/x.width})}catch(a){console.log('Failed to load nuke image:',a)}else g.setColor(e),C?g.drawRect(c,i,c+b-1,i+b-1):g.fillRect(c,i,c+b-1,i+b-1)}}function Y(){const c=z.y2-40;const d=300;const b=10;const q=D.length*b;const r=D[0].length*b;const f=c-q-10;const i=d-r/2;g.setFont('6x8',1),g.setColor(l);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,d,c);const a=6;const u=10;const k=d-t/2-u;const n=c;g.fillPoly([k,n,k+a,n-a,k+a,n+a]);const o=d+t/2+u;const p=c;g.fillPoly([o,p,o-a,p-a,o-a,p+a]);const v={x1:i-2,y1:f-2,x2:i+r+2,y2:f+q+2};g.setColor(h),g.fillRect(v),j&&m(v),g.setColor(e);for(let e=0;e<D.length;e++)for(let h=0;h<D[e].length;h++)if(D[e][h]){const a=i+h*b;const c=f+e*b;const d=a+b-1;const j=c+b-1;C?g.drawRect(a,c,d,j):g.fillRect(a,c,d,j)}}function Z(){const a=d.x2+65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const i=k.toString();const t=g.stringWidth(i);const r=16;const n=100;const s=c+r+10;const o=a-n/2;const f=b+c-8;const p=a+n/2;const q=f+s;g.setColor(h),g.fillRect(o,f,p,q),j&&m({x1:o-1,y1:f-1,x2:p+1,y2:q+1}),g.setColor(l),g.drawString('SCORE',a,b),g.setColor(e),g.drawString(i,a,b+c)}function aB(){U();const a=N/2;const b=O/2;g.clear(),g.setColor(e),g.setFontMonofonto36(),g.drawString(a4,a,b-50),g.setColor(l),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15);try{g.setColor(e),g.drawImage(Q,a-34,b-29)}catch(a){console.log('Failed to load gear image:',a)}t>0&&(g.setColor(l),g.setFont('6x8'),g.drawString('High Score: '+t,a,b+35)),Y(),X(),a0()}function aC(){if(!a||u)return;if(w(!0),a.y++,A(a)&&(a.y--,w(!1),ak(a),V(),a1(),A(a))){u=!0,clearInterval(q),setTimeout(ag,50);return}w(!1),m(d);const c=BTN_PLAY.read();const b=c?100:y;S!==b&&(clearInterval(q),q=setInterval(aj,b),S=b)}function aD(){if(!a||u)return;w(!0);while(!A(a))a.y++;a.y--,w(!1),ak(a),V(),W(),a1(),w(!1)}function F(a,c){g.setColor(h),g.fillRect(n+a*b,o+c*b,n+(a+1)*b-1,o+(c+1)*b-1)}function _(b){b===void 0&&(b=!0);let a;while(!0){let c=Math.floor(Math.random()*ae.length);if(a=ae[c],!(!b&&a[0][0]===2))break}let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function aE(){al()}function aF(b){let a=Date.now();if(a-ac<au)return;ac=a,b===0?aD():aN(b)}function aG(){am(),clearInterval(q),bC.clear(1).flip(),E.reboot()}function aH(a){aK(a>0?1:-1)}function ai(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aI(){try{let a=fs.readFile(a5);if(!a)throw new Error('Config file missing');let b=JSON.parse(a);t=b.highScore||0}catch(a){console.log('Error loading config:',a),t=0,an()}}function aJ(){x=$(ar),Q=$(aq),a6=$(as)}function $(a){try{let c=fs.readFileSync(a);let b=JSON.parse(c);return{bpp:b.bpp,buffer:atob(b.buffer),height:b.height,transparent:b.transparent,width:b.width}}catch(b){return console.log('Failed to load image:',a,b),null}}function aj(){j&&console.log('Mem: '+process.memory().usage+'/5000'),aC()}function ak(a){let b=!1;for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)if(a.shape[d][e]){const g=a.x+e;const h=a.y+d;if(!(isFinite(g)&&isFinite(h))){console.log('Invalid fx/fy',g,h);continue}a.shape[d][e]===2?(j&&console.log('Nuking coords: ',g,h),g>=0&&g<c&&h>=0&&h<i?(f[h*c+g]=0,aL(g,h),b=!0):j&&console.log('Nuke is out of bounds!',g,h)):f[h*c+g]=1}b&&V()}function aK(c){if(u||!a)return;B(!0);let b=a.x;if(a.x+=c,A(a)){a.x=b,B();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&F(b+e,a.y+d);B(),w(!1),m(d)}function aL(e,l){if(K){console.log('Nuke is still nuking...');return}if(K=!0,!(isFinite(e)&&isFinite(l))){console.log('We were sent incorrect nuke coordinates!'),K=!1;return}e=Math.max(0,Math.min(e,c-1)),l=Math.max(0,Math.min(l,i-1));let a={x1:n+(e-v)*b+1,y1:o+(l-v)*b+1,x2:n+(e+v+1)*b-2,y2:o+(l+v+1)*b-2};a.x1=Math.max(a.x1,d.x1+1),a.y1=Math.max(a.y1,d.y1+1),a.x2=Math.min(a.x2,d.x2-1),a.y2=Math.min(a.y2,d.y2-1),g.setColor(H),g.drawRect(a);let m=0;for(let b=-v;b<=v;b++)for(let d=-v;d<=v;d++){let a=e+d;let g=l+b;a>=0&&a<c&&g>=0&&g<i&&f[g*c+a]&&(f[g*c+a]=0,F(a,g),m++)}let p=m*at;k+=p,Z(),j&&console.log('Nuke destroyed '+m+' blocks for '+p+' pts'),g.setColor(h),g.fillRect(a),av(),K=!1}function al(){if(!T.length)return;const a=T[Math.floor(Math.random()*T.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function aM(){f.fill(0),g.setColor(h),g.fillRect(n,o,n+c*b-1,o+i*b-1)}function aN(f){if(u||!a)return;B(!0);const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,A(a)){a.shape=c,B();return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&F(a.x+g,a.y+d);w(!1),B(),m(d)}function am(){Pip.removeAllListeners(I),Pip.removeAllListeners(J),Pip.removeAllListeners(P),Pip.removeAllListeners(ad)}function an(){let a={highScore:t};try{fs.writeFile(a5,JSON.stringify(a))}catch(a){console.log('Error saving high score:',a)}}function aO(){Pip.on(I,aF),Pip.on(J,aH),Pip.on(P,ai),Pip.on(ad,aE)}function a0(){Pip.removeAllListeners(I),Pip.removeAllListeners(J),Pip.on(I,aP),Pip.on(J,a2)}function a1(){s||(s=_()),a=s,s=_(),a7=s.shape.some(a=>a.includes(2)),W(),A(a)&&(u=!0,aw(),clearInterval(q),setTimeout(()=>{ag()},50))}function ao(){p&&(clearInterval(p),p=null),q&&(clearInterval(q),q=null),am(),al(),u=!1,a=null,j?(r=10,k=1e4):(r=0,k=0),G=r*aa,y=Math.max(R-r*a9,a8),S=y,s=_(!1),U(),aM(),ah(),Z(),m(d),a1(),W(),ax(),aO(),q=setInterval(aj,y)}function aP(){L=!L,X()}function a2(){C=!C,Y()}function aQ(){let a=Math.floor(G/aa);a>r&&(r=a,y=Math.max(R-r*a9,a8),console.log('Level up! New speed:',y,'ms'))}const a3={};const a4='PIPTRIS';const ap='2.5.0';const j=!1;const a5='USER/piptris.json';const aq='USER/gear.json';const ar='USER/nuke.json';const as='USER/radioactive.json';let Q=null;let x=null;let a6=null;const R=800;let a=null;let y=R;let s=null;let b=15;let S=y;let t=0;let p=null;let u=!1;let G=0;let q=null;let k=0;let C=!1;const at=10;const v=2;let K=!1;let a7=!1;let L=!1;let M=null;let r=0;const a8=100;const a9=50;const aa=10;const N=g.getWidth();const O=g.getHeight();const z={x1:60,x2:N-60,y1:10,y2:O-10};const h='#000000';const H='#FF0000';const ab=g.blendColor(h,H,.5);const e=g.theme.fg;const l=g.blendColor(h,e,.5);const c=10;const i=20;const f=new Uint8Array(c*i);const n=(z.x1+z.x2)/2-b*c/2;const o=z.y1+(z.y2-z.y1)/2-b*i/2;const d={x1:n-1,y1:o-1,x2:n+c*b,y2:o+i*b};const I='knob1';const J='knob2';const P='torch';const au=30;let ac=0;const ad='audioStopped';const T=['USER/piptris.wav'];const D=[[0,1,0],[1,1,1]];const ae=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],D,[[1,1],[1,1]],[[2]]];return a3.run=function(){bC.clear(),aJ(),aI(),aB(),a0(),Pip.on(P,ai),p=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(p),p=null,Pip.removeListener(I,a2),Pip.removeListener(J,a2),Pip.removeAllListeners(P),ao())},100),setWatch(()=>aG(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},a3}Piptris().run()