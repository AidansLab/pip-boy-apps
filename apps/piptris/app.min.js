function Piptris(){function ap(){for(let a=h-2;a>=0;a--)for(let c=0;c<b;c++)if(e[a*b+c]){let d=a;while(d+1<h&&!e[(d+1)*b+c])e[(d+1)*b+c]=e[d*b+c],e[d*b+c]=0,d++}}function aq(){k>q&&(q=k,ai())}function S(){g.setColor(i),g.fillRect(0,0,M,N)}function T(){let a=0;let c=0;const d=h;while(c++<d){let c=!1;for(let f=h-1;f>=0;f--){let d=!0;for(let g=0;g<b;g++)if(!e[f*b+g]){d=!1;break}if(d){for(let e=0;e<b;e++)B(e,f);for(let g=f;g>0;g--)for(let f=0;f<b;f++)e[g*b+f]=e[(g-1)*b+f];for(let f=0;f<b;f++)e[f]=0;a++,F++,aI(),c=!0;break}}if(!c)break}c>=d&&console.log('Clear line safeguard triggered!');switch(a){case 1:k+=100;break;case 2:k+=300;break;case 3:k+=500;break;case 4:k+=800;break}}function x(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let f=a.x+d,g=a.y+c;if(f<0||f>=b||g>=h||g>=0&&e[g*b+f])return!0}return!1}function a9(h,i,j){const k=j!==void 0?j:e[i*b+h];const a=o+h*c;const f=p+i*c;k===2?(g.setColor(an),g.drawImage(a2,a,f)):(g.setColor(d),z?g.drawRect(a,f,a+c-1,f+c-1):g.fillRect(a,f,a+c-1,f+c-1))}function l(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function s(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?B(a.x+d,a.y+c):a9(a.x+d,a.y+c,a.shape[c][d]))}function U(){g.setColor(d);for(let a=0;a<h;a++)for(let c=0;c<b;c++)e[a*b+c]?a9(c,a):B(c,a);y(),ac(),ab(),as(),at()}function ar(){const c=20;const a=f.x1-60;const b=f.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(a0,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+ak,a,b+c)}function aa(){S();const a=M/2;const b=N/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(j),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60),C&&(g.setColor(d),g.drawImage(C,a-45,b-75));const c=b-20;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+k,a,c),g.drawString('Level: '+n,a,c+e),g.drawString('Lines: '+F,a,c+e*2),g.setColor(j),g.drawString('High Score: '+q,a,c+e*3+10),W(),V(),Y(),D=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(D),aj())},100)}function y(d){if(!(K&&a)||r)return;let b=d&&L?L:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!x({x:b.x,y:b.y+1,shape:b.shape}))b.y++;L={x:b.x,y:b.y,shape:b.shape}}else if(!L)return;let e=d?i:j;g.setColor(e);for(let a=0;a<b.shape.length;a++)for(let f=0;f<b.shape[a].length;f++)if(b.shape[a][f]){const d=[o+(b.x+f)*c,p+(b.y+a)*c,o+(b.x+f+1)*c-1,p+(b.y+a+1)*c-1];z?g.drawRect(d[0],d[1],d[2],d[3]):g.fillRect(d[0],d[1],d[2],d[3])}}function V(){g.setFont('6x8',1);const e=w.y2-40;const a=180;const f=e-22;const h={ON:'ON',OFF:'OFF'};const z=K?h.ON:h.OFF;const q=8;const r=2;g.setFont('6x'+q,r);const s=g.stringWidth(h.OFF);const t=q*r;const u={x1:a-s/2,y1:f-t/2,x2:a+s/2,y2:f+t};g.setColor(i),g.fillRect(u),m&&l(u),g.setColor(d),g.drawString(z,a,f+4),g.setFont('6x8',1),g.setColor(j);const v='GHOST';const x=g.stringWidth(v);g.drawString(v,a,e);const b=5;const y=8;const k=a-x/2-y-1;const n=e;g.fillPoly([k,n-b,k-b,n+b,k+b,n+b]);const o=a+x/2+y;const p=e;const c=b-1;g.fillPoly([o,p+c,o-c,p-c,o+c,p-c])}function as(){const a=f.x1-65;const b=f.y2-60;const c=20;g.setFont('6x8',2);const p=F.toString();const q=16;const h=80;const r=c+q+10;const k=a-h/2;const e=b+c-8;const n=a+h/2;const o=e+r;g.setColor(i),g.fillRect(k,e,n,o),m&&l({x1:k-1,y1:e-1,x2:n+1,y2:o+1}),g.setColor(j),g.drawString('LINES',a,b),g.setColor(d),g.drawString(p,a,b+c)}function ab(){const a=f.x1-65;const c=f.y2-120;const h=20;g.setFont('6x8',2);const k=n.toString();const o=g.stringWidth(k);const s=16;const b=4;const p=a-o/2-b;const e=c+h-b*2;const q=a+o/2+b;const r=e+s+b;g.setColor(i),g.fillRect(p,e,q,r),m&&l({x1:p-1,y1:e-1,x2:q+1,y2:r+1}),g.setColor(j),g.drawString('LEVEL',a,c),g.setColor(d),g.drawString(k,a,c+h)}function at(){if(!u)return;const b=f.x2+65;const a=f.y1+25;const k=4*c;const e=6;const n=b-k/2-e;const o=a+15-e;const p=b+k/2+e;const q=a+15+k+e;g.setColor(i),g.fillRect(n,o,p,q),m&&l({x1:n-1,y1:o-1,x2:p+1,y2:q+1}),g.setFont('6x8',2),g.setColor(j),g.drawString('NEXT',b,a),g.setColor(d);const h=u.shape;const s=h[0].length*c;const r=b-s/2-2;for(let d=0;d<h.length;d++)for(let f=0;f<h[d].length;f++)if(h[d][f]){const b=[r+f*c,a+20+d*c,r+(f+1)*c-1,a+20+(d+1)*c-1];z?g.drawRect(b[0],b[1],b[2],b[3]):g.fillRect(b[0],b[1],b[2],b[3])}}function W(){const c=w.y2-40;const e=300;const b=10;const q=A.length*b;const r=A[0].length*b;const f=c-q-10;const h=e-r/2;g.setFont('6x8',1),g.setColor(j);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,e,c);const a=6;const u=10;const k=e-t/2-u;const n=c;g.fillPoly([k,n,k+a,n-a,k+a,n+a]);const o=e+t/2+u;const p=c;g.fillPoly([o,p,o-a,p-a,o-a,p+a]);const v={x1:h-2,y1:f-2,x2:h+r+2,y2:f+q+2};g.setColor(i),g.fillRect(v),m&&l(v),g.setColor(d);for(let d=0;d<A.length;d++)for(let i=0;i<A[d].length;i++)if(A[d][i]){const a=h+i*b;const c=f+d*b;const e=a+b-1;const j=c+b-1;z?g.drawRect(a,c,e,j):g.fillRect(a,c,e,j)}}function ac(){const a=f.x2+65;const b=f.y2-60;const c=20;g.setFont('6x8',2);const h=k.toString();const t=g.stringWidth(h);const r=16;const n=100;const s=c+r+10;const o=a-n/2;const e=b+c-8;const p=a+n/2;const q=e+s;g.setColor(i),g.fillRect(o,e,p,q),m&&l({x1:o-1,y1:e-1,x2:p+1,y2:q+1}),g.setColor(j),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(h,a,b+c)}function au(){S();const a=M/2;const b=N/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(a0,a,b-50),g.setColor(j),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15),C&&(g.setColor(d),g.drawImage(C,a-34,b-29)),q>0&&(g.setColor(j),g.setFont('6x8',2),g.drawString('High Score: '+q,a,b+35)),W(),V(),Y()}function ad(){if(!a||r)return;if(s(!0),a.y++,x(a)&&(a.y--,s(!1),af(a),T(),Z(),x(a))){r=!0,clearInterval(v),setTimeout(aa,50);return}s(!1),l(f);const c=BTN_PLAY.read();const b=c?100:t;Q!==b&&(clearInterval(v),v=setInterval(ad,b),Q=b)}function av(){if(!a||r)return;s(!0);while(!x(a))a.y++;a.y--,s(!1),af(a),T(),U(),Z(),s(!1)}function B(a,b){g.setColor(i),g.fillRect(o+a*c,p+b*c,o+(a+1)*c-1,p+(b+1)*c-1)}function X(){let c=Math.floor(Math.random()*a8.length);let a=a8[c];let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function aw(){ag()}function ax(b){let a=Date.now();if(a-a6<ao)return;a6=a,b===0?av():aF(b)}function ay(){ah(),clearInterval(v),bC.clear(1).flip(),E.reboot()}function az(a){aC(a>0?1:-1)}function ae(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aA(){try{let a=fs.readFileSync(a1);let b=JSON.parse(a);q=b.highScore||0}catch(a){console.log('No piptris.json, using default high score.'),q=0,ai()}}function aB(){try{let b=fs.readFileSync(am);let a=JSON.parse(b);a2={bpp:a.bpp,buffer:atob(a.buffer),height:a.height,width:a.width,transparent:a.transparent}}catch(a){console.log('Failed to load nuke image:',a)}try{let b=fs.readFileSync(al);let a=JSON.parse(b);C={bpp:a.bpp,buffer:atob(a.buffer),height:a.height,width:a.width,transparent:a.transparent}}catch(a){console.log('Failed to load gear image:',a)}}function af(a){let c=!1;for(let d=0;d<a.shape.length;d++)for(let f=0;f<a.shape[d].length;f++)if(a.shape[d][f]){const g=a.x+f;const i=a.y+d;if(!(isFinite(g)&&isFinite(i))){console.log('Invalid fx/fy',g,i);continue}a.shape[d][f]===2?(m&&console.log('Nuking coords: ',g,i),g>=0&&g<b&&i>=0&&i<h?(e[i*b+g]=0,aD(g,i),c=!0):m&&console.log('Nuke is out of bounds!',g,i)):e[i*b+g]=1}c&&T()}function aC(c){if(r||!a)return;y(!0);let b=a.x;if(a.x+=c,x(a)){a.x=b,y();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&B(b+e,a.y+d);y(),s(!1),l(f)}function aD(a,c){if(J){console.log('Nuke is still nuking...');return}if(J=!0,!(isFinite(a)&&isFinite(c))){console.log('We were sent incorrect nuke coordinates!'),J=!1;return}a=Math.max(0,Math.min(a,b-1)),c=Math.max(0,Math.min(c,h-1));for(let d=-I;d<=I;d++)for(let f=-I;f<=I;f++){let g=a+f;let i=c+d;g>=0&&g<b&&i>=0&&i<h&&(e[i*b+g]=0,B(g,i))}ap(),J=!1}function ag(){if(!R.length)return;const a=R[Math.floor(Math.random()*R.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function aE(){e.fill(0),g.setColor(i),g.fillRect(o,p,o+b*c-1,p+h*c-1)}function aF(e){if(r||!a)return;y(!0);const b=a.shape;const d=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,x(a)){a.shape=c,y();return}for(let f=0;f<c.length;f++)for(let g=0;g<c[f].length;g++)c[f][g]&&B(a.x+g,a.y+f);s(!1),y(),l(f)}function ah(){Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.removeAllListeners(O),Pip.removeAllListeners(a7)}function ai(){let a={highScore:q};try{fs.writeFile(a1,JSON.stringify(a))}catch(a){console.log('Error saving high score:',a)}}function aG(){Pip.on(G,ax),Pip.on(H,az),Pip.on(O,ae),Pip.on(a7,aw)}function Y(){Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.on(G,aH),Pip.on(H,_)}function Z(){u||(u=X()),a=u,u=X(),U(),x(a)&&(r=!0,aq(),clearInterval(v),setTimeout(()=>{aa()},50))}function aj(){clearInterval(D),clearInterval(v),ah(),ag(),r=!1,a=null,m?(n=10,k=1e4):(n=0,k=0),F=n*a5,t=Math.max(P-n*a4,a3),Q=t,u=X(),S(),aE(),ab(),ac(),l(f),Z(),U(),ar(),aG(),v=setInterval(ad,t)}function aH(){K=!K,V()}function _(){z=!z,W()}function aI(){let a=Math.floor(F/a5);a>n&&(n=a,t=Math.max(P-n*a4,a3),console.log('Level up! New speed:',t,'ms'))}const $={};const a0='PIPTRIS';const ak='2.6.0';const m=!1;const a1='USER/piptris.json';const al='USER/gear.json';const am='USER/nuke.json';let C=null;let a2=null;const P=800;let a=null;let t=P;let u=null;let c=15;let Q=t;let q=0;let D=null;let r=!1;let F=0;let v=null;let k=0;let z=!1;const I=2;let J=!1;let K=!1;let L=null;let n=0;const a3=100;const a4=50;const a5=10;const M=g.getWidth();const N=g.getHeight();const w={x1:60,x2:M-60,y1:10,y2:N-10};const i='#000000';const an='#FF0000';const d=g.theme.fg;const j=g.blendColor(i,d,.5);const b=10;const h=20;const e=new Uint8Array(b*h);const o=(w.x1+w.x2)/2-c*b/2;const p=w.y1+(w.y2-w.y1)/2-c*h/2;const f={x1:o-1,y1:p-1,x2:o+b*c,y2:p+h*c};const G='knob1';const H='knob2';const O='torch';const ao=30;let a6=0;const a7='audioStopped';const R=['USER/piptris.wav'];const A=[[0,1,0],[1,1,1]];const a8=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],A,[[1,1],[1,1]],[[2]]];return $.run=function(){bC.clear(),aA(),aB(),au(),Y(),Pip.on(O,ae),D=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(D),Pip.removeListener(G,_),Pip.removeListener(H,_),Pip.removeAllListeners(O),aj())},100),setWatch(()=>ay(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},$}Piptris().run()