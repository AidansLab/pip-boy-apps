function Piptris(){function ao(){for(let a=h-2;a>=0;a--)for(let c=0;c<b;c++)if(e[a*b+c]){let d=a;while(d+1<h&&!e[(d+1)*b+c])e[(d+1)*b+c]=e[d*b+c],e[d*b+c]=0,d++}}function ap(){j>t&&(t=j,ah())}function P(){g.setColor(i),g.fillRect(0,0,C,J)}function Q(){let a=0;let c=0;const d=h;while(c++<d){let c=!1;for(let f=h-1;f>=0;f--){let d=!0;for(let g=0;g<b;g++)if(!e[f*b+g]){d=!1;break}if(d){for(let e=0;e<b;e++)z(e,f);for(let g=f;g>0;g--)for(let f=0;f<b;f++)e[g*b+f]=e[(g-1)*b+f];for(let f=0;f<b;f++)e[f]=0;a++,A++,aH(),c=!0;break}}if(!c)break}switch(a){case 1:j+=100;break;case 2:j+=300;break;case 3:j+=500;break;case 4:j+=800;break}}function y(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let f=a.x+d,g=a.y+c;if(f<0||f>=b||g>=h||g>=0&&e[g*b+f])return!0}return!1}function aa(h,i,j){const k=j!==void 0?j:e[i*b+h];const a=n+h*c;const d=o+i*c;if(k===2)try{g.setColor(D),g.drawImage(H(a1),a,d)}catch(a){console.log(a)}else g.setColor(f),B?g.drawRect(a,d,a+c-1,d+c-1):g.fillRect(a,d,a+c-1,d+c-1)}function M(a){g.setColor(f),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function s(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?z(a.x+d,a.y+c):aa(a.x+d,a.y+c,a.shape[c][d]))}function R(){g.setColor(f);for(let a=0;a<h;a++)for(let c=0;c<b;c++)e[a*b+c]?aa(c,a):z(c,a);T(),ac(),as(),at(),ar()}function aq(){const c=20;const a=d.x1-60;const b=d.y1+35;g.setColor(f),g.setFontMonofonto28(),g.drawString(_,a,b),g.setColor(f),g.setFont('6x8',1),g.drawString('v'+aj,a,b+c)}function ab(){P();const a=C/2;const b=J/2;g.clear(),g.setColor(f),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(m),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60);try{g.setColor(f),g.drawImage(H(a0),a-45,b-75)}catch(a){console.log(a)}const c=b-20;const d=18;g.setColor(f),g.setFont('6x8'),g.drawString('Score: '+j,a,c),g.drawString('Level: '+r,a,c+d),g.drawString('Lines: '+A,a,c+d*2),g.setColor(m),g.drawString('High Score: '+t,a,c+d*3+10),S(),W(),k=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(k),k=null,ai())},100)}function ar(){const a=d.x2+65;const b=d.y1+100;const c=18;if(!a2){const d=100;const e=c*2+50+10;const f={x1:a-d/2-5,y1:b-10,x2:a+d/2,y2:b+e};g.setColor(i),g.fillRect(f);return}g.setFont('6x8',2),g.setColor(D),g.drawString('INCOMING',a,b),g.drawString('NUKE!',a,b+c);try{const d=50;const e=a-d/2;const f=b+c*2+5;g.setColor(am),g.drawImage(H(ak),e,f)}catch(a){console.log(a)}}function as(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const j=A.toString();const k=16;const e=80;const l=c+k+10;const n=a-e/2;const h=b+c-8;const o=a+e/2;const p=h+l;g.setColor(i),g.fillRect(n,h,o,p),g.setColor(m),g.drawString('LINES',a,b),g.setColor(f),g.drawString(j,a,b+c)}function ac(){const a=d.x1-65;const c=d.y2-120;const e=20;g.setFont('6x8',2);const h=r.toString();const j=g.stringWidth(h);const l=16;const b=4;const n=a-j/2-b;const k=c+e-b*2;const o=a+j/2+b;const p=k+l+b;g.setColor(i),g.fillRect(n,k,o,p),g.setColor(m),g.drawString('LEVEL',a,c),g.setColor(f),g.drawString(h,a,c+e)}function at(){if(!p)return;const b=d.x2+65;const e=d.y1+25;const j=4*c;const h=6;const k=b-j/2-h;const l=e+15-h;const n=b+j/2+h;const o=e+15+j+h;g.setColor(i),g.fillRect(k,l,n,o),g.setFont('6x8',2),g.setColor(m),g.drawString('NEXT',b,e);const a=p.shape;const q=a[0].length*c;const r=b-q/2-2;for(let d=0;d<a.length;d++)for(let i=0;i<a[d].length;i++)if(a[d][i]){const j=a[d][i];const b=r+i*c;const h=e+20+d*c;if(j===2)try{const a=H(a1);g.setColor(D),g.drawImage(a,b,h,{scale:c/a.width})}catch(a){console.log(a)}else g.setColor(f),B?g.drawRect(b,h,b+c-1,h+c-1):g.fillRect(b,h,b+c-1,h+c-1)}}function S(){const c=w.y2-40;const d=C/2;const b=10;const o=x.length*b;const p=x[0].length*b;const e=c-o-10;const h=d-p/2;g.setFont('6x8',1),g.setColor(m);const q='TYPE';const r=g.stringWidth(q);g.drawString(q,d,c);const a=6;const s=10;const j=d-r/2-s;const k=c;g.fillPoly([j,k,j+a,k-a,j+a,k+a]);const l=d+r/2+s;const n=c;g.fillPoly([l,n,l-a,n-a,l-a,n+a]);const t={x1:h-2,y1:e-2,x2:h+p+2,y2:e+o+2};g.setColor(i),g.fillRect(t),g.setColor(f);for(let f=0;f<x.length;f++)for(let i=0;i<x[f].length;i++)if(x[f][i]){const a=h+i*b;const c=e+f*b;const d=a+b-1;const j=c+b-1;B?g.drawRect(a,c,d,j):g.fillRect(a,c,d,j)}}function T(){const a=d.x2+65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const e=j.toString();const r=g.stringWidth(e);const l=16;const h=100;const n=c+l+10;const o=a-h/2;const k=b+c-8;const p=a+h/2;const q=k+n;g.setColor(i),g.fillRect(o,k,p,q),g.setColor(m),g.drawString('SCORE',a,b),g.setColor(f),g.drawString(e,a,b+c)}function au(){P();const a=C/2;const b=J/2;g.clear(),g.setColor(f),g.setFontMonofonto36(),g.drawString(_,a,b-50),g.setColor(m),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15);try{g.setColor(f),g.drawImage(H(a0),a-34,b-29)}catch(a){console.log(a)}g.setColor(m),g.setFont('6x8'),g.drawString('High Score: '+t,a,b+35),S(),W()}function av(){if(!a||u)return;if(s(!0),a.y++,y(a)&&(a.y--,s(!1),af(a),Q(),X(),y(a))){u=!0,clearInterval(l),setTimeout(ab,50);return}s(!1),M(d);const c=BTN_PLAY.read();const b=c?100:v;O!==b&&(clearInterval(l),l=setInterval(ae,b),O=b)}function aw(){if(!a||u)return;s(!0);while(!y(a))a.y++;a.y--,s(!1),af(a),Q(),R(),X(),s(!1)}function z(a,b){g.setColor(i),g.fillRect(n+a*c,o+b*c,n+(a+1)*c-1,o+(b+1)*c-1)}function U(c){c===void 0&&(c=!0);let a;while(!0){let b=Math.floor(Math.random()*a9.length);if(a=a9[b],!(!c&&a[0][0]===2))break}let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function ax(){V()}function ay(b){let a=Date.now();if(a-a6<an)return;a6=a,b===0?aw():aF(b)}function az(){ag(),clearInterval(l),bC.clear(1).flip(),E.reboot()}function aA(a){aC(a>0?1:-1)}function ad(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aB(){try{let a=fs.readFile($);if(!a)throw new Error('Config file missing');let b=JSON.parse(a);t=b.highScore||0,G=b.music||[]}catch(a){console.log(a),t=0,ah()}}function H(a){try{let c=fs.readFile(a);let b=JSON.parse(c);return{bpp:b.bpp,buffer:atob(b.buffer),height:b.height,transparent:b.transparent,width:b.width}}catch(b){return console.log(a,b),null}}function ae(){av()}function af(a){let c=!1;for(let d=0;d<a.shape.length;d++)for(let f=0;f<a.shape[d].length;f++)if(a.shape[d][f]){const g=a.x+f;const i=a.y+d;if(!(isFinite(g)&&isFinite(i)))continue;a.shape[d][f]===2?g>=0&&g<b&&i>=0&&i<h&&(e[i*b+g]=0,aD(g,i),c=!0):e[i*b+g]=1}c&&Q()}function aC(c){if(u||!a)return;let b=a.x;if(a.x+=c,y(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&z(b+e,a.y+d);s(!1),M(d)}function aD(f,k){if(I)return;if(I=!0,!(isFinite(f)&&isFinite(k))){I=!1;return}f=Math.max(0,Math.min(f,b-1)),k=Math.max(0,Math.min(k,h-1));let a={x1:n+(f-q)*c+1,y1:o+(k-q)*c+1,x2:n+(f+q+1)*c-2,y2:o+(k+q+1)*c-2};a.x1=Math.max(a.x1,d.x1+1),a.y1=Math.max(a.y1,d.y1+1),a.x2=Math.min(a.x2,d.x2-1),a.y2=Math.min(a.y2,d.y2-1),g.setColor(D),g.drawRect(a);let l=0;for(let c=-q;c<=q;c++)for(let d=-q;d<=q;d++){let a=f+d;let g=k+c;a>=0&&a<b&&g>=0&&g<h&&e[g*b+a]&&(e[g*b+a]=0,z(a,g),l++)}let m=l*al;j+=m,T(),g.setColor(i),g.fillRect(a),ao(),I=!1}function V(){if(!G.length){console.log('No music tracks available');return}const a=G[Math.floor(Math.random()*G.length)];if(a===a8)return V();Pip.audioStop(),Pip.audioStart(a),a8=a}function aE(){e.fill(0),g.setColor(i),g.fillRect(n,o,n+b*c-1,o+h*c-1)}function aF(f){if(u||!a)return;const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,y(a)){a.shape=c;return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&z(a.x+g,a.y+d);s(!1),M(d)}function ag(){Pip.removeAllListeners(K),Pip.removeAllListeners(F),Pip.removeAllListeners(L),Pip.removeAllListeners(a7)}function ah(){let a={highScore:t,music:G};try{fs.writeFile($,JSON.stringify(a))}catch(a){console.log(a)}}function aG(){Pip.on(K,ay),Pip.on(F,aA),Pip.on(L,ad),Pip.on(a7,ax)}function W(){Pip.removeAllListeners(K),Pip.removeAllListeners(F),Pip.on(F,Y)}function X(){p||(p=U()),a=p,p=U(),a2=p.shape.some(a=>a.includes(2)),R(),y(a)&&(u=!0,ap(),clearInterval(l),setTimeout(()=>{ab()},50))}function ai(){k&&(clearInterval(k),k=null),l&&(clearInterval(l),l=null),ag(),V(),u=!1,a=null,r=0,j=0,A=r*a5,v=Math.max(N-r*a4,a3),O=v,p=U(!1),P(),aE(),ac(),T(),M(d),X(),R(),aq(),aG(),l=setInterval(ae,v)}function Y(){B=!B,S()}function aH(){let a=Math.floor(A/a5);a>r&&(r=a,v=Math.max(N-r*a4,a3))}const Z={};const _='PIPTRIS';const aj='2.6.0';const $='USER/PIPTRIS/piptris.json';const a0='USER/PIPTRIS/gear.json';const a1='USER/PIPTRIS/nuke.json';const ak='USER/PIPTRIS/radioactive.json';const N=800;let a=null;let v=N;let p=null;let c=15;let O=v;let t=0;let k=null;let u=!1;let A=0;let l=null;let j=0;let B=!1;const al=10;const q=2;let I=!1;let a2=!1;let r=0;const a3=100;const a4=50;const a5=10;const C=g.getWidth();const J=g.getHeight();const w={x1:60,x2:C-60,y1:10,y2:J-10};const i='#000000';const D='#FF0000';const am=g.blendColor(i,D,.5);const f=g.theme.fg;const m=g.blendColor(i,f,.5);const b=10;const h=20;const e=new Uint8Array(b*h);const n=(w.x1+w.x2)/2-c*b/2;const o=w.y1+(w.y2-w.y1)/2-c*h/2;const d={x1:n-1,y1:o-1,x2:n+b*c,y2:o+h*c};const K='knob1';const F='knob2';const L='torch';const an=30;let a6=0;const a7='audioStopped';let G=[];let a8=null;const x=[[0,1,0],[1,1,1]];const a9=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],x,[[1,1],[1,1]],[[2]]];return Z.run=function(){bC.clear(),aB(),au(),W(),Pip.on(L,ad),k=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(k),k=null,Pip.removeListener(K,Y),Pip.removeListener(F,Y),Pip.removeAllListeners(L),ai())},100),setWatch(()=>az(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},Z}Piptris().run()