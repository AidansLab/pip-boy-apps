function Piptris(){function ak(){i>o&&(o=i,ag())}function P(){g.setColor(f),g.fillRect(0,0,I,J)}function a5(){let a=0;for(let b=w-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!p[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)F(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)p[d*c+b]=p[(d-1)*c+b];for(let b=0;b<c;b++)p[b]=0;a++,B++,b++,aA()}}switch(a){case 1:i+=100;break;case 2:i+=300;break;case 3:i+=500;break;case 4:i+=800;break}}function x(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=w||f>=0&&p[f*c+e])return!0}return!1}function a6(c,e){g.setColor(d);const a=[j+c*b,k+e*b,j+(c+1)*b-1,k+(e+1)*b-1];z?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function l(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function q(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?F(a.x+d,a.y+c):a6(a.x+d,a.y+c))}function Q(){g.setColor(d);for(let a=0;a<w;a++)for(let b=0;b<c;b++)p[a*c+b]?a6(b,a):F(b,a);y(),aa(),a9(),am(),an()}function al(){const c=20;const a=e.x1-60;const b=e.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(Y,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+ai,a,b+c)}function a7(){P();const a=I/2;const b=J/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(h),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60),a8(a3,a-45,b-75);const c=b-20;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+i,a,c),g.drawString('Level: '+m,a,c+e),g.drawString('Lines: '+B,a,c+e*2),g.setColor(h),g.drawString('High Score: '+o,a,c+e*3+10),S(),R(),U(),G=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(G),ah())},100)}function y(d){if(!(H&&a)||n)return;let c=d&&N?N:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!x({x:c.x,y:c.y+1,shape:c.shape}))c.y++;N={x:c.x,y:c.y,shape:c.shape}}let e=d?f:h;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const d=[j+(c.x+f)*b,k+(c.y+a)*b,j+(c.x+f+1)*b-1,k+(c.y+a+1)*b-1];z?g.drawRect(d[0],d[1],d[2],d[3]):g.fillRect(d[0],d[1],d[2],d[3])}}function R(){g.setFont('6x8',1);const e=v.y2-40;const a=180;const i=e-22;const j={ON:'ON',OFF:'OFF'};const z=H?j.ON:j.OFF;const p=8;const q=2;g.setFont('6x'+p,q);const s=g.stringWidth(j.OFF);const t=p*q;const u={x1:a-s/2,y1:i-t/2,x2:a+s/2,y2:i+t};g.setColor(f),g.fillRect(u),r&&l(u),g.setColor(d),g.drawString(z,a,i+4),g.setFont('6x8',1),g.setColor(h);const w='GHOST';const x=g.stringWidth(w);g.drawString(w,a,e);const b=5;const y=8;const k=a-x/2-y-1;const m=e;g.fillPoly([k,m-b,k-b,m+b,k+b,m+b]);const n=a+x/2+y;const o=e;const c=b-1;g.fillPoly([n,o+c,n-c,o-c,n+c,o-c])}function a8(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function am(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const o=B.toString();const p=16;const j=80;const q=c+p+10;const k=a-j/2;const i=b+c-8;const m=a+j/2;const n=i+q;g.setColor(f),g.fillRect(k,i,m,n),r&&l({x1:k-1,y1:i-1,x2:m+1,y2:n+1}),g.setColor(h),g.drawString('LINES',a,b),g.setColor(d),g.drawString(o,a,b+c)}function a9(){const a=e.x1-65;const c=e.y2-120;const j=20;g.setFont('6x8',2);const k=m.toString();const n=g.stringWidth(k);const s=16;const b=4;const o=a-n/2-b;const i=c+j-b*2;const p=a+n/2+b;const q=i+s+b;g.setColor(f),g.fillRect(o,i,p,q),r&&l({x1:o-1,y1:i-1,x2:p+1,y2:q+1}),g.setColor(h),g.drawString('LEVEL',a,c),g.setColor(d),g.drawString(k,a,c+j)}function an(){if(!t)return;const c=e.x2+65;const a=e.y1+25;const k=4*b;const i=6;const m=c-k/2-i;const n=a+15-i;const o=c+k/2+i;const p=a+15+k+i;g.setColor(f),g.fillRect(m,n,o,p),r&&l({x1:m-1,y1:n-1,x2:o+1,y2:p+1}),g.setFont('6x8',2),g.setColor(h),g.drawString('NEXT',c,a),g.setColor(d);const j=t.shape;const s=j[0].length*b;const q=c-s/2-2;for(let d=0;d<j.length;d++)for(let e=0;e<j[d].length;e++)if(j[d][e]){const c=[q+e*b,a+20+d*b,q+(e+1)*b-1,a+20+(d+1)*b-1];z?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function S(){const c=v.y2-40;const e=300;const b=10;const p=A.length*b;const q=A[0].length*b;const i=c-p-10;const j=e-q/2;g.setFont('6x8',1),g.setColor(h);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,e,c);const a=6;const u=10;const k=e-t/2-u;const m=c;g.fillPoly([k,m,k+a,m-a,k+a,m+a]);const n=e+t/2+u;const o=c;g.fillPoly([n,o,n-a,o-a,n-a,o+a]);const w={x1:j-2,y1:i-2,x2:j+q+2,y2:i+p+2};g.setColor(f),g.fillRect(w),r&&l(w),g.setColor(d);for(let d=0;d<A.length;d++)for(let f=0;f<A[d].length;f++)if(A[d][f]){const a=j+f*b;const c=i+d*b;const e=a+b-1;const h=c+b-1;z?g.drawRect(a,c,e,h):g.fillRect(a,c,e,h)}}function aa(){const a=e.x2+65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const k=i.toString();const t=g.stringWidth(k);const q=16;const m=100;const s=c+q+10;const n=a-m/2;const j=b+c-8;const o=a+m/2;const p=j+s;g.setColor(f),g.fillRect(n,j,o,p),r&&l({x1:n-1,y1:j-1,x2:o+1,y2:p+1}),g.setColor(h),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(k,a,b+c)}function ao(){P();const a=I/2;const b=J/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(Y,a,b-50),g.setColor(h),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15),a8(a3,a-34,b-29),o>0&&(g.setColor(h),g.setFont('6x8',2),g.drawString('High Score: '+o,a,b+35)),S(),R(),U()}function ab(){if(!a||n)return;if(q(!0),a.y++,x(a)&&(a.y--,q(!1),ad(a),a5(),V(),x(a))){n=!0,clearInterval(u),setTimeout(a7,50);return}q(!1),l(e);const c=BTN_PLAY.read();const b=c?100:s;M!==b&&(clearInterval(u),u=setInterval(ab,b),M=b)}function ap(){if(!a||n)return;q(!0);while(!x(a))a.y++;a.y--,q(!1),ad(a),a5(),Q(),V(),q(!1)}function F(a,c){g.setColor(f),g.fillRect(j+a*b,k+c*b,j+(a+1)*b-1,k+(c+1)*b-1)}function T(){let b=Math.floor(Math.random()*a4.length);let a=a4[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function aq(){ae()}function ar(b){let a=Date.now();if(a-a1<aj)return;a1=a,b===0?ap():ax(b)}function as(){af(),clearInterval(u),bC.clear(1).flip(),E.reboot()}function at(a){av(a>0?1:-1)}function ac(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function au(){try{let a=fs.readFileSync(Z);let b=JSON.parse(a);o=b.highScore||0}catch(a){console.log('No piptris.json, using default high score.'),o=0,ag()}}function ad(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(p[(a.y+b)*c+a.x+d]=1)}function av(c){if(n||!a)return;y(!0);let b=a.x;if(a.x+=c,x(a)){a.x=b,y();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&F(b+e,a.y+d);y(),q(!1),l(e)}function ae(){if(!O.length)return;const a=O[Math.floor(Math.random()*O.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function aw(){p.fill(0),g.setColor(f),g.fillRect(j,k,j+c*b-1,k+w*b-1)}function ax(f){if(n||!a)return;y(!0);const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,x(a)){a.shape=c,y();return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&F(a.x+g,a.y+e);q(!1),y(),l(e)}function af(){Pip.removeAllListeners(C),Pip.removeAllListeners(D),Pip.removeAllListeners(K),Pip.removeAllListeners(a2)}function ag(){let a={highScore:o};try{fs.writeFile(Z,JSON.stringify(a))}catch(a){console.log('Error saving high score:',a)}}function ay(){Pip.on(C,ar),Pip.on(D,at),Pip.on(K,ac),Pip.on(a2,aq)}function U(){Pip.removeAllListeners(C),Pip.removeAllListeners(D),Pip.on(C,az),Pip.on(D,W)}function V(){t||(t=T()),a=t,t=T(),Q(),x(a)&&(n=!0,ak(),clearInterval(u),setTimeout(()=>{a7()},50))}function ah(){clearInterval(u),af(),ae(),n=!1,a=null,r?(m=10,i=1e4):(m=0,i=0),B=m*a0,s=Math.max(L-m*$,_),M=s,t=T(),P(),aw(),a9(),aa(),l(e),V(),Q(),al(),ay(),u=setInterval(ab,s)}function az(){H=!H,R()}function W(){z=!z,S()}function aA(){let a=Math.floor(B/a0);a>m&&(m=a,s=Math.max(L-m*$,_),console.log('Level up! New speed:',s,'ms'))}const X={};const Y='PIPTRIS';const ai='2.4.0';const r=!1;const Z='USER/piptris.json';const L=800;let a=null;let s=L;let t=null;let b=15;let M=s;let G=null;let n=!1;let B=0;let u=null;let i=0;let o=0;let z=!1;let H=!1;let N=null;let m=0;const _=100;const $=50;const a0=10;const I=g.getWidth();const J=g.getHeight();const v={x1:60,x2:I-60,y1:10,y2:J-10};const f='#000';const d=g.theme.fg;const h=g.blendColor(f,d,.5);const c=10;const w=20;const p=new Uint8Array(c*w);const j=(v.x1+v.x2)/2-b*c/2;const k=v.y1+(v.y2-v.y1)/2-b*w/2;const e={x1:j-1,y1:k-1,x2:j+c*b,y2:k+w*b};const C='knob1';const D='knob2';const K='torch';const aj=30;let a1=0;const a2='audioStopped';const O=['USER/piptris.wav'];const a3='USER/gear.json';const A=[[0,1,0],[1,1,1]];const a4=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],A,[[1,1],[1,1]]];return X.run=function(){bC.clear(),au(),ao(),U(),Pip.on(K,ac),G=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(G),Pip.removeListener(C,W),Pip.removeListener(D,W),Pip.removeAllListeners(K),ah())},100),setWatch(()=>as(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},X}Piptris().run()