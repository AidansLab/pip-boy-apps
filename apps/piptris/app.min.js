function Piptris(){function au(){for(let a=i-2;a>=0;a--)for(let b=0;b<c;b++)if(e[a*c+b]){let d=a;while(d+1<i&&!e[(d+1)*c+b])e[(d+1)*c+b]=e[d*c+b],e[d*c+b]=0,d++}}function av(){m>p&&(p=m,an())}function U(){g.setColor(h),g.fillRect(0,0,M,N)}function V(){let a=0;let b=0;const d=i;while(b++<d){let b=!1;for(let f=i-1;f>=0;f--){let d=!0;for(let g=0;g<c;g++)if(!e[f*c+g]){d=!1;break}if(d){for(let e=0;e<c;e++)C(e,f);for(let g=f;g>0;g--)for(let f=0;f<c;f++)e[g*c+f]=e[(g-1)*c+f];for(let f=0;f<c;f++)e[f]=0;a++,F++,aP(),b=!0;break}}if(!b)break}b>=d&&console.log('Clear line safeguard triggered!');switch(a){case 1:m+=100;break;case 2:m+=300;break;case 3:m+=500;break;case 4:m+=800;break}}function y(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let f=a.x+d,g=a.y+b;if(f<0||f>=c||g>=i||g>=0&&e[g*c+f])return!0}return!1}function ae(h,i,j){const k=j!==void 0?j:e[i*c+h];const a=r+h*b;const f=s+i*b;if(k===2)try{g.setColor(O),g.drawImage(u,a,f)}catch(a){console.log('Failed to load nuke image:',a)}else g.setColor(d),A?g.drawRect(a,f,a+b-1,f+b-1):g.fillRect(a,f,a+b-1,f+b-1)}function l(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function t(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?C(a.x+d,a.y+c):ae(a.x+d,a.y+c,a.shape[c][d]))}function W(){g.setColor(d);for(let a=0;a<i;a++)for(let b=0;b<c;b++)e[a*c+b]?ae(b,a):C(b,a);z(),ah(),ag(),ay(),az(),ax()}function aw(){const c=20;const a=f.x1-60;const b=f.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(a3,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+ap,a,b+c)}function af(){U();const a=M/2;const b=N/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(k),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60);try{g.setColor(d),g.drawImage(Q,a-45,b-75)}catch(a){console.log('Failed to load gear image:',a)}const c=b-20;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+m,a,c),g.drawString('Level: '+n,a,c+e),g.drawString('Lines: '+F,a,c+e*2),g.setColor(k),g.drawString('High Score: '+p,a,c+e*3+10),Y(),X(),$(),D=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(D),ao())},100)}function z(d){if(!(K&&a)||q)return;let c=d&&L?L:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!y({x:c.x,y:c.y+1,shape:c.shape}))c.y++;L={x:c.x,y:c.y,shape:c.shape}}else if(!L)return;let e=d?h:k;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const i=c.shape[a][f];const e=r+(c.x+f)*b;const h=s+(c.y+a)*b;if(!d&&i===2)try{g.setColor(aa),g.drawImage(u,e,h,{scale:b/u.width,transparency:.5})}catch(a){console.log('Failed to load nuke ghost image:',a)}else A?g.drawRect(e,h,e+b-1,h+b-1):g.fillRect(e,h,e+b-1,h+b-1)}}function X(){g.setFont('6x8',1);const e=x.y2-40;const a=180;const f=e-22;const i={ON:'ON',OFF:'OFF'};const z=K?i.ON:i.OFF;const q=8;const r=2;g.setFont('6x'+q,r);const s=g.stringWidth(i.OFF);const t=q*r;const u={x1:a-s/2,y1:f-t/2,x2:a+s/2,y2:f+t};g.setColor(h),g.fillRect(u),j&&l(u),g.setColor(d),g.drawString(z,a,f+4),g.setFont('6x8',1),g.setColor(k);const v='GHOST';const w=g.stringWidth(v);g.drawString(v,a,e);const b=5;const y=8;const m=a-w/2-y-1;const n=e;g.fillPoly([m,n-b,m-b,n+b,m+b,n+b]);const o=a+w/2+y;const p=e;const c=b-1;g.fillPoly([o,p+c,o-c,p-c,o+c,p-c])}function ax(){const a=f.x2+65;const b=f.y1+130;const c=18;if(!a6){const e=100;const f=c*2+50+10;const d={x1:a-e/2-5,y1:b-10,x2:a+e/2,y2:b+f};j&&l({x1:d.x1-1,y1:d.y1-1,x2:d.x2+1,y2:d.y2+1}),g.setColor(h),g.fillRect(d);return}g.setFont('6x8',2),g.setColor(O),g.drawString('INCOMING',a,b),g.drawString('NUKE!',a,b+c);try{const d=50;const e=a-d/2;const f=b+c*2+5;g.setColor(aa),g.drawImage(a5,e,f)}catch(a){console.log('Failed to load radioactive image:',a)}}function ay(){const a=f.x1-65;const b=f.y2-60;const c=20;g.setFont('6x8',2);const p=F.toString();const q=16;const i=80;const r=c+q+10;const m=a-i/2;const e=b+c-8;const n=a+i/2;const o=e+r;g.setColor(h),g.fillRect(m,e,n,o),j&&l({x1:m-1,y1:e-1,x2:n+1,y2:o+1}),g.setColor(k),g.drawString('LINES',a,b),g.setColor(d),g.drawString(p,a,b+c)}function ag(){const a=f.x1-65;const c=f.y2-120;const i=20;g.setFont('6x8',2);const m=n.toString();const o=g.stringWidth(m);const s=16;const b=4;const p=a-o/2-b;const e=c+i-b*2;const q=a+o/2+b;const r=e+s+b;g.setColor(h),g.fillRect(p,e,q,r),j&&l({x1:p-1,y1:e-1,x2:q+1,y2:r+1}),g.setColor(k),g.drawString('LEVEL',a,c),g.setColor(d),g.drawString(m,a,c+i)}function az(){if(!o)return;const c=f.x2+65;const e=f.y1+25;const m=4*b;const i=6;const n=c-m/2-i;const p=e+15-i;const q=c+m/2+i;const r=e+15+m+i;g.setColor(h),g.fillRect(n,p,q,r),j&&l({x1:n-1,y1:p-1,x2:q+1,y2:r+1}),g.setFont('6x8',2),g.setColor(k),g.drawString('NEXT',c,e);const a=o.shape;const s=a[0].length*b;const t=c-s/2-2;for(let f=0;f<a.length;f++)for(let h=0;h<a[f].length;h++)if(a[f][h]){const j=a[f][h];const c=t+h*b;const i=e+20+f*b;if(j===2&&u)try{g.setColor(O),g.drawImage(u,c,i,{scale:b/u.width})}catch(a){console.log('Failed to load nuke image:',a)}else g.setColor(d),A?g.drawRect(c,i,c+b-1,i+b-1):g.fillRect(c,i,c+b-1,i+b-1)}}function Y(){const c=x.y2-40;const e=300;const b=10;const q=B.length*b;const r=B[0].length*b;const f=c-q-10;const i=e-r/2;g.setFont('6x8',1),g.setColor(k);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,e,c);const a=6;const u=10;const m=e-t/2-u;const n=c;g.fillPoly([m,n,m+a,n-a,m+a,n+a]);const o=e+t/2+u;const p=c;g.fillPoly([o,p,o-a,p-a,o-a,p+a]);const v={x1:i-2,y1:f-2,x2:i+r+2,y2:f+q+2};g.setColor(h),g.fillRect(v),j&&l(v),g.setColor(d);for(let d=0;d<B.length;d++)for(let h=0;h<B[d].length;h++)if(B[d][h]){const a=i+h*b;const c=f+d*b;const e=a+b-1;const j=c+b-1;A?g.drawRect(a,c,e,j):g.fillRect(a,c,e,j)}}function ah(){const a=f.x2+65;const b=f.y2-60;const c=20;g.setFont('6x8',2);const i=m.toString();const t=g.stringWidth(i);const r=16;const n=100;const s=c+r+10;const o=a-n/2;const e=b+c-8;const p=a+n/2;const q=e+s;g.setColor(h),g.fillRect(o,e,p,q),j&&l({x1:o-1,y1:e-1,x2:p+1,y2:q+1}),g.setColor(k),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(i,a,b+c)}function aA(){U();const a=M/2;const b=N/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(a3,a,b-50),g.setColor(k),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15);try{g.setColor(d),g.drawImage(Q,a-34,b-29)}catch(a){console.log('Failed to load gear image:',a)}p>0&&(g.setColor(k),g.setFont('6x8',2),g.drawString('High Score: '+p,a,b+35)),Y(),X(),$()}function aB(){if(!a||q)return;if(t(!0),a.y++,y(a)&&(a.y--,t(!1),ak(a),V(),a0(),y(a))){q=!0,clearInterval(w),setTimeout(af,50);return}t(!1),l(f);const c=BTN_PLAY.read();const b=c?100:v;S!==b&&(clearInterval(w),w=setInterval(aj,b),S=b)}function aC(){if(!a||q)return;t(!0);while(!y(a))a.y++;a.y--,t(!1),ak(a),V(),W(),a0(),t(!1)}function C(a,c){g.setColor(h),g.fillRect(r+a*b,s+c*b,r+(a+1)*b-1,s+(c+1)*b-1)}function Z(){let b=Math.floor(Math.random()*ad.length);let a=ad[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function aD(){al()}function aE(b){let a=Date.now();if(a-ab<at)return;ab=a,b===0?aC():aM(b)}function aF(){am(),clearInterval(w),bC.clear(1).flip(),E.reboot()}function aG(a){aJ(a>0?1:-1)}function ai(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aH(){try{let a=fs.readFile(a4);if(!a)throw new Error('Config file missing');let b=JSON.parse(a);p=b.highScore||0}catch(a){console.log('Error loading config:',a),p=0,an()}}function aI(){u=_(ar),Q=_(aq),a5=_(as)}function _(a){try{let c=fs.readFileSync(a);let b=JSON.parse(c);return{bpp:b.bpp,buffer:atob(b.buffer),height:b.height,transparent:b.transparent,width:b.width}}catch(b){return console.log('Failed to load image:',a,b),null}}function aj(){j&&console.log('Mem: '+process.memory().usage+'/5000'),aB()}function ak(a){let b=!1;for(let d=0;d<a.shape.length;d++)for(let f=0;f<a.shape[d].length;f++)if(a.shape[d][f]){const g=a.x+f;const h=a.y+d;if(!(isFinite(g)&&isFinite(h))){console.log('Invalid fx/fy',g,h);continue}a.shape[d][f]===2?(j&&console.log('Nuking coords: ',g,h),g>=0&&g<c&&h>=0&&h<i?(e[h*c+g]=0,aK(g,h),b=!0):j&&console.log('Nuke is out of bounds!',g,h)):e[h*c+g]=1}b&&V()}function aJ(c){if(q||!a)return;z(!0);let b=a.x;if(a.x+=c,y(a)){a.x=b,z();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&C(b+e,a.y+d);z(),t(!1),l(f)}function aK(a,b){if(J){console.log('Nuke is still nuking...');return}if(J=!0,!(isFinite(a)&&isFinite(b))){console.log('We were sent incorrect nuke coordinates!'),J=!1;return}a=Math.max(0,Math.min(a,c-1)),b=Math.max(0,Math.min(b,i-1));for(let d=-I;d<=I;d++)for(let f=-I;f<=I;f++){let g=a+f;let h=b+d;g>=0&&g<c&&h>=0&&h<i&&(e[h*c+g]=0,C(g,h))}au(),J=!1}function al(){if(!T.length)return;const a=T[Math.floor(Math.random()*T.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function aL(){e.fill(0),g.setColor(h),g.fillRect(r,s,r+c*b-1,s+i*b-1)}function aM(e){if(q||!a)return;z(!0);const b=a.shape;const d=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,y(a)){a.shape=c,z();return}for(let f=0;f<c.length;f++)for(let g=0;g<c[f].length;g++)c[f][g]&&C(a.x+g,a.y+f);t(!1),z(),l(f)}function am(){Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.removeAllListeners(P),Pip.removeAllListeners(ac)}function an(){let a={highScore:p};try{fs.writeFile(a4,JSON.stringify(a))}catch(a){console.log('Error saving high score:',a)}}function aN(){Pip.on(G,aE),Pip.on(H,aG),Pip.on(P,ai),Pip.on(ac,aD)}function $(){Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.on(G,aO),Pip.on(H,a1)}function a0(){o||(o=Z()),a=o,o=Z(),a6=o.shape.some(a=>a.includes(2)),W(),y(a)&&(q=!0,av(),clearInterval(w),setTimeout(()=>{af()},50))}function ao(){clearInterval(D),clearInterval(w),am(),al(),q=!1,a=null,j?(n=10,m=1e4):(n=0,m=0),F=n*a9,v=Math.max(R-n*a8,a7),S=v,o=Z(),U(),aL(),ag(),ah(),l(f),a0(),W(),aw(),aN(),w=setInterval(aj,v)}function aO(){K=!K,X()}function a1(){A=!A,Y()}function aP(){let a=Math.floor(F/a9);a>n&&(n=a,v=Math.max(R-n*a8,a7),console.log('Level up! New speed:',v,'ms'))}const a2={};const a3='PIPTRIS';const ap='2.5.0';const j=!1;const a4='USER/piptris.json';const aq='USER/gear.json';const ar='USER/nuke.json';const as='USER/radioactive.json';let Q=null;let u=null;let a5=null;const R=800;let a=null;let v=R;let o=null;let b=15;let S=v;let p=0;let D=null;let q=!1;let F=0;let w=null;let m=0;let A=!1;const I=2;let J=!1;let a6=!1;let K=!1;let L=null;let n=0;const a7=100;const a8=50;const a9=10;const M=g.getWidth();const N=g.getHeight();const x={x1:60,x2:M-60,y1:10,y2:N-10};const h='#000000';const O='#FF0000';const aa=g.blendColor(h,O,.5);const d=g.theme.fg;const k=g.blendColor(h,d,.5);const c=10;const i=20;const e=new Uint8Array(c*i);const r=(x.x1+x.x2)/2-b*c/2;const s=x.y1+(x.y2-x.y1)/2-b*i/2;const f={x1:r-1,y1:s-1,x2:r+c*b,y2:s+i*b};const G='knob1';const H='knob2';const P='torch';const at=30;let ab=0;const ac='audioStopped';const T=['USER/piptris.wav'];const B=[[0,1,0],[1,1,1]];const ad=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],B,[[1,1],[1,1]],[[2]]];return a2.run=function(){bC.clear(),aI(),aH(),aA(),$(),Pip.on(P,ai),D=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(D),Pip.removeListener(G,a1),Pip.removeListener(H,a1),Pip.removeAllListeners(P),ao())},100),setWatch(()=>aF(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},a2}Piptris().run()