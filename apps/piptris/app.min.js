function Piptris(){function ap(){for(let a=h-2;a>=0;a--)for(let b=0;b<c;b++)if(e[a*c+b]){let d=a;while(d+1<h&&!e[(d+1)*c+b])e[(d+1)*c+b]=e[d*c+b],e[d*c+b]=0,d++}}function aq(){l>q&&(q=l,aj())}function T(){g.setColor(i),g.fillRect(0,0,N,O)}function U(){let a=0;let b=0;const d=h;while(b++<d){let b=!1;for(let f=h-1;f>=0;f--){let d=!0;for(let g=0;g<c;g++)if(!e[f*c+g]){d=!1;break}if(d){for(let e=0;e<c;e++)B(e,f);for(let g=f;g>0;g--)for(let f=0;f<c;f++)e[g*c+f]=e[(g-1)*c+f];for(let f=0;f<c;f++)e[f]=0;a++,G++,aI(),b=!0;break}}if(!b)break}b>=d&&console.log('Clear line safeguard triggered!');switch(a){case 1:l+=100;break;case 2:l+=300;break;case 3:l+=500;break;case 4:l+=800;break}}function x(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let f=a.x+d,g=a.y+b;if(f<0||f>=c||g>=h||g>=0&&e[g*c+f])return!0}return!1}function aa(h,i,j){const k=j!==void 0?j:e[i*c+h];const a=o+h*b;const f=p+i*b;k===2?(g.setColor(a6),g.drawImage(D,a,f)):(g.setColor(d),z?g.drawRect(a,f,a+b-1,f+b-1):g.fillRect(a,f,a+b-1,f+b-1))}function m(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function s(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?B(a.x+d,a.y+c):aa(a.x+d,a.y+c,a.shape[c][d]))}function V(){g.setColor(d);for(let a=0;a<h;a++)for(let b=0;b<c;b++)e[a*c+b]?aa(b,a):B(b,a);y(),ad(),ac(),as(),at()}function ar(){const c=20;const a=f.x1-60;const b=f.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(a1,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+al,a,b+c)}function ab(){T();const a=N/2;const b=O/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(j),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60),C&&(g.setColor(d),g.drawImage(C,a-45,b-75));const c=b-20;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+l,a,c),g.drawString('Level: '+n,a,c+e),g.drawString('Lines: '+G,a,c+e*2),g.setColor(j),g.drawString('High Score: '+q,a,c+e*3+10),X(),W(),Z(),F=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(F),ak())},100)}function y(d){if(!(L&&a)||r)return;let c=d&&M?M:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!x({x:c.x,y:c.y+1,shape:c.shape}))c.y++;M={x:c.x,y:c.y,shape:c.shape}}else if(!M)return;let e=d?i:j;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const d=[o+(c.x+f)*b,p+(c.y+a)*b,o+(c.x+f+1)*b-1,p+(c.y+a+1)*b-1];z?g.drawRect(d[0],d[1],d[2],d[3]):g.fillRect(d[0],d[1],d[2],d[3])}}function W(){g.setFont('6x8',1);const e=w.y2-40;const a=180;const f=e-22;const h={ON:'ON',OFF:'OFF'};const z=L?h.ON:h.OFF;const q=8;const r=2;g.setFont('6x'+q,r);const s=g.stringWidth(h.OFF);const t=q*r;const u={x1:a-s/2,y1:f-t/2,x2:a+s/2,y2:f+t};g.setColor(i),g.fillRect(u),k&&m(u),g.setColor(d),g.drawString(z,a,f+4),g.setFont('6x8',1),g.setColor(j);const v='GHOST';const x=g.stringWidth(v);g.drawString(v,a,e);const b=5;const y=8;const l=a-x/2-y-1;const n=e;g.fillPoly([l,n-b,l-b,n+b,l+b,n+b]);const o=a+x/2+y;const p=e;const c=b-1;g.fillPoly([o,p+c,o-c,p-c,o+c,p-c])}function as(){const a=f.x1-65;const b=f.y2-60;const c=20;g.setFont('6x8',2);const p=G.toString();const q=16;const h=80;const r=c+q+10;const l=a-h/2;const e=b+c-8;const n=a+h/2;const o=e+r;g.setColor(i),g.fillRect(l,e,n,o),k&&m({x1:l-1,y1:e-1,x2:n+1,y2:o+1}),g.setColor(j),g.drawString('LINES',a,b),g.setColor(d),g.drawString(p,a,b+c)}function ac(){const a=f.x1-65;const c=f.y2-120;const h=20;g.setFont('6x8',2);const l=n.toString();const o=g.stringWidth(l);const s=16;const b=4;const p=a-o/2-b;const e=c+h-b*2;const q=a+o/2+b;const r=e+s+b;g.setColor(i),g.fillRect(p,e,q,r),k&&m({x1:p-1,y1:e-1,x2:q+1,y2:r+1}),g.setColor(j),g.drawString('LEVEL',a,c),g.setColor(d),g.drawString(l,a,c+h)}function at(){if(!u)return;const c=f.x2+65;const e=f.y1+25;const l=4*b;const h=6;const n=c-l/2-h;const o=e+15-h;const p=c+l/2+h;const q=e+15+l+h;g.setColor(i),g.fillRect(n,o,p,q),k&&m({x1:n-1,y1:o-1,x2:p+1,y2:q+1}),g.setFont('6x8',2),g.setColor(j),g.drawString('NEXT',c,e);const a=u.shape;const r=a[0].length*b;const s=c-r/2-2;for(let f=0;f<a.length;f++)for(let i=0;i<a[f].length;i++)if(a[f][i]){const j=a[f][i];const c=s+i*b;const h=e+20+f*b;j===2&&D?(g.setColor(a6),g.drawImage(D,c,h,{scale:b/D.width})):(g.setColor(d),z?g.drawRect(c,h,c+b-1,h+b-1):g.fillRect(c,h,c+b-1,h+b-1))}}function X(){const c=w.y2-40;const e=300;const b=10;const q=A.length*b;const r=A[0].length*b;const f=c-q-10;const h=e-r/2;g.setFont('6x8',1),g.setColor(j);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,e,c);const a=6;const u=10;const l=e-t/2-u;const n=c;g.fillPoly([l,n,l+a,n-a,l+a,n+a]);const o=e+t/2+u;const p=c;g.fillPoly([o,p,o-a,p-a,o-a,p+a]);const v={x1:h-2,y1:f-2,x2:h+r+2,y2:f+q+2};g.setColor(i),g.fillRect(v),k&&m(v),g.setColor(d);for(let d=0;d<A.length;d++)for(let i=0;i<A[d].length;i++)if(A[d][i]){const a=h+i*b;const c=f+d*b;const e=a+b-1;const j=c+b-1;z?g.drawRect(a,c,e,j):g.fillRect(a,c,e,j)}}function ad(){const a=f.x2+65;const b=f.y2-60;const c=20;g.setFont('6x8',2);const h=l.toString();const t=g.stringWidth(h);const r=16;const n=100;const s=c+r+10;const o=a-n/2;const e=b+c-8;const p=a+n/2;const q=e+s;g.setColor(i),g.fillRect(o,e,p,q),k&&m({x1:o-1,y1:e-1,x2:p+1,y2:q+1}),g.setColor(j),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(h,a,b+c)}function au(){T();const a=N/2;const b=O/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(a1,a,b-50),g.setColor(j),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15),C&&(g.setColor(d),g.drawImage(C,a-34,b-29)),q>0&&(g.setColor(j),g.setFont('6x8',2),g.drawString('High Score: '+q,a,b+35)),X(),W(),Z()}function ae(){if(!a||r)return;if(s(!0),a.y++,x(a)&&(a.y--,s(!1),ag(a),U(),_(),x(a))){r=!0,clearInterval(v),setTimeout(ab,50);return}s(!1),m(f);const c=BTN_PLAY.read();const b=c?100:t;R!==b&&(clearInterval(v),v=setInterval(ae,b),R=b)}function av(){if(!a||r)return;s(!0);while(!x(a))a.y++;a.y--,s(!1),ag(a),U(),V(),_(),s(!1)}function B(a,c){g.setColor(i),g.fillRect(o+a*b,p+c*b,o+(a+1)*b-1,p+(c+1)*b-1)}function Y(){let b=Math.floor(Math.random()*a9.length);let a=a9[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function aw(){ah()}function ax(b){let a=Date.now();if(a-a7<ao)return;a7=a,b===0?av():aF(b)}function ay(){ai(),clearInterval(v),bC.clear(1).flip(),E.reboot()}function az(a){aC(a>0?1:-1)}function af(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aA(){try{let a=fs.readFileSync(a2);let b=JSON.parse(a);q=b.highScore||0}catch(a){console.log('No piptris.json, using default high score.'),q=0,aj()}}function aB(){try{let b=fs.readFileSync(an);let a=JSON.parse(b);D={bpp:a.bpp,buffer:atob(a.buffer),height:a.height,width:a.width,transparent:a.transparent}}catch(a){console.log('Failed to load nuke image:',a)}try{let b=fs.readFileSync(am);let a=JSON.parse(b);C={bpp:a.bpp,buffer:atob(a.buffer),height:a.height,width:a.width,transparent:a.transparent}}catch(a){console.log('Failed to load gear image:',a)}}function ag(a){let b=!1;for(let d=0;d<a.shape.length;d++)for(let f=0;f<a.shape[d].length;f++)if(a.shape[d][f]){const g=a.x+f;const i=a.y+d;if(!(isFinite(g)&&isFinite(i))){console.log('Invalid fx/fy',g,i);continue}a.shape[d][f]===2?(k&&console.log('Nuking coords: ',g,i),g>=0&&g<c&&i>=0&&i<h?(e[i*c+g]=0,aD(g,i),b=!0):k&&console.log('Nuke is out of bounds!',g,i)):e[i*c+g]=1}b&&U()}function aC(c){if(r||!a)return;y(!0);let b=a.x;if(a.x+=c,x(a)){a.x=b,y();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&B(b+e,a.y+d);y(),s(!1),m(f)}function aD(a,b){if(K){console.log('Nuke is still nuking...');return}if(K=!0,!(isFinite(a)&&isFinite(b))){console.log('We were sent incorrect nuke coordinates!'),K=!1;return}a=Math.max(0,Math.min(a,c-1)),b=Math.max(0,Math.min(b,h-1));for(let d=-J;d<=J;d++)for(let f=-J;f<=J;f++){let g=a+f;let i=b+d;g>=0&&g<c&&i>=0&&i<h&&(e[i*c+g]=0,B(g,i))}ap(),K=!1}function ah(){if(!S.length)return;const a=S[Math.floor(Math.random()*S.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function aE(){e.fill(0),g.setColor(i),g.fillRect(o,p,o+c*b-1,p+h*b-1)}function aF(e){if(r||!a)return;y(!0);const b=a.shape;const d=e>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,x(a)){a.shape=c,y();return}for(let f=0;f<c.length;f++)for(let g=0;g<c[f].length;g++)c[f][g]&&B(a.x+g,a.y+f);s(!1),y(),m(f)}function ai(){Pip.removeAllListeners(H),Pip.removeAllListeners(I),Pip.removeAllListeners(P),Pip.removeAllListeners(a8)}function aj(){let a={highScore:q};try{fs.writeFile(a2,JSON.stringify(a))}catch(a){console.log('Error saving high score:',a)}}function aG(){Pip.on(H,ax),Pip.on(I,az),Pip.on(P,af),Pip.on(a8,aw)}function Z(){Pip.removeAllListeners(H),Pip.removeAllListeners(I),Pip.on(H,aH),Pip.on(I,$)}function _(){u||(u=Y()),a=u,u=Y(),V(),x(a)&&(r=!0,aq(),clearInterval(v),setTimeout(()=>{ab()},50))}function ak(){clearInterval(F),clearInterval(v),ai(),ah(),r=!1,a=null,k?(n=10,l=1e4):(n=0,l=0),G=n*a5,t=Math.max(Q-n*a4,a3),R=t,u=Y(),T(),aE(),ac(),ad(),m(f),_(),V(),ar(),aG(),v=setInterval(function a(){k&&console.log('Mem: '+process.memory().usage+'/5000'),ae()},t)}function aH(){L=!L,W()}function $(){z=!z,X()}function aI(){let a=Math.floor(G/a5);a>n&&(n=a,t=Math.max(Q-n*a4,a3),console.log('Level up! New speed:',t,'ms'))}const a0={};const a1='PIPTRIS';const al='2.6.0';const k=!0;const a2='USER/piptris.json';const am='USER/gear.json';const an='USER/nuke.json';let C=null;let D=null;const Q=800;let a=null;let t=Q;let u=null;let b=15;let R=t;let q=0;let F=null;let r=!1;let G=0;let v=null;let l=0;let z=!1;const J=2;let K=!1;let L=!1;let M=null;let n=0;const a3=100;const a4=50;const a5=10;const N=g.getWidth();const O=g.getHeight();const w={x1:60,x2:N-60,y1:10,y2:O-10};const i='#000000';const a6='#FF0000';const d=g.theme.fg;const j=g.blendColor(i,d,.5);const c=10;const h=20;const e=new Uint8Array(c*h);const o=(w.x1+w.x2)/2-b*c/2;const p=w.y1+(w.y2-w.y1)/2-b*h/2;const f={x1:o-1,y1:p-1,x2:o+c*b,y2:p+h*b};const H='knob1';const I='knob2';const P='torch';const ao=30;let a7=0;const a8='audioStopped';const S=['USER/piptris.wav'];const A=[[0,1,0],[1,1,1]];const a9=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],A,[[1,1],[1,1]],[[2]]];return a0.run=function(){bC.clear(),aA(),aB(),au(),Z(),Pip.on(P,af),F=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(F),Pip.removeListener(H,$),Pip.removeListener(I,$),Pip.removeAllListeners(P),ak())},100),setWatch(()=>ay(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},a0}Piptris().run()