function Piptris(){function aq(){for(let a=i-2;a>=0;a--)for(let c=0;c<b;c++)if(f[a*b+c]){let d=a;while(d+1<i&&!f[(d+1)*b+c])f[(d+1)*b+c]=f[d*b+c],f[d*b+c]=0,d++}}function ar(){j>t&&(t=j,aj())}function Q(){g.setColor(h),g.fillRect(0,0,K,L)}function R(){let a=0;let c=0;const d=i;while(c++<d){let c=!1;for(let e=i-1;e>=0;e--){let d=!0;for(let g=0;g<b;g++)if(!f[e*b+g]){d=!1;break}if(d){for(let f=0;f<b;f++)z(f,e);for(let g=e;g>0;g--)for(let e=0;e<b;e++)f[g*b+e]=f[(g-1)*b+e];for(let e=0;e<b;e++)f[e]=0;a++,A++,aK(),c=!0;break}}if(!c)break}switch(a){case 1:j+=100;break;case 2:j+=300;break;case 3:j+=500;break;case 4:j+=800;break}}function y(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let e=a.x+d,g=a.y+c;if(e<0||e>=b||g>=i||g>=0&&f[g*b+e])return!0}return!1}function ac(h,i,j){const k=j!==void 0?j:f[i*b+h];const a=n+h*c;const d=o+i*c;if(k===2)try{g.setColor(C),g.drawImage(H(a3),a,d)}catch(a){console.log(a)}else g.setColor(e),B?g.drawRect(a,d,a+c-1,d+c-1):g.fillRect(a,d,a+c-1,d+c-1)}function N(a){g.setColor(e),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function s(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?z(a.x+d,a.y+c):ac(a.x+d,a.y+c,a.shape[c][d]))}function S(){g.setColor(e);for(let a=0;a<i;a++)for(let c=0;c<b;c++)f[a*b+c]?ac(c,a):z(c,a);V(),ae(),au(),av(),at()}function as(){const c=20;const a=d.x1-60;const b=d.y1+35;g.setColor(e),g.setFontMonofonto28(),g.drawString(a0,a,b),g.setColor(e),g.setFont('6x8',1),g.drawString('v'+al,a,b+c)}function ad(){Q();const a=K/2;const b=L/2;g.clear(),g.setColor(e),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(k),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60);try{g.setColor(e),g.drawImage(H(a2),a-45,b-75)}catch(a){console.log(a)}const c=b-20;const d=18;g.setColor(e),g.setFont('6x8'),g.drawString('Score: '+j,a,c),g.drawString('Level: '+r,a,c+d),g.drawString('Lines: '+A,a,c+d*2),g.setColor(k),g.drawString('High Score: '+t,a,c+d*3+10),U(),T(),Y(),l=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(l),l=null,ak())},100)}function at(){const a=d.x2+65;const b=d.y1+100;const c=18;if(!a4){const d=100;const e=c*2+50+10;const f={x1:a-d/2-5,y1:b-10,x2:a+d/2,y2:b+e};g.setColor(h),g.fillRect(f);return}g.setFont('6x8',2),g.setColor(C),g.drawString('INCOMING',a,b),g.drawString('NUKE!',a,b+c);try{const d=50;const e=a-d/2;const f=b+c*2+5;g.setColor(ao),g.drawImage(H(am),e,f)}catch(a){console.log(a)}}function au(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const j=A.toString();const l=16;const f=80;const m=c+l+10;const n=a-f/2;const i=b+c-8;const o=a+f/2;const p=i+m;g.setColor(h),g.fillRect(n,i,o,p),g.setColor(k),g.drawString('LINES',a,b),g.setColor(e),g.drawString(j,a,b+c)}function ae(){const a=d.x1-65;const c=d.y2-120;const f=20;g.setFont('6x8',2);const i=r.toString();const j=g.stringWidth(i);const m=16;const b=4;const n=a-j/2-b;const l=c+f-b*2;const o=a+j/2+b;const p=l+m+b;g.setColor(h),g.fillRect(n,l,o,p),g.setColor(k),g.drawString('LEVEL',a,c),g.setColor(e),g.drawString(i,a,c+f)}function av(){if(!p)return;const b=d.x2+65;const f=d.y1+25;const j=4*c;const i=6;const l=b-j/2-i;const m=f+15-i;const n=b+j/2+i;const o=f+15+j+i;g.setColor(h),g.fillRect(l,m,n,o),g.setFont('6x8',2),g.setColor(k),g.drawString('NEXT',b,f);const a=p.shape;const q=a[0].length*c;const r=b-q/2-2;for(let d=0;d<a.length;d++)for(let h=0;h<a[d].length;h++)if(a[d][h]){const j=a[d][h];const b=r+h*c;const i=f+20+d*c;if(j===2)try{const a=H(a3);g.setColor(C),g.drawImage(a,b,i,{scale:c/a.width})}catch(a){console.log(a)}else g.setColor(e),B?g.drawRect(b,i,b+c-1,i+c-1):g.fillRect(b,i,b+c-1,i+c-1)}}function T(){g.setFont('6x8',1);const d=v.y2-40;const a=180;const f=d-22;const i={ON:'ON',OFF:'OFF'};const w=I?i.ON:i.OFF;const o=8;const p=2;g.setFont('6x'+o,p);const q=g.stringWidth(i.OFF);const r=o*p;const x={x1:a-q/2,y1:f-r/2,x2:a+q/2,y2:f+r};g.setColor(h),g.fillRect(x),g.setColor(e),g.drawString(w,a,f+4),g.setFont('6x8',1),g.setColor(k);const s='NUKE';const t=g.stringWidth(s);g.drawString(s,a,d);const b=5;const u=8;const j=a-t/2-u-1;const l=d;g.fillPoly([j,l-b,j-b,l+b,j+b,l+b]);const m=a+t/2+u;const n=d;const c=b-1;g.fillPoly([m,n+c,m-c,n-c,m+c,n-c])}function U(){const c=v.y2-40;const d=300;const b=10;const o=x.length*b;const p=x[0].length*b;const f=c-o-10;const i=d-p/2;g.setFont('6x8',1),g.setColor(k);const q='TYPE';const r=g.stringWidth(q);g.drawString(q,d,c);const a=6;const s=10;const j=d-r/2-s;const l=c;g.fillPoly([j,l,j+a,l-a,j+a,l+a]);const m=d+r/2+s;const n=c;g.fillPoly([m,n,m-a,n-a,m-a,n+a]);const t={x1:i-2,y1:f-2,x2:i+p+2,y2:f+o+2};g.setColor(h),g.fillRect(t),g.setColor(e);for(let e=0;e<x.length;e++)for(let h=0;h<x[e].length;h++)if(x[e][h]){const a=i+h*b;const c=f+e*b;const d=a+b-1;const j=c+b-1;B?g.drawRect(a,c,d,j):g.fillRect(a,c,d,j)}}function V(){const a=d.x2+65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const f=j.toString();const r=g.stringWidth(f);const m=16;const i=100;const n=c+m+10;const o=a-i/2;const l=b+c-8;const p=a+i/2;const q=l+n;g.setColor(h),g.fillRect(o,l,p,q),g.setColor(k),g.drawString('SCORE',a,b),g.setColor(e),g.drawString(f,a,b+c)}function aw(){Q();const a=K/2;const b=L/2;g.clear(),g.setColor(e),g.setFontMonofonto36(),g.drawString(a0,a,b-50),g.setColor(k),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15);try{g.setColor(e),g.drawImage(H(a2),a-34,b-29)}catch(a){console.log(a)}g.setColor(k),g.setFont('6x8'),g.drawString('High Score: '+t,a,b+35),U(),T(),Y()}function ax(){if(!a||u)return;if(s(!0),a.y++,y(a)&&(a.y--,s(!1),ah(a),R(),Z(),y(a))){u=!0,clearInterval(m),setTimeout(ad,50);return}s(!1),N(d);const c=BTN_PLAY.read();const b=c?100:w;P!==b&&(clearInterval(m),m=setInterval(ag,b),P=b)}function ay(){if(!a||u)return;s(!0);while(!y(a))a.y++;a.y--,s(!1),ah(a),R(),S(),Z(),s(!1)}function z(a,b){g.setColor(h),g.fillRect(n+a*c,o+b*c,n+(a+1)*c-1,o+(b+1)*c-1)}function W(c){c===void 0&&(c=I);let a;while(!0){let b=Math.floor(Math.random()*ab.length);if(a=ab[b],!(!c&&a[0][0]===2))break}let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function az(){X()}function aA(b){let a=Date.now();if(a-a8<ap)return;a8=a,b===0?ay():aH(b)}function aB(){ai(),clearInterval(m),bC.clear(1).flip(),E.reboot()}function aC(a){aE(a>0?1:-1)}function af(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aD(){try{let a=fs.readFile(a1);if(!a)throw new Error('Config file missing');let b=JSON.parse(a);t=b.highScore||0,G=b.music||[]}catch(a){console.log(a),t=0,aj()}}function H(a){try{let c=fs.readFile(a);let b=JSON.parse(c);return{bpp:b.bpp,buffer:atob(b.buffer),height:b.height,transparent:b.transparent,width:b.width}}catch(b){return console.log(a,b),null}}function ag(){ax()}function ah(a){let c=!1;for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)if(a.shape[d][e]){const g=a.x+e;const h=a.y+d;if(!(isFinite(g)&&isFinite(h)))continue;a.shape[d][e]===2?g>=0&&g<b&&h>=0&&h<i&&(f[h*b+g]=0,aF(g,h),c=!0):f[h*b+g]=1}c&&R()}function aE(c){if(u||!a)return;let b=a.x;if(a.x+=c,y(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&z(b+e,a.y+d);s(!1),N(d)}function aF(e,k){if(J)return;if(J=!0,!(isFinite(e)&&isFinite(k))){J=!1;return}e=Math.max(0,Math.min(e,b-1)),k=Math.max(0,Math.min(k,i-1));let a={x1:n+(e-q)*c+1,y1:o+(k-q)*c+1,x2:n+(e+q+1)*c-2,y2:o+(k+q+1)*c-2};a.x1=Math.max(a.x1,d.x1+1),a.y1=Math.max(a.y1,d.y1+1),a.x2=Math.min(a.x2,d.x2-1),a.y2=Math.min(a.y2,d.y2-1),g.setColor(C),g.drawRect(a);let l=0;for(let c=-q;c<=q;c++)for(let d=-q;d<=q;d++){let a=e+d;let g=k+c;a>=0&&a<b&&g>=0&&g<i&&f[g*b+a]&&(f[g*b+a]=0,z(a,g),l++)}let m=l*an;j+=m,V(),g.setColor(h),g.fillRect(a),aq(),J=!1}function X(){if(!G.length){console.log('No music tracks available');return}const a=G[Math.floor(Math.random()*G.length)];if(a===aa)return X();Pip.audioStop(),Pip.audioStart(a),aa=a}function aG(){f.fill(0),g.setColor(h),g.fillRect(n,o,n+b*c-1,o+i*c-1)}function aH(f){if(u||!a)return;const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,y(a)){a.shape=c;return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&z(a.x+g,a.y+d);s(!1),N(d)}function ai(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(M),Pip.removeAllListeners(a9)}function aj(){let a={highScore:t,music:G};try{fs.writeFile(a1,JSON.stringify(a))}catch(a){console.log(a)}}function aI(){Pip.on(D,aA),Pip.on(F,aC),Pip.on(M,af),Pip.on(a9,az)}function Y(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.on(D,aJ),Pip.on(F,_)}function Z(){p||(p=W()),a=p,p=W(),a4=p.shape.some(a=>a.includes(2)),S(),y(a)&&(u=!0,ar(),clearInterval(m),setTimeout(()=>{ad()},50))}function ak(){l&&(clearInterval(l),l=null),m&&(clearInterval(m),m=null),ai(),X(),u=!1,a=null,r=0,j=0,A=r*a7,w=Math.max(O-r*a6,a5),P=w,p=W(!1),Q(),aG(),ae(),V(),N(d),Z(),S(),as(),aI(),m=setInterval(ag,w)}function aJ(){I=!I,T()}function _(){B=!B,U()}function aK(){let a=Math.floor(A/a7);a>r&&(r=a,w=Math.max(O-r*a6,a5))}const $={};const a0='PIPTRIS';const al='2.6.0';const a1='USER/PIPTRIS/piptris.json';const a2='USER/PIPTRIS/gear.json';const a3='USER/PIPTRIS/nuke.json';const am='USER/PIPTRIS/radioactive.json';const O=800;let a=null;let w=O;let p=null;let c=15;let P=w;let t=0;let l=null;let u=!1;let A=0;let m=null;let j=0;let B=!1;const an=10;const q=2;let I=!0;let J=!1;let a4=!1;let r=0;const a5=100;const a6=50;const a7=10;const K=g.getWidth();const L=g.getHeight();const v={x1:60,x2:K-60,y1:10,y2:L-10};const h='#000000';const C='#FF0000';const ao=g.blendColor(h,C,.5);const e=g.theme.fg;const k=g.blendColor(h,e,.5);const b=10;const i=20;const f=new Uint8Array(b*i);const n=(v.x1+v.x2)/2-c*b/2;const o=v.y1+(v.y2-v.y1)/2-c*i/2;const d={x1:n-1,y1:o-1,x2:n+b*c,y2:o+i*c};const D='knob1';const F='knob2';const M='torch';const ap=30;let a8=0;const a9='audioStopped';let G=[];let aa=null;const x=[[0,1,0],[1,1,1]];const ab=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],x,[[1,1],[1,1]],[[2]]];return $.run=function(){bC.clear(),aD(),aw(),Y(),Pip.on(M,af),l=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(l),l=null,Pip.removeListener(D,_),Pip.removeListener(F,_),Pip.removeAllListeners(M),ak())},100),setWatch(()=>aB(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},$}Piptris().run()