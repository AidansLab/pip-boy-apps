function Piptris(){function O(){g.setColor(f),g.fillRect(0,0,H,I)}function a3(){let a=0;for(let b=v-1;b>=0;b--){let d=!0;for(let e=0;e<c;e++)if(!o[b*c+e]){d=!1;break}if(d){for(let d=0;d<c;d++)D(d,b);for(let d=b;d>0;d--)for(let b=0;b<c;b++)o[d*c+b]=o[(d-1)*c+b];for(let b=0;b<c;b++)o[b]=0;a++,A++,b++,av()}}switch(a){case 1:n+=100;break;case 2:n+=300;break;case 3:n+=500;break;case 4:n+=800;break}}function w(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,f=a.y+b;if(e<0||e>=c||f>=v||f>=0&&o[f*c+e])return!0}return!1}function a4(c,e){g.setColor(d);const a=[h+c*b,i+e*b,h+(c+1)*b-1,i+(e+1)*b-1];y?g.drawRect(a[0],a[1],a[2],a[3]):g.fillRect(a[0],a[1],a[2],a[3])}function j(a){g.setColor(d),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function p(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?D(a.x+d,a.y+c):a4(a.x+d,a.y+c))}function P(){g.setColor(d);for(let a=0;a<v;a++)for(let b=0;b<c;b++)o[a*c+b]?a4(b,a):D(b,a);x(),a9(),a7(),ai(),aj()}function ah(){const c=20;const a=e.x1-60;const b=e.y1+35;g.setColor(d),g.setFontMonofonto28(),g.drawString(X,a,b),g.setColor(d),g.setFont('6x8',1),g.drawString('v'+af,a,b+c)}function a5(){O();const a=H/2;const b=I/2;g.clear(),g.setColor(d),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(l),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60),a6(a1,a-45,b-75);const c=b;const e=18;g.setColor(d),g.setFont('6x8',2),g.drawString('Score: '+n,a,c),g.drawString('Level: '+k,a,c+e),g.drawString('Lines: '+A,a,c+e*2),R(),Q(),T(),F=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(F),ae())},100)}function x(d){if(!(G&&a)||m)return;let c=d&&M?M:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!w({x:c.x,y:c.y+1,shape:c.shape}))c.y++;M={x:c.x,y:c.y,shape:c.shape}}let e=d?f:l;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const d=[h+(c.x+f)*b,i+(c.y+a)*b,h+(c.x+f+1)*b-1,i+(c.y+a+1)*b-1];y?g.drawRect(d[0],d[1],d[2],d[3]):g.fillRect(d[0],d[1],d[2],d[3])}}function Q(){g.setFont('6x8',1);const e=u.y2-40;const a=180;const h=e-22;const i={ON:'ON',OFF:'OFF'};const z=G?i.ON:i.OFF;const p=8;const r=2;g.setFont('6x'+p,r);const s=g.stringWidth(i.OFF);const t=p*r;const v={x1:a-s/2,y1:h-t/2,x2:a+s/2,y2:h+t};g.setColor(f),g.fillRect(v),q&&j(v),g.setColor(d),g.drawString(z,a,h+4),g.setFont('6x8',1),g.setColor(l);const w='GHOST';const x=g.stringWidth(w);g.drawString(w,a,e);const b=5;const y=8;const k=a-x/2-y-1;const m=e;g.fillPoly([k,m-b,k-b,m+b,k+b,m+b]);const n=a+x/2+y;const o=e;const c=b-1;g.fillPoly([n,o+c,n-c,o-c,n+c,o-c])}function a6(a,b,c){try{let f=fs.readFileSync(a);let e=JSON.parse(f);let h={bpp:e.bpp,buffer:atob(e.buffer),height:e.height,transparent:e.transparent,width:e.width};g.setColor(d),g.drawImage(h,b,c)}catch(a){console.log('Failed to load image:',a)}}function ai(){const a=e.x1-65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const o=A.toString();const p=16;const i=80;const r=c+p+10;const k=a-i/2;const h=b+c-8;const m=a+i/2;const n=h+r;g.setColor(f),g.fillRect(k,h,m,n),q&&j({x1:k-1,y1:h-1,x2:m+1,y2:n+1}),g.setColor(l),g.drawString('LINES',a,b),g.setColor(d),g.drawString(o,a,b+c)}function a7(){const a=e.x1-65;const c=e.y2-120;const i=20;g.setFont('6x8',2);const m=k.toString();const n=g.stringWidth(m);const s=16;const b=4;const o=a-n/2-b;const h=c+i-b*2;const p=a+n/2+b;const r=h+s+b;g.setColor(f),g.fillRect(o,h,p,r),q&&j({x1:o-1,y1:h-1,x2:p+1,y2:r+1}),g.setColor(l),g.drawString('LEVEL',a,c),g.setColor(d),g.drawString(m,a,c+i)}function aj(){if(!s)return;const c=e.x2+65;const a=e.y1+25;const k=4*b;const h=6;const m=c-k/2-h;const n=a+15-h;const o=c+k/2+h;const p=a+15+k+h;g.setColor(f),g.fillRect(m,n,o,p),q&&j({x1:m-1,y1:n-1,x2:o+1,y2:p+1}),g.setFont('6x8',2),g.setColor(l),g.drawString('NEXT',c,a),g.setColor(d);const i=s.shape;const t=i[0].length*b;const r=c-t/2-2;for(let d=0;d<i.length;d++)for(let e=0;e<i[d].length;e++)if(i[d][e]){const c=[r+e*b,a+20+d*b,r+(e+1)*b-1,a+20+(d+1)*b-1];y?g.drawRect(c[0],c[1],c[2],c[3]):g.fillRect(c[0],c[1],c[2],c[3])}}function a8(){if(!a||m)return;if(p(!0),a.y++,w(a)&&(a.y--,p(!1),ab(a),a3(),U(),w(a))){m=!0,clearInterval(t),setTimeout(a5,50);return}p(!1),j(e);const c=BTN_PLAY.read();const b=c?100:r;L!==b&&(clearInterval(t),t=setInterval(a8,b),L=b)}function R(){const c=u.y2-40;const e=300;const b=10;const p=z.length*b;const r=z[0].length*b;const h=c-p-10;const i=e-r/2;g.setFont('6x8',1),g.setColor(l);const s='TYPE';const t=g.stringWidth(s);g.drawString(s,e,c);const a=6;const v=10;const k=e-t/2-v;const m=c;g.fillPoly([k,m,k+a,m-a,k+a,m+a]);const n=e+t/2+v;const o=c;g.fillPoly([n,o,n-a,o-a,n-a,o+a]);const w={x1:i-2,y1:h-2,x2:i+r+2,y2:h+p+2};g.setColor(f),g.fillRect(w),q&&j(w),g.setColor(d);for(let d=0;d<z.length;d++)for(let f=0;f<z[d].length;f++)if(z[d][f]){const a=i+f*b;const c=h+d*b;const e=a+b-1;const j=c+b-1;y?g.drawRect(a,c,e,j):g.fillRect(a,c,e,j)}}function a9(){const a=e.x2+65;const b=e.y2-60;const c=20;g.setFont('6x8',2);const i=n.toString();const t=g.stringWidth(i);const r=16;const k=100;const s=c+r+10;const m=a-k/2;const h=b+c-8;const o=a+k/2;const p=h+s;g.setColor(f),g.fillRect(m,h,o,p),q&&j({x1:m-1,y1:h-1,x2:o+1,y2:p+1}),g.setColor(l),g.drawString('SCORE',a,b),g.setColor(d),g.drawString(i,a,b+c)}function ak(){O();const a=H/2;const b=I/2;g.clear(),g.setColor(d),g.setFontMonofonto36(),g.drawString(X,a+10,b-50),g.setColor(l),g.setFont('6x8',2),g.drawString('Press    to START',a+10,b-15),a6(a1,a-24,b-29),R(),Q(),T()}function al(){if(!a||m)return;p(!0);while(!w(a))a.y++;a.y--,p(!1),ab(a),a3(),P(),U(),p(!1)}function D(a,c){g.setColor(f),g.fillRect(h+a*b,i+c*b,h+(a+1)*b-1,i+(c+1)*b-1)}function S(){let b=Math.floor(Math.random()*a2.length);let a=a2[b];let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function am(){ac()}function an(b){let a=Date.now();if(a-$<ag)return;$=a,b===0?al():as(b)}function ao(){ad(),clearInterval(t),bC.clear(1).flip(),E.reboot()}function ap(a){aq(a>0?1:-1)}function aa(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function ab(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++)a.shape[b][d]&&(o[(a.y+b)*c+a.x+d]=1)}function aq(c){if(m||!a)return;x(!0);let b=a.x;if(a.x+=c,w(a)){a.x=b,x();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&D(b+e,a.y+d);x(),p(!1),j(e)}function ac(){if(!N.length)return;const a=N[Math.floor(Math.random()*N.length)];Pip.audioStop(),Pip.audioStart(a),rd.setVol(.5)}function ar(){o.fill(0),g.setColor(f),g.fillRect(h,i,h+c*b-1,i+v*b-1)}function as(f){if(m||!a)return;x(!0);const b=a.shape;const d=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=d,w(a)){a.shape=c,x();return}for(let e=0;e<c.length;e++)for(let g=0;g<c[e].length;g++)c[e][g]&&D(a.x+g,a.y+e);p(!1),x(),j(e)}function ad(){Pip.removeAllListeners(B),Pip.removeAllListeners(C),Pip.removeAllListeners(J),Pip.removeAllListeners(a0)}function at(){Pip.on(B,an),Pip.on(C,ap),Pip.on(J,aa),Pip.on(a0,am)}function T(){Pip.removeAllListeners(B),Pip.removeAllListeners(C),Pip.on(B,au),Pip.on(C,V)}function U(){s||(s=S()),a=s,s=S(),P(),w(a)&&(m=!0,clearInterval(t),setTimeout(()=>{a5()},50))}function ae(){clearInterval(t),ad(),ac(),m=!1,a=null,q?(k=10,n=1e4):(k=0,n=0),A=k*_,r=Math.max(K-k*Z,Y),L=r,s=S(),O(),ar(),a7(),a9(),j(e),U(),P(),ah(),at(),t=setInterval(a8,r)}function au(){G=!G,Q()}function V(){y=!y,R()}function av(){let a=Math.floor(A/_);a>k&&(k=a,r=Math.max(K-k*Z,Y),console.log('Level up! New speed:',r,'ms'))}const W={};const X='PIPTRIS';const af='2.4.0';const q=!0;const K=800;let a=null;let r=K;let s=null;let b=15;let L=r;let F=null;let m=!1;let A=0;let t=null;let n=0;let y=!1;let G=!1;let M=null;let k=0;const Y=100;const Z=50;const _=10;const H=g.getWidth();const I=g.getHeight();const u={x1:60,x2:H-60,y1:10,y2:I-10};const f='#000';const d=g.theme.fg;const l=g.blendColor(f,d,.5);const c=10;const v=20;const o=new Uint8Array(c*v);const h=(u.x1+u.x2)/2-b*c/2;const i=u.y1+(u.y2-u.y1)/2-b*v/2;const e={x1:h-1,y1:i-1,x2:h+c*b,y2:i+v*b};const B='knob1';const C='knob2';const J='torch';const ag=30;let $=0;const a0='audioStopped';const N=['USER/piptris.wav'];const a1='USER/gear.json';const z=[[0,1,0],[1,1,1]];const a2=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],z,[[1,1],[1,1]]];return W.run=function(){bC.clear(),ak(),T(),Pip.on(J,aa),F=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(F),Pip.removeListener(B,V),Pip.removeListener(C,V),Pip.removeAllListeners(J),ae())},100),setWatch(()=>ao(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},W}Piptris().run()