function Piptris(){function as(){for(let a=i-2;a>=0;a--)for(let b=0;b<c;b++)if(f[a*c+b]){let d=a;while(d+1<i&&!f[(d+1)*c+b])f[(d+1)*c+b]=f[d*c+b],f[d*c+b]=0,d++}}function at(){k>q&&(q=k,am())}function T(){g.setColor(h),g.fillRect(0,0,M,N)}function U(){let a=0;let b=0;const d=i;while(b++<d){let b=!1;for(let e=i-1;e>=0;e--){let d=!0;for(let g=0;g<c;g++)if(!f[e*c+g]){d=!1;break}if(d){for(let f=0;f<c;f++)B(f,e);for(let g=e;g>0;g--)for(let e=0;e<c;e++)f[g*c+e]=f[(g-1)*c+e];for(let e=0;e<c;e++)f[e]=0;a++,D++,aM(),b=!0;break}}if(!b)break}switch(a){case 1:k+=100;break;case 2:k+=300;break;case 3:k+=500;break;case 4:k+=800;break}}function w(a){for(let b=0;b<a.shape.length;b++)for(let d=0;d<a.shape[b].length;d++){if(!a.shape[b][d])continue;let e=a.x+d,g=a.y+b;if(e<0||e>=c||g>=i||g>=0&&f[g*c+e])return!0}return!1}function af(h,i,j){const k=j!==void 0?j:f[i*c+h];const a=l+h*b;const d=m+i*b;if(k===2)try{g.setColor(F),g.drawImage(C(Q),a,d)}catch(a){console.log(a)}else g.setColor(e),z?g.drawRect(a,d,a+b-1,d+b-1):g.fillRect(a,d,a+b-1,d+b-1)}function P(a){g.setColor(e),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function u(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?B(a.x+d,a.y+c):af(a.x+d,a.y+c,a.shape[c][d]))}function V(){g.setColor(e);for(let a=0;a<i;a++)for(let b=0;b<c;b++)f[a*c+b]?af(b,a):B(b,a);x(),Y(),ah(),aw(),ax(),av()}function au(){const c=20;const a=d.x1-60;const b=d.y1+35;g.setColor(e),g.setFontMonofonto28(),g.drawString(a3,a,b),g.setColor(e),g.setFont('6x8',1),g.drawString('v'+ao,a,b+c)}function ag(){T();const a=M/2;const b=N/2;g.clear(),g.setColor(e),g.setFont('6x8',4),g.drawString('GAME OVER',a,b-100),g.setColor(j),g.setFont('6x8',2),g.drawString('Press    to RESTART',a,b-60);try{g.setColor(e),g.drawImage(C(a5),a-45,b-75)}catch(a){console.log(a)}const c=b-20;const d=18;g.setColor(e),g.setFont('6x8'),g.drawString('Score: '+k,a,c),g.drawString('Level: '+t,a,c+d),g.drawString('Lines: '+D,a,c+d*2),g.setColor(j),g.drawString('High Score: '+q,a,c+d*3+10),X(),W(),$(),n=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(n),n=null,an())},100)}function x(d){if(!(K&&a)||r)return;let c=d&&L?L:{x:a.x,y:a.y,shape:a.shape};if(!d){while(!w({x:c.x,y:c.y+1,shape:c.shape}))c.y++;L={x:c.x,y:c.y,shape:c.shape}}else if(!L)return;let e=d?h:j;g.setColor(e);for(let a=0;a<c.shape.length;a++)for(let f=0;f<c.shape[a].length;f++)if(c.shape[a][f]){const i=c.shape[a][f];const e=l+(c.x+f)*b;const h=m+(c.y+a)*b;if(!d&&i===2)try{g.setColor(aa),g.drawImage(C(Q),e,h,{scale:b/15,transparency:.5})}catch(a){console.log(a)}else z?g.drawRect(e,h,e+b-1,h+b-1):g.fillRect(e,h,e+b-1,h+b-1)}}function W(){g.setFont('6x8',1);const d=v.y2-40;const a=180;const f=d-22;const i={ON:'ON',OFF:'OFF'};const w=K?i.ON:i.OFF;const o=8;const p=2;g.setFont('6x'+o,p);const q=g.stringWidth(i.OFF);const r=o*p;const x={x1:a-q/2,y1:f-r/2,x2:a+q/2,y2:f+r};g.setColor(h),g.fillRect(x),g.setColor(e),g.drawString(w,a,f+4),g.setFont('6x8',1),g.setColor(j);const s='GHOST';const t=g.stringWidth(s);g.drawString(s,a,d);const b=5;const u=8;const k=a-t/2-u-1;const l=d;g.fillPoly([k,l-b,k-b,l+b,k+b,l+b]);const m=a+t/2+u;const n=d;const c=b-1;g.fillPoly([m,n+c,m-c,n-c,m+c,n-c])}function av(){const a=d.x2+65;const b=d.y1+100;const c=18;if(!a6){const d=100;const e=c*2+50+10;const f={x1:a-d/2-5,y1:b-10,x2:a+d/2,y2:b+e};g.setColor(h),g.fillRect(f);return}g.setFont('6x8',2),g.setColor(F),g.drawString('INCOMING',a,b),g.drawString('NUKE!',a,b+c);try{const d=50;const e=a-d/2;const f=b+c*2+5;g.setColor(aa),g.drawImage(C(ap),e,f)}catch(a){console.log(a)}}function aw(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const k=D.toString();const l=16;const f=80;const m=c+l+10;const n=a-f/2;const i=b+c-8;const o=a+f/2;const p=i+m;g.setColor(h),g.fillRect(n,i,o,p),g.setColor(j),g.drawString('LINES',a,b),g.setColor(e),g.drawString(k,a,b+c)}function ah(){const a=d.x1-65;const c=d.y2-120;const f=20;g.setFont('6x8',2);const i=t.toString();const k=g.stringWidth(i);const m=16;const b=4;const n=a-k/2-b;const l=c+f-b*2;const o=a+k/2+b;const p=l+m+b;g.setColor(h),g.fillRect(n,l,o,p),g.setColor(j),g.drawString('LEVEL',a,c),g.setColor(e),g.drawString(i,a,c+f)}function ax(){if(!p)return;const c=d.x2+65;const f=d.y1+25;const k=4*b;const i=6;const l=c-k/2-i;const m=f+15-i;const n=c+k/2+i;const o=f+15+k+i;g.setColor(h),g.fillRect(l,m,n,o),g.setFont('6x8',2),g.setColor(j),g.drawString('NEXT',c,f);const a=p.shape;const q=a[0].length*b;const r=c-q/2-2;for(let d=0;d<a.length;d++)for(let h=0;h<a[d].length;h++)if(a[d][h]){const j=a[d][h];const c=r+h*b;const i=f+20+d*b;if(j===2)try{const a=C(Q);g.setColor(F),g.drawImage(a,c,i,{scale:b/a.width})}catch(a){console.log(a)}else g.setColor(e),z?g.drawRect(c,i,c+b-1,i+b-1):g.fillRect(c,i,c+b-1,i+b-1)}}function X(){const c=v.y2-40;const d=300;const b=10;const o=A.length*b;const p=A[0].length*b;const f=c-o-10;const i=d-p/2;g.setFont('6x8',1),g.setColor(j);const q='TYPE';const r=g.stringWidth(q);g.drawString(q,d,c);const a=6;const s=10;const k=d-r/2-s;const l=c;g.fillPoly([k,l,k+a,l-a,k+a,l+a]);const m=d+r/2+s;const n=c;g.fillPoly([m,n,m-a,n-a,m-a,n+a]);const t={x1:i-2,y1:f-2,x2:i+p+2,y2:f+o+2};g.setColor(h),g.fillRect(t),g.setColor(e);for(let e=0;e<A.length;e++)for(let h=0;h<A[e].length;h++)if(A[e][h]){const a=i+h*b;const c=f+e*b;const d=a+b-1;const j=c+b-1;z?g.drawRect(a,c,d,j):g.fillRect(a,c,d,j)}}function Y(){const a=d.x2+65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const f=k.toString();const r=g.stringWidth(f);const m=16;const i=100;const n=c+m+10;const o=a-i/2;const l=b+c-8;const p=a+i/2;const q=l+n;g.setColor(h),g.fillRect(o,l,p,q),g.setColor(j),g.drawString('SCORE',a,b),g.setColor(e),g.drawString(f,a,b+c)}function ay(){T();const a=M/2;const b=N/2;g.clear(),g.setColor(e),g.setFontMonofonto36(),g.drawString(a3,a,b-50),g.setColor(j),g.setFont('6x8',2),g.drawString('Press    to START',a,b-15);try{g.setColor(e),g.drawImage(C(a5),a-34,b-29)}catch(a){console.log(a)}q>0&&(g.setColor(j),g.setFont('6x8'),g.drawString('High Score: '+q,a,b+35)),X(),W(),$()}function az(){if(!a||r)return;if(u(!0),a.y++,w(a)&&(a.y--,u(!1),ak(a),U(),a0(),w(a))){r=!0,clearInterval(o),setTimeout(ag,50);return}u(!1),P(d);const c=BTN_PLAY.read();const b=c?100:y;S!==b&&(clearInterval(o),o=setInterval(aj,b),S=b)}function aA(){if(!a||r)return;u(!0);while(!w(a))a.y++;a.y--,u(!1),ak(a),U(),V(),a0(),u(!1)}function B(a,c){g.setColor(h),g.fillRect(l+a*b,m+c*b,l+(a+1)*b-1,m+(c+1)*b-1)}function Z(b){b===void 0&&(b=!0);let a;while(!0){let c=Math.floor(Math.random()*ae.length);if(a=ae[c],!(!b&&a[0][0]===2))break}let d=Math.floor((c-a[0].length)/2);return{shape:a,x:d,y:0}}function aB(){_()}function aC(b){let a=Date.now();if(a-ab<ar)return;ab=a,b===0?aA():aJ(b)}function aD(){al(),clearInterval(o),E.reboot()}function aE(a){aG(a>0?1:-1)}function ai(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aF(){try{let a=fs.readFile(a4);if(!a)throw new Error('Config file missing');let b=JSON.parse(a);q=b.highScore||0,I=b.music||[]}catch(a){console.log(a),q=0,am()}}function C(a){try{let c=fs.readFile(a);let b=JSON.parse(c);return{bpp:b.bpp,buffer:atob(b.buffer),height:b.height,transparent:b.transparent,width:b.width}}catch(b){return console.log(a,b),null}}function aj(){az()}function ak(a){let b=!1;for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)if(a.shape[d][e]){const g=a.x+e;const h=a.y+d;if(!(isFinite(g)&&isFinite(h)))continue;a.shape[d][e]===2?g>=0&&g<c&&h>=0&&h<i&&(f[h*c+g]=0,aH(g,h),b=!0):f[h*c+g]=1}b&&U()}function aG(c){if(r||!a)return;x(!0);let b=a.x;if(a.x+=c,w(a)){a.x=b,x();return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&B(b+e,a.y+d);x(),u(!1),P(d)}function aH(e,j){if(J)return;if(J=!0,!(isFinite(e)&&isFinite(j))){J=!1;return}e=Math.max(0,Math.min(e,c-1)),j=Math.max(0,Math.min(j,i-1));let a={x1:l+(e-s)*b+1,y1:m+(j-s)*b+1,x2:l+(e+s+1)*b-2,y2:m+(j+s+1)*b-2};a.x1=Math.max(a.x1,d.x1+1),a.y1=Math.max(a.y1,d.y1+1),a.x2=Math.min(a.x2,d.x2-1),a.y2=Math.min(a.y2,d.y2-1),g.setColor(F),g.drawRect(a);let n=0;for(let b=-s;b<=s;b++)for(let d=-s;d<=s;d++){let a=e+d;let g=j+b;a>=0&&a<c&&g>=0&&g<i&&f[g*c+a]&&(f[g*c+a]=0,B(a,g),n++)}let o=n*aq;k+=o,Y(),g.setColor(h),g.fillRect(a),as(),J=!1}function _(){if(!I.length){console.log('No music tracks available');return}const a=I[Math.floor(Math.random()*I.length)];if(a===ad)return _();Pip.audioStop(),Pip.audioStart(a),ad=a}function aI(){f.fill(0),g.setColor(h),g.fillRect(l,m,l+c*b-1,m+i*b-1)}function aJ(f){if(r||!a)return;x(!0);const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,w(a)){a.shape=c,x();return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&B(a.x+g,a.y+d);u(!1),x(),P(d)}function al(){Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.removeAllListeners(O),Pip.removeAllListeners(ac)}function am(){let a={highScore:q,music:I};try{fs.writeFile(a4,JSON.stringify(a))}catch(a){console.log(a)}}function aK(){Pip.on(G,aC),Pip.on(H,aE),Pip.on(O,ai),Pip.on(ac,aB)}function $(){Pip.removeAllListeners(G),Pip.removeAllListeners(H),Pip.on(G,aL),Pip.on(H,a1)}function a0(){p||(p=Z()),a=p,p=Z(),a6=p.shape.some(a=>a.includes(2)),V(),w(a)&&(r=!0,at(),clearInterval(o),setTimeout(()=>{ag()},50))}function an(){n&&(clearInterval(n),n=null),o&&(clearInterval(o),o=null),al(),_(),r=!1,a=null,t=0,k=0,D=t*a9,y=Math.max(R-t*a8,a7),S=y,p=Z(!1),T(),aI(),ah(),Y(),P(d),a0(),V(),au(),aK(),o=setInterval(aj,y)}function aL(){K=!K,W()}function a1(){z=!z,X()}function aM(){let a=Math.floor(D/a9);a>t&&(t=a,y=Math.max(R-t*a8,a7))}const a2={};const a3='PIPTRIS';const ao='2.6.0';const a4='USER/PIPTRIS/piptris.json';const a5='USER/PIPTRIS/gear.json';const Q='USER/PIPTRIS/nuke.json';const ap='USER/PIPTRIS/radioactive.json';const R=800;let a=null;let y=R;let p=null;let b=15;let S=y;let q=0;let n=null;let r=!1;let D=0;let o=null;let k=0;let z=!1;const aq=10;const s=2;let J=!1;let a6=!1;let K=!1;let L=null;let t=0;const a7=100;const a8=50;const a9=10;const M=g.getWidth();const N=g.getHeight();const v={x1:60,x2:M-60,y1:10,y2:N-10};const h='#000000';const F='#FF0000';const aa=g.blendColor(h,F,.5);const e=g.theme.fg;const j=g.blendColor(h,e,.5);const c=10;const i=20;const f=new Uint8Array(c*i);const l=(v.x1+v.x2)/2-b*c/2;const m=v.y1+(v.y2-v.y1)/2-b*i/2;const d={x1:l-1,y1:m-1,x2:l+c*b,y2:m+i*b};const G='knob1';const H='knob2';const O='torch';const ar=30;let ab=0;const ac='audioStopped';let I=[];let ad=null;const A=[[0,1,0],[1,1,1]];const ae=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],A,[[1,1],[1,1]],[[2]]];return a2.run=function(){aF(),ay(),$(),Pip.on(O,ai),n=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(n),n=null,Pip.removeListener(G,a1),Pip.removeListener(H,a1),Pip.removeAllListeners(O),an())},100),setWatch(()=>aD(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},a2}Piptris().run()