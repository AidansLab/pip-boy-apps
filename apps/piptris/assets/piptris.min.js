function Piptris(){function ao(){for(let a=h-2;a>=0;a--)for(let c=0;c<b;c++)if(e[a*b+c]){let d=a;while(d+1<h&&!e[(d+1)*b+c])e[(d+1)*b+c]=e[d*b+c],e[d*b+c]=0,d++}}function ap(){j>t&&(t=j,ad())}function N(){g.setColor(i),g.fillRect(0,0,F,G)}function O(){let a=0;let c=0;const d=h;while(c++<d){let c=!1;for(let f=h-1;f>=0;f--){let d=!0;for(let g=0;g<b;g++)if(!e[f*b+g]){d=!1;break}if(d){for(let e=0;e<b;e++)x(e,f);for(let g=f;g>0;g--)for(let f=0;f<b;f++)e[g*b+f]=e[(g-1)*b+f];for(let f=0;f<b;f++)e[f]=0;a++,y++,aH(),c=!0;break}}if(!c)break}switch(a){case 1:j+=100;break;case 2:j+=300;break;case 3:j+=500;break;case 4:j+=800;break}}function w(a){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++){if(!a.shape[c][d])continue;let f=a.x+d,g=a.y+c;if(f<0||f>=b||g>=h||g>=0&&e[g*b+f])return!0}return!1}function a6(i,j,k){const a=k!==void 0?k:e[j*b+i];const d=m+i*c;const h=n+j*c;if(a===2){try{g.setColor(A),g.drawImage(L,d,h)}catch(a){console.log(a)}return}a&&(g.setColor(f),g.drawImage(M,d,h))}function I(a){g.setColor(f),g.drawRect(a.x1,a.y1,a.x2,a.y2)}function s(b){for(let c=0;c<a.shape.length;c++)for(let d=0;d<a.shape[c].length;d++)a.shape[c][d]&&(b?x(a.x+d,a.y+c):a6(a.x+d,a.y+c,a.shape[c][d]))}function P(){g.setColor(f);for(let a=0;a<h;a++)for(let c=0;c<b;c++)e[a*b+c]?a6(c,a):x(c,a);Q(),a8(),as(),at(),ar()}function aq(){const c=20;const a=d.x1-60;const b=d.y1+35;g.setColor(f),g.setFontMonofonto28(),g.setFontAlign(0,0),g.drawString(V,a,b),g.setColor(f),g.setFont('6x8',1),g.setFontAlign(0,0),g.drawString('v'+af,a,b+c)}function a7(){N();const a=F/2;const b=G/2;g.clear(),g.setColor(f),g.setFont('6x8',4),g.setFontAlign(0,0),g.drawString('GAME OVER',a,b-100),g.setColor(r),g.setFont('6x8',2),g.setFontAlign(0,0),g.drawString('Press    to RESTART',a,b-60);try{g.setColor(f),g.drawImage(C(X),a-45,b-75)}catch(a){console.log(a)}const c=b-20;const d=18;g.setColor(f),g.setFont('6x8'),g.setFontAlign(0,0),g.drawString('Score: '+j,a,c),g.drawString('Level: '+q,a,c+d),g.drawString('Lines: '+y,a,c+d*2),g.setColor(r),g.drawString('High Score: '+t,a,c+d*3+10),k=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(k),k=null,ae())},100)}function ar(){const a=d.x2+65;const b=d.y1+100;const c=18;if(!Y){const d=100;const e=c*2+50+10;const f={x1:a-d/2-5,y1:b-10,x2:a+d/2,y2:b+e};g.setColor(i),g.fillRect(f);return}g.setFont('6x8',2),g.setColor(A),g.setFontAlign(0,0),g.drawString('INCOMING',a,b),g.drawString('NUKE!',a,b+c);try{const d=50;const e=a-d/2;const f=b+c*2+5;g.setColor(al),g.drawImage(C(ai),e,f)}catch(a){console.log(a)}}function as(){const a=d.x1-65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const j=y.toString();const k=16;const e=80;const l=c+k+10;const m=a-e/2;const h=b+c-8;const n=a+e/2;const o=h+l;g.setColor(i),g.fillRect(m,h,n,o),g.setColor(r),g.setFontAlign(0,0),g.drawString('LINES',a,b),g.setColor(f),g.setFontAlign(0,0),g.drawString(j,a,b+c)}function a8(){const a=d.x1-65;const c=d.y2-120;const e=20;g.setFont('6x8',2);const h=q.toString();const j=g.stringWidth(h);const l=16;const b=4;const m=a-j/2-b;const k=c+e-b*2;const n=a+j/2+b;const o=k+l+b;g.setColor(i),g.fillRect(m,k,n,o),g.setColor(r),g.setFontAlign(0,0),g.drawString('LEVEL',a,c),g.setColor(f),g.setFontAlign(0,0),g.drawString(h,a,c+e)}function at(){if(!o)return;const b=d.x2+65;const e=d.y1+25;const j=4*c;const h=6;const k=b-j/2-h;const l=e+c-h;const m=b+j/2+h;const n=e+15+j+h;g.setColor(i),g.fillRect(k,l,m,n),g.setFont('6x8',2),g.setColor(r),g.setFontAlign(0,0),g.drawString('NEXT',b,e);const a=o.shape;const p=a[0].length*c;const q=b-p/2-2;const s=e+20;for(let d=0;d<a.length;d++)for(let i=0;i<a[d].length;i++)if(a[d][i]){const h=a[d][i];const b=q+i*c;const e=s+d*c;h===2?(g.setColor(A),g.drawImage(L,b,e)):(g.setColor(f),g.drawImage(M,b,e))}}function Q(){const a=d.x2+65;const b=d.y2-60;const c=20;g.setFont('6x8',2);const e=j.toString();const q=g.stringWidth(e);const l=16;const h=100;const m=c+l+10;const n=a-h/2;const k=b+c-8;const o=a+h/2;const p=k+m;g.setColor(i),g.fillRect(n,k,o,p),g.setColor(r),g.setFontAlign(0,0),g.drawString('SCORE',a,b),g.setColor(f),g.setFontAlign(0,0),g.drawString(e,a,b+c)}function au(){N();const a=F/2;const b=G/2;g.clear(),g.setColor(f),g.setFontMonofonto36(),g.setFontAlign(0,0),g.drawString(V,a,b-50),g.setColor(r),g.setFont('6x8',2),g.setFontAlign(0,0),g.drawString('Press    to START',a,b-15),g.setColor(f),g.drawImage(C(X),a-34,b-29),g.setColor(r),g.setFont('6x8'),g.setFontAlign(0,0),g.drawString('High Score: '+t,a,b+35)}function av(){if(!a||u)return;if(s(!0),a.y++,w(a)&&(a.y--,s(!1),ab(a),O(),T(),w(a))){u=!0,clearInterval(l),setTimeout(a7,50);return}s(!1),I(d);const c=BTN_PLAY.read();const b=c?100:v;K!==b&&(clearInterval(l),l=setInterval(aa,b),K=b)}function aw(){if(!a||u)return;s(!0);while(!w(a))a.y++;a.y--,s(!1),ab(a),O(),P(),T(),s(!1)}function x(a,b){g.setColor(i),g.fillRect(m+a*c,n+b*c,m+(a+1)*c-1,n+(b+1)*c-1)}function R(c){c===void 0&&(c=!0);let a;while(!0){let b=Math.floor(Math.random()*a5.length);if(a=a5[b],a[0][0]===2){if(!c)continue;if(Math.random()<.5)continue}break}let d=Math.floor((b-a[0].length)/2);return{shape:a,x:d,y:0}}function ax(){S()}function ay(b){let a=Date.now();if(a-a2<am)return;a2=a,b===0?aw():aF(b)}function az(){ac(),clearInterval(l),E.reboot()}function aA(a){aC(a>0?1:-1)}function a9(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aB(){try{let a=fs.readFile(W);if(!a)throw new Error('Config file missing');let b=JSON.parse(a);t=b.highScore||0,B=b.music||[]}catch(a){console.log(a),t=0,ad()}}function C(a){try{let c=fs.readFile(a);let b=JSON.parse(c);return{bpp:b.bpp,buffer:atob(b.buffer),height:b.height,transparent:b.transparent,width:b.width}}catch(b){return console.log(a,b),null}}function aa(){av()}function ab(a){let c=!1;for(let d=0;d<a.shape.length;d++)for(let f=0;f<a.shape[d].length;f++)if(a.shape[d][f]){const g=a.x+f;const i=a.y+d;if(!(isFinite(g)&&isFinite(i)))continue;a.shape[d][f]===2?g>=0&&g<b&&i>=0&&i<h&&(e[i*b+g]=0,aD(g,i),c=!0):e[i*b+g]=1}c&&O()}function aC(c){if(u||!a)return;let b=a.x;if(a.x+=c,w(a)){a.x=b;return}for(let d=0;d<a.shape.length;d++)for(let e=0;e<a.shape[d].length;e++)a.shape[d][e]&&x(b+e,a.y+d);s(!1),I(d)}function aD(f,k){if(D)return;if(D=!0,!(isFinite(f)&&isFinite(k))){D=!1;return}f=Math.max(0,Math.min(f,b-1)),k=Math.max(0,Math.min(k,h-1));let a={x1:m+(f-p)*c+1,y1:n+(k-p)*c+1,x2:m+(f+p+1)*c-2,y2:n+(k+p+1)*c-2};a.x1=Math.max(a.x1,d.x1+1),a.y1=Math.max(a.y1,d.y1+1),a.x2=Math.min(a.x2,d.x2-1),a.y2=Math.min(a.y2,d.y2-1),g.setColor(A),g.drawRect(a);let l=0;for(let c=-p;c<=p;c++)for(let d=-p;d<=p;d++){let a=f+d;let g=k+c;a>=0&&a<b&&g>=0&&g<h&&e[g*b+a]&&(e[g*b+a]=0,x(a,g),l++)}let o=l*aj;j+=o,Q(),g.setColor(i),g.fillRect(a),ao(),D=!1}function S(){if(!B.length){console.log('No music tracks available');return}const a=B[Math.floor(Math.random()*B.length)];if(a===a4)return S();Pip.audioStop(),Pip.audioStart(a),a4=a}function aE(){e.fill(0),g.setColor(i),g.fillRect(m,n,m+b*c-1,n+h*c-1)}function aF(f){if(u||!a)return;const b=a.shape;const e=f>0?b[0].map((c,a)=>b.map(b=>b[b.length-1-a])):b[0].map((c,a)=>b.map(b=>b[a]).reverse());const c=a.shape;if(a.shape=e,w(a)){a.shape=c;return}for(let d=0;d<c.length;d++)for(let g=0;g<c[d].length;g++)c[d][g]&&x(a.x+g,a.y+d);s(!1),I(d)}function ac(){Pip.removeAllListeners(a0),Pip.removeAllListeners(a1),Pip.removeAllListeners(H),Pip.removeAllListeners(a3)}function ad(){let a={highScore:t,music:B};try{fs.writeFile(W,JSON.stringify(a))}catch(a){console.log(a)}}function aG(){Pip.on(a0,ay),Pip.on(a1,aA),Pip.on(H,a9),Pip.on(a3,ax)}function T(){o||(o=R()),a=o,o=R(),Y=o.shape.some(a=>a.includes(2)),P(),w(a)&&(u=!0,ap(),clearInterval(l),setTimeout(()=>{a7()},50))}function ae(){k&&(clearInterval(k),k=null),l&&(clearInterval(l),l=null),ac(),S(),u=!1,a=null,q=0,j=0,y=q*$,v=Math.max(J-q*_,Z),K=v,o=R(!1),N(),aE(),a8(),Q(),I(d),T(),P(),aq(),aG(),l=setInterval(aa,v)}function aH(){let a=Math.floor(y/$);a>q&&(q=a,v=Math.max(J-q*_,Z))}const U={};const V='PIPTRIS';const af='3.1.0';const ag='USER/PIPTRIS/block.json';const W='USER/PIPTRIS/piptris.json';const X='USER/PIPTRIS/gear.json';const ah='USER/PIPTRIS/nuke.json';const ai='USER/PIPTRIS/radioactive.json';const J=800;const c=15;let a=null;let v=J;let o=null;let K=v;let t=0;let k=null;let u=!1;let y=0;let l=null;let j=0;const aj=10;const p=2;let D=!1;let Y=!1;let L=null;let q=0;const Z=100;const _=50;const $=10;const F=g.getWidth();const G=g.getHeight();const z={x1:60,x2:F-60,y1:10,y2:G-10};const i='#000000';const A='#FF0000';const ak='#FFFFFF';const al=g.blendColor(i,A,.5);const f=g.theme.fg;const r=g.blendColor(i,f,.5);const aI=g.blendColor(f,ak,.3);const b=10;const h=20;const e=new Uint8Array(b*h);const m=(z.x1+z.x2)/2-c*b/2;const n=z.y1+(z.y2-z.y1)/2-c*h/2;const d={x1:m-1,y1:n-1,x2:m+b*c,y2:n+h*c};const a0='knob1';const a1='knob2';const H='torch';const am=30;let a2=0;const a3='audioStopped';let B=[];let a4=null;let M=null;const an=[[0,1,0],[1,1,1]];const a5=[[[1,1,1,1]],[[1,1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],an,[[1,1],[1,1]],[[2]]];return U.run=function(){aB(),M=C(ag),L=C(ah),au(),Pip.on(H,a9),k=setInterval(()=>{BTN_PLAY.read()&&(clearInterval(k),k=null,Pip.removeAllListeners(H),ae())},100),setWatch(()=>az(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},U}Piptris().run()