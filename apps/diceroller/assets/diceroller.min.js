function DiceRoller(){function N(){const l=e[c];const j=l==='D2';const d=30;const g=5;j?(a.x=(b.x1+b.x2)/2,a.y=(b.y1+b.y2)/2):(a.x+=a.vx,a.y+=a.vy,(a.x<b.x1+d+g||a.x>b.x2-d-g)&&(a.vx=-a.vx*v,a.x=Math.max(b.x1+d+g,Math.min(a.x,b.x2-d-g))),(a.y<b.y1+d+g||a.y>b.y2-d-g)&&(a.vy=-a.vy*v,a.y=Math.max(b.y1+d+g,Math.min(a.y,b.y2-d-g))),a.vx*=w,a.vy*=w);const o=Math.sqrt(a.vx*a.vx+a.vy*a.vy);const p=s(l);f&&clearTimeout(f);const r=Math.max(50,600-o*80);f=setTimeout(()=>{i=j?k%2+1:Math.floor(Math.random()*p)+1,m()},r),k++,m(),(k>=40||o<.5)&&(h&&clearInterval(h),f&&clearTimeout(f),j?(k%2===0&&k++,i=Math.random()<.5?1:2,Pip.audioStart(q.coinDrop)):i=Math.floor(Math.random()*p)+1,m(),n=!1)}function O(){h&&clearInterval(h),f&&clearTimeout(f),h=null,f=null}function r(){g.setColor(p),g.fillRect(0,0,y,z)}function F(a){g.setColor(l).drawRect(a.x1,a.y1,a.x2,a.y2)}function m(){g.setColor(p),g.fillRect(j.x,j.y,j.x+j.w,j.y+j.h);const f=60;const b=f/2;const h=e[c];let d=i.toString();const m=h==='D2';const o=k%2;if(g.setColor(l),m)n&&o===0?(g.fillRect(a.x-b,a.y-2,a.x+b,a.y+2),d=''):(g.drawCircle(a.x,a.y,b),d=i===1?'H':'T');else{const c=P(h);const d=[];for(let e=0;e<c;e++){const f=Math.PI/2+e*Math.PI*2/c;d.push([a.x+b*Math.cos(f),a.y+b*Math.sin(f)])}for(let a=0;a<c;a++){const b=d[a];const e=d[(a+1)%c];g.drawLine(b[0],b[1],e[0],e[1])}}if(d){g.setFont('6x8',3),g.setFontAlign(-1,-1,0);const b=g.stringWidth(d);const c=g.getFontHeight();g.drawString(d,a.x-b/2+2,a.y-c/2)}j={x:a.x-b-2,y:a.y-b-2,w:f+4,h:f+4}}function G(){const a=e[c];g.setColor(l).setFontMonofonto23().setFontAlign(1,-1,0).drawString(a,d.x2-5,d.y1+5)}function H(){g.setColor(l).setFontMonofonto23().setFontAlign(-1,-1,0).drawString(u,d.x1+5,d.y1+5);const a=g.stringWidth(u);g.setColor(M).setFontMonofonto16().setFontAlign(-1,-1,0).drawString('v'+J,d.x1+10+a,d.y1+5+8)}function P(a){switch(a){case'D2':return 0;case'D4':return 3;case'D6':return 4;case'D8':return 5;case'D10':return 6;case'D12':return 7;case'D20':return 8;case'D100':return 10;default:throw new Error(`Unknown dice type: ${a}`)}}function s(a){return parseInt(a.substring(1))}function Q(a){I()}function R(){I()}function S(){O(),r(),V(),clearInterval(o),o=null,E.reboot()}function T(a){if(n)return;c+=a,c<0&&(c=e.length-1),c>=e.length&&(c=0),i=Math.floor(Math.random()*s(e[c]))+1,r(),G(),H(),F(b),m()}function U(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function V(){Pip.removeAllListeners(A),Pip.removeAllListeners(B),Pip.removeAllListeners(C)}function I(){let b=Date.now();if(b-D<L)return;D=b,n=!0;const f=s(e[c]);i=Math.floor(Math.random()*f)+1,a.vx=(Math.random()*6-3)*x,a.vy=(Math.random()*6-3)*x,k=0,h&&clearInterval(h);const g=e[c]==='D2';let d=100;g?(d=150,Pip.audioStart(q.coinFlip)):Pip.audioStart(q.diceThrow),h=setInterval(N,d)}function W(){Pip.on(A,Q),Pip.on(B,T),Pip.on(C,U)}const t={};const u='Dice Roller';const J='1.2.1';const e=['D2','D4','D6','D8','D10','D12','D20','D100'];const v=.95;const w=.98;const x=8;let c=e.indexOf('D20');let a={x:100,y:100,vx:2,vy:3};let i=1;let f=null;let o=null;let h=null;let n=!1;let j={x:0,y:0,w:0,h:0};let k=0;const y=g.getWidth();const z=g.getHeight();const d={x1:60,x2:y-60,y1:10,y2:z-10};const K=35;const b={x1:d.x1,x2:d.x2,y1:d.y1+K,y2:d.y2};const A='knob1';const B='knob2';const C='torch';const L=250;let D=0;const p='#000000';const l=g.theme.fg;const M=g.blendColor(p,l,.5);const q={coinDrop:'USER/DICE_ROLLER/coin-drop.wav',coinFlip:'USER/DICE_ROLLER/coin-flip.wav',diceThrow:'USER/DICE_ROLLER/dice-throw.wav'};return t.run=function(){r(),W(),H(),G(),F(b),m(),o=setInterval(()=>{BTN_PLAY.read()&&R()},100),setWatch(S,BTN_POWER,{debounce:50,edge:'rising',repeat:!0})},t}DiceRoller().run()