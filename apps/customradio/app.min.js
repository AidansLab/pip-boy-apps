function CustomRadio(){function M(){u&&clearInterval(u),u=null}function y(){g.setColor(K).fillRect(m)}function _(){o&&clearInterval(o),o=null,k=null,e&&(e=null,E.defrag())}function s(){if(V===!1)return;t(a),t(b),t(m),t(W),t(p),O()}function $(){const d=R.toUpperCase();const e='v'+S;const c=5;const f=g.stringWidth(d);g.setColor(l).setFontAlign(-1,-1,0).setFontMonofonto16().drawString(d,b.x1,a.y1+8),g.setColor(v).setFontAlign(-1,-1,0).setFont('6x8').drawString(e,b.x1+f+c,a.y1+16),g.setColor(L).drawLine(b.x1,b.y1-c,b.x2,b.y1-c)}function t(a){g.setColor(L).drawRect(a.x1,a.y1,a.x2,a.y2)}function a0(){M(),u=setInterval(()=>{drawFooter()},Z)}function a1(b){if(!b)throw new Error('No song provided to drawNowPlaying');const a=b.replace(/\.wav$/i,'');const c=a.length>19?a.slice(0,16)+'...':a;g.setColor(l).setFontAlign(1,-1,0).setFontMonofonto16().drawString(c,m.x2,m.y1+20)}function a2(){g.setColor(v).setFontAlign(1,1,0).setFont('6x8').drawString('Now Playing',m.x2,m.y1+15)}function N(){const a=h*j;const f=c.slice(a,a+j);g.setColor(K).fillRect(b),g.setFontMonofonto16().setFontAlign(-1,-1,0);const e=5;const i=20;f.forEach((j,c)=>{const f=b.y1+c*i+e;const a=j.replace(/\.wav$/i,'');const h=a.length>19?a.slice(0,16)+'...':a;g.setColor(c===d?l:v).drawString(h,b.x1+e,f,!0)}),s()}function O(){const d=5;const h=3;const e=p.x1;const c=p.y1;const b=p.x2;const i=p.y2;const a=i-1;const f=b;for(let j=0;j<40;j++){const k=j%d===0?l:v;const b=j%d===0?2:1;const i=e+j*h;const m=a-b;g.setColor(k),g.drawLine(i,m,i,a),g.drawLine(f-b,c+j*3,f,c+j*3)}g.setColor(l),g.drawLine(e,a,b,a),g.drawLine(b,a,b,c)}function a3(){x=0,e=Graphics.createArrayBuffer(120,120,2,{msb:!0}),E.getAddressOf(e,0)===0&&(e=undefined,E.defrag(),e=Graphics.createArrayBuffer(120,120,2,{msb:!0})),k=new Uint16Array(60);for(let a=0;a<60;a+=2)k[a]=a*2;o&&clearInterval(o),o=setInterval(()=>{if(!e)return;if(e.clearRect(0,0,119,119),Pip.radioClipPlaying)Pip.getAudioWaveform(k,20,100);else if(Pip.radioOn&&(typeof RADIO_AUDIO)[0]!='u')for(let a=1;a<60;a+=2)k[a]=E.clip(60+(analogRead(RADIO_AUDIO)-.263)*600,0,119);else{let a=x;for(let b=1;b<60;b+=2)k[b]=60+Math.sin(a)*45*Math.sin((a+=.6)*.13)}e.drawPolyAA(k),x+=.3,Pip.blitImage(e,285,75,{noScanEffect:!0})},Y)}function a4(e){let b=Date.now();if(b-H<X)return;if(H=b,e!==0)return P(e*-1);const g=h*j;const a=c[g+d];if(!a)return;const k='/'+J+a;a==='RANDOM'?n?(n=!1,w()):i!==null?(n=!0,f='RANDOM',w()):(n=!0,q=c.slice(1).sort(()=>Math.random()-.5),r=0,z()):i===k?(f=null,w()):(n=!1,f=a,i!==null?w():(A(f),f=null))}function a5(){M(),_(),Q(),settings.idleTimeout=C,bC.clear(1).flip(),E.reboot()}function a6(a){P(a)}function a7(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function a8(){if(n)z();else if(f){const a=f;f=null,a==='RANDOM'?(q=c.slice(1).sort(()=>Math.random()-.5),r=0,z()):A(a)}else i=null,Pip.radioClipPlaying=!1,y(),s()}function a9(){try{c=fs.readdir('/RADIO').filter(a=>a.endsWith('.wav')).sort(),print('Loaded '+c.length+' songs:'),c.unshift('RANDOM')}catch(a){print('Failed to load songs:',a),c=[]}h=0,d=0,N()}function P(f){const a=h*j;const b=c.slice(a,a+j);const e=Math.floor((c.length-1)/j);d+=f,d<0?h>0?(h--,d=j-1):d=0:d>=b.length&&(h<e?(h++,d=0):d=b.length-1),N()}function z(){r>=q.length&&(q=c.slice(1).sort(()=>Math.random()-.5),r=0),A(q[r++])}function A(a){i='/'+J+a,Pip.audioStart(i),Pip.radioClipPlaying=!0,y(),a2(),a1(a),s()}function Q(){Pip.removeAllListeners(D),Pip.removeAllListeners(F),Pip.removeAllListeners(G),Pip.removeAllListeners(I)}function aa(){Pip.on(D,a4),Pip.on(F,a6),Pip.on(G,a7),Pip.on(I,a8),setWatch(()=>a5(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function w(){Pip.audioStop(),i=null,Pip.radioClipPlaying=!1,y(),s()}const B={};const R='Custom Radio';const S='3.2.0';const T=g.getWidth();const U=g.getHeight();const V=!1;let C=settings.idleTimeout;const a={x1:60,y1:40,x2:T-60,y2:U-20};const b={x1:a.x1+10,y1:a.y1+30,x2:(a.x2+a.x1)/2,y2:a.y2-20};const W={x1:b.x2+10,y1:a.y1+30,x2:a.x2-10,y2:a.y2-20};const m={x1:b.x2+10,y1:a.y2-100,x2:a.x2-10,y2:a.y2-60};const p={x1:b.x2+45,y1:a.y1+37,x2:a.x2-12,y2:a.y2-101};const D='knob1';const F='knob2';const G='torch';const X=10;let H=0;const I='audioStopped';const J='RADIO/';let i=null;let f=null;const j=10;let h=0;let d=0;let c=[];let n=!1;let q=[];let r=0;const Y=50;let x=0;let e=null;let o=null;let k=null;const Z=49.99923706054;let u=null;const K='#000000';const l=g.theme.fg;const v=g.blendColor('#000',l,.5);const L=g.blendColor('#000',l,.75);return B.run=function(){C=settings.idleTimeout,settings.idleTimeout=0,bC.clear(1).flip(),Pip.mode=MODE.RADIO,drawHeader(Pip.mode),Q(),aa(),a9(),a3(),O(),$(),a0(),s()},B}CustomRadio().run()