function CustomRadio(){function U(){y&&clearInterval(y),y=null}function u(){g.setColor(S).fillRect(o)}function af(){q&&clearInterval(q),q=null,r=null,f&&(f=null,E.defrag())}function s(){if(a8===!1)return;g.setColor(T),g.drawRect(a),g.drawRect(b),g.drawRect(o),g.drawRect(a9),g.drawRect(t),Y()}function ag(){const d=a4.toUpperCase();const e='v'+a5;const c=5;const f=g.stringWidth(d);g.setColor(n).setFontAlign(-1,-1,0).setFontMonofonto16().drawString(d,b.x1,a.y1+8),g.setColor(z).setFontAlign(-1,-1,0).setFont('6x8').drawString(e,b.x1+f+c,a.y1+16),g.setColor(T).drawLine(b.x1,b.y1-c,b.x2,b.y1-c)}function ah(){U(),y=setInterval(drawFooter,ad)}function V(d){let b=d.name;let c=n;d.type==='ptl'&&(b='FILE PATH TOO LONG!',c=C);const a=b.replace(/\.wav$/i,'');const e=a.length>21?a.slice(0,18)+'...':a;g.setColor(c).setFontAlign(1,-1,0).setFont('6x8').drawString(e,o.x2,o.y1+20)}function W(){g.setColor(z).setFontAlign(1,1,0).setFont('6x8').drawString('Now Playing',o.x2,o.y1+15)}function X(){const f=j*l;const h=c.slice(f,f+l);g.setColor(S).fillRect(b),g.setFontMonofonto16().setFontAlign(-1,-1,0);const a=4;const e=4;const i=5;const k=20;h.forEach((f,m)=>{const h=b.y1+m*k+i;let l=ak(f);let j=z;f.type==='ptl'?m===d?j=C:j=ae:m===d&&(j=n),g.setColor(j);let c=b.x1;f.type==='folder'?(g.drawImage(N,c,h+a),c+=N.width+e):f.type==='up'?(g.drawImage(O,c,h+a),c+=O.width+e):f.type==='file'?(g.drawImage(P,c,h+a),c+=P.width+e):f.type==='ptl'?(g.drawImage(Q,c,h+a),c+=Q.width+e):f.type==='random'&&(g.drawImage(R,c,h+a),c+=R.width+e);const o=b.x2-2-c;l=aj(l,o),g.drawString(l,c,h,!0)}),s()}function Y(){const d=5;const h=3;const e=t.x1-H;const c=t.y1;const b=t.x2;const i=t.y2;const a=i-1;const f=b;for(let j=0;j<40;j++){const k=j%d===0?n:z;const b=j%d===0?2:1;const i=e+j*h;const l=a-b;g.setColor(k),g.drawLine(i,l,i,a),g.drawLine(f-b,c+j*3,f,c+j*3)}g.setColor(n),g.drawLine(e,a,b,a),g.drawLine(b,a,b,c)}function ai(){B=0,f=Graphics.createArrayBuffer(120,120,2,{msb:!0}),E.getAddressOf(f,0)===0&&(f=undefined,E.defrag(),f=Graphics.createArrayBuffer(120,120,2,{msb:!0})),r=new Uint16Array(60);for(let a=0;a<60;a+=2)r[a]=a*2;q&&clearInterval(q),q=setInterval(()=>{if(!f)return;if(f.clearRect(0,0,119,119),Pip.radioClipPlaying)Pip.getAudioWaveform(r,20,100);else{let a=B;for(let b=1;b<60;b+=2)r[b]=60+Math.sin(a)*45*Math.sin((a+=.6)*.13)}f.drawPolyAA(r),B+=.3,Pip.blitImage(f,285,75,{noScanEffect:!0})},ac)}function aj(a,f){if(g.stringWidth(a)<=f)return a;const d='...';const h=g.stringWidth(d);let b=0;let c=a.length;let e=0;while(b<=c){const d=b+c>>1;const i=a.slice(0,d);g.stringWidth(i)+h<=f?(e=d,b=d+1):c=d-1}return a.slice(0,e)+d}function ak(b){let a=b.name;return b.type!=='folder'&&(a=a.replace(/\.wav$/i,'')),a}function al(b){const a=b.lastIndexOf('/');return a<=0?A:b.slice(0,a)}function am(f){const b=Date.now();if(b-L<aa)return;if(L=b,f!==0)return $(f*-1);const g=j*l;const a=c[g+d];if(!a)return;if(a.type==='random'){h?(h=!1,w()):k!==null?(h=!0,e='RANDOM',w()):a3();return}if(a.type==='ptl'){h=!1,e=null,k=null,Pip.radioClipPlaying=!1,w(),u(),W(),V(a),s();return}if(a.type==='up'){a0(al(i));return}if(a.type==='folder'){a0(v(i,a.name));return}if(a.type==='file'){const b='/'+v(i,a.name);k===b?(e=null,w()):(h=!1,k!==null?(e=a,w()):D(a));return}}function an(){U(),af(),a2(),settings.idleTimeout=G,E.reboot()}function ao(a){$(a)}function ap(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function aq(a){try{return fs.readdir('/'+a),!0}catch(a){return!1}}function Z(a,b){return('/'+v(a,b)).length>ab}function _(g){let a=g||i;at();let b=[];try{b=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(c){print('Failed to read dir:',a,c),b=[]}const e=[];const f=[];for(let c=0;c<b.length;c++){const d=b[c];const g=v(a,d);aq(g)?e.push(d):/\.wav$/i.test(d)&&f.push(d)}c.push({type:'random',name:'RANDOM'}),a!==A&&c.push({type:'up',name:'BACK'}),e.forEach(b=>{Z(a,b)?c.push({name:b,type:'ptl'}):c.push({name:b,type:'folder'})}),f.forEach(b=>{Z(a,b)?c.push({name:b,type:'ptl'}):c.push({type:'file',name:b})}),p=c.filter(a=>a.type==='file'),print('Loaded folder '+a+': '+f.length+' songs, '+e.length+' folders.'),j=0,d=0,X()}function $(f){const a=j*l;const b=c.slice(a,a+l);const e=Math.floor((c.length-1)/l);d+=f,d<0?j>0?(j--,d=l-1):d=0:d>=b.length&&(j<e?(j++,d=0):d=b.length-1),X()}function a0(a){h=!1,e=null,i=a,_(i)}function ar(){if(k=null,Pip.radioClipPlaying=!1,h){a1();return}if(e==='RANDOM'){e=null,a3();return}if(e){const a=e;e=null,D(a);return}u(),s()}function v(a,b){return a?b?a+'/'+b:a:b}function D(a){try{const b='/'+v(i,a.name);k=b,Pip.audioStart(b),Pip.radioClipPlaying=!0,u(),W(),V(a)}catch(a){log('Error playing audio:',a),u(),Pip.radioClipPlaying=!1}s()}function a1(){if(!p.length){h=!1;return}(!m||x>=m.length)&&(m=p.slice().sort(()=>Math.random()-.5),x=0),D(m[x++])}function a2(){Pip.removeAllListeners(I),Pip.removeAllListeners(J),Pip.removeAllListeners(K),Pip.removeAllListeners(M)}function as(){Pip.on(I,am),Pip.on(J,ao),Pip.on(K,ap),Pip.on(M,ar),setWatch(()=>an(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function a3(){h=!0,m=p.slice().sort(()=>Math.random()-.5),x=0,a1()}function w(){Pip.audioStop(),k=null,Pip.radioClipPlaying=!1,u(),s()}function at(){c=null,p=null,m=null,c=[],p=[],m=[]}const F={};const a4='Custom Radio';const a5='3.3.2';const a6=g.getWidth();const a7=g.getHeight();const a8=!1;let G=settings.idleTimeout;const H=40;const a={x1:60,y1:40,x2:a6-60,y2:a7-20};const b={x1:a.x1+10,y1:a.y1+30,x2:(a.x2+a.x1)/2+H,y2:a.y2-20};const a9={x1:b.x2,y1:a.y1+30,x2:a.x2-10,y2:a.y2-20};const o={x1:b.x2,y1:a.y2-100,x2:a.x2-10,y2:a.y2-60};const t={x1:b.x2+45,y1:a.y1+37,x2:a.x2-12,y2:a.y2-101};const I='knob1';const J='knob2';const K='torch';const aa=10;let L=0;const M='audioStopped';const A='RADIO';let k=null;let e=null;const N=Graphics.createImage(`
    .......XXXXX..
    XXXXXXX.....XX
    X............X
    X............X
    X............X
    X............X
    X............X
    X............X
    XXXXXXXXXXXXXX
  `);const O=Graphics.createImage(`
    ........X.....
    .......XX.....
    ......XXX.....
    .....XXXX.....
    ....XXXXX.....
    .....XXXX.....
    ......XXX.....
    .......XX.....
    ........X.....
  `);const P=Graphics.createImage(`
    ..............
    ....XXXXXXXX..
    ....XX....XX..
    ....XX....XX..
    ....XX....XX..
    ....XX....XX..
    ..XXXX..XXXX..
    ..XXXX..XXXX..
    ..............
  `);const Q=Graphics.createImage(`
    ..............
    ..XX......XX..
    ...XX....XX...
    ....XX..XX....
    .....XXXX.....
    ....XX..XX....
    ...XX....XX...
    ..XX......XX..
    ..............
  `);const R=Graphics.createImage(`
    ..XX..........
    .XX...........
    XXXXXXXXXXXXX.
    .XX...........
    ..XX......XX..
    ...........XX.
    .XXXXXXXXXXXXX
    ...........XX.
    ..........XX..
  `);const ab=56;let i=A;let p=[];const l=10;let j=0;let d=0;let c=null;let h=!1;let m=[];let x=0;const ac=50;let B=0;let f=null;let q=null;let r=null;const ad=49.99923706054;let y=null;const S='#000000';const C='#FF0000';const ae=g.blendColor('#000',C,.5);const n=g.theme.fg;const z=g.blendColor('#000',n,.5);const T=g.blendColor('#000',n,.75);return F.run=function(){G=settings.idleTimeout,settings.idleTimeout=0,Pip.mode=MODE.RADIO,drawHeader(Pip.mode),a2(),as(),_(i),ai(),Y(),ag(),ah(),s()},F}CustomRadio().run()