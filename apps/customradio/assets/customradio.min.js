function CustomRadio(){function P(){x&&clearInterval(x),x=null}function C(){g.setColor(N).fillRect(p)}function a5(){r&&clearInterval(r),r=null,n=null,e&&(e=null,E.defrag())}function t(){if(a0===!1)return;u(a),u(b),u(p),u(a1),u(s),R()}function a6(){const d=Y.toUpperCase();const e='v'+Z;const c=5;const f=g.stringWidth(d);g.setColor(o).setFontAlign(-1,-1,0).setFontMonofonto16().drawString(d,b.x1,a.y1+8),g.setColor(y).setFontAlign(-1,-1,0).setFont('6x8').drawString(e,b.x1+f+c,a.y1+16),g.setColor(O).drawLine(b.x1,b.y1-c,b.x2,b.y1-c)}function u(a){g.setColor(O).drawRect(a.x1,a.y1,a.x2,a.y2)}function a7(){P(),x=setInterval(drawFooter,a4)}function a8(c){const a=c.replace(/\.wav$/i,'');const b=a.length>19?a.slice(0,16)+'...':a;g.setColor(o).setFontAlign(1,-1,0).setFontMonofonto16().drawString(b,p.x2,p.y1+20)}function a9(){g.setColor(y).setFontAlign(1,1,0).setFont('6x8').drawString('Now Playing',p.x2,p.y1+15)}function Q(){const a=i*l;const f=d.slice(a,a+l);g.setColor(N).fillRect(b),g.setFontMonofonto16().setFontAlign(-1,-1,0);const e=5;const h=20;f.forEach((i,j)=>{const f=b.y1+j*h+e;let a=ab(i);a=a.length>19?a.slice(0,16)+'...':a;const k=j===c?o:y;g.setColor(k);let d=b.x1+e;i.type==='folder'&&(g.drawImage(M,d,f),d+=M.width+4),g.drawString(a,d,f,!0)}),t()}function R(){const d=5;const h=3;const e=s.x1;const c=s.y1;const b=s.x2;const i=s.y2;const a=i-1;const f=b;for(let j=0;j<40;j++){const k=j%d===0?o:y;const b=j%d===0?2:1;const i=e+j*h;const l=a-b;g.setColor(k),g.drawLine(i,l,i,a),g.drawLine(f-b,c+j*3,f,c+j*3)}g.setColor(o),g.drawLine(e,a,b,a),g.drawLine(b,a,b,c)}function aa(){B=0,e=Graphics.createArrayBuffer(120,120,2,{msb:!0}),E.getAddressOf(e,0)===0&&(e=undefined,E.defrag(),e=Graphics.createArrayBuffer(120,120,2,{msb:!0})),n=new Uint16Array(60);for(let a=0;a<60;a+=2)n[a]=a*2;r&&clearInterval(r),r=setInterval(()=>{if(!e)return;if(e.clearRect(0,0,119,119),Pip.radioClipPlaying)Pip.getAudioWaveform(n,20,100);else if(Pip.radioOn&&(typeof RADIO_AUDIO)[0]!='u'){const a=analogRead(RADIO_AUDIO);const b=E.clip(60+(a-.263)*600,0,119)|0;for(let a=1;a<60;a+=2)n[a]=b}else{let a=B;for(let b=1;b<60;b+=2)n[b]=60+Math.sin(a)*45*Math.sin((a+=.6)*.13)}e.drawPolyAA(n),B+=.3,Pip.blitImage(e,285,75,{noScanEffect:!0})},a3)}function ab(a){return a.type==='folder'?a.name:a.name.replace(/\.wav$/i,'')}function ac(b){const a=b.lastIndexOf('/');return a<=0?v:b.slice(0,a)}function ad(e){const b=Date.now();if(b-K<a2)return;if(K=b,e!==0)return V(e*-1);const g=i*l;const a=d[g+c];if(!a)return;if(a.type==='random'){j?(j=!1,A()):q!==null?(j=!0,h='RANDOM',A()):S();return}if(a.type==='up'){U(ac(f));return}if(a.type==='folder'){U(z(f,a.name));return}if(a.type==='file'){const b='/'+z(f,a.name);q===b?(h=null,A()):(j=!1,h=a.name,q!==null?A():(D(a.name),h=null))}}function ae(){P(),a5(),X(),settings.idleTimeout=G,E.reboot()}function af(a){V(a)}function ag(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function ah(a){try{return fs.readdir('/'+a),!0}catch(a){return!1}}function ai(){if(j)W();else if(h){const a=h;h=null,a==='RANDOM'?S():D(a)}else q=null,Pip.radioClipPlaying=!1,C(),t()}function S(){j=!0,m=k.slice().sort(()=>Math.random()-.5),w=0,W()}function T(h){let a=h||f;ak();let b=[];try{b=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(c){print('Failed to read dir:',a,c),b=[]}const g=[];const e=[];for(let c=0;c<b.length;c++){const d=b[c];const f=z(a,d);ah(f)?g.push(d):/\.wav$/i.test(d)&&e.push(d)}d.push({type:'random',name:'RANDOM'}),a!==v&&d.push({type:'up',name:'< BACK'}),g.forEach(a=>d.push({type:'folder',name:a})),e.forEach(a=>d.push({type:'file',name:a})),k=e.slice(),print('Loaded folder '+a+': '+e.length+' songs, '+g.length+' folders.'),i=0,c=0,Q()}function U(a){j=!1,h=null,f=a,T(f)}function V(f){const a=i*l;const b=d.slice(a,a+l);const e=Math.floor((d.length-1)/l);c+=f,c<0?i>0?(i--,c=l-1):c=0:c>=b.length&&(i<e?(i++,c=0):c=b.length-1),Q()}function z(a,b){return a?b?a+'/'+b:a:b}function W(){if(!k||k.length===0){j=!1;return}(!m||w>=m.length)&&(m=k.slice().sort(()=>Math.random()-.5),w=0),D(m[w++])}function D(b){const a='/'+z(f,b);q=a,Pip.audioStart(a),Pip.radioClipPlaying=!0,C(),a9(),a8(b),t()}function X(){Pip.removeAllListeners(H),Pip.removeAllListeners(I),Pip.removeAllListeners(J),Pip.removeAllListeners(L)}function aj(){Pip.on(H,ad),Pip.on(I,af),Pip.on(J,ag),Pip.on(L,ai),setWatch(()=>ae(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function A(){Pip.audioStop(),q=null,Pip.radioClipPlaying=!1,C(),t()}function ak(){d=null,k=null,m=null,d=[],k=[],m=[]}const F={};const Y='Custom Radio';const Z='3.3.1';const _=g.getWidth();const $=g.getHeight();const a0=!1;let G=settings.idleTimeout;const a={x1:60,y1:40,x2:_-60,y2:$-20};const b={x1:a.x1+10,y1:a.y1+30,x2:(a.x2+a.x1)/2+10,y2:a.y2-20};const a1={x1:b.x2+10,y1:a.y1+30,x2:a.x2-10,y2:a.y2-20};const p={x1:b.x2+10,y1:a.y2-100,x2:a.x2-10,y2:a.y2-60};const s={x1:b.x2+45,y1:a.y1+37,x2:a.x2-12,y2:a.y2-101};const H='knob1';const I='knob2';const J='torch';const a2=10;let K=0;const L='audioStopped';const v='RADIO';let q=null;let h=null;const M=Graphics.createImage(`
    .........XXXXX..
    XXXXXXXXX.....XX
    X..............X
    X..............X
    X..............X
    X..............X
    X..............X
    X..............X
    XXXXXXXXXXXXXXXX
  `);let f=v;let k=[];const l=10;let i=0;let c=0;let d=null;let j=!1;let m=[];let w=0;const a3=50;let B=0;let e=null;let r=null;let n=null;const a4=49.99923706054;let x=null;const N='#000000';const o=g.theme.fg;const y=g.blendColor('#000',o,.5);const O=g.blendColor('#000',o,.75);return F.run=function(){G=settings.idleTimeout,settings.idleTimeout=0,Pip.mode=MODE.RADIO,drawHeader(Pip.mode),X(),aj(),f=v,T(f),aa(),R(),a6(),a7(),t()},F}CustomRadio().run()