function CustomRadio(){function Q(){y&&clearInterval(y),y=null}function F(){g.setColor(P).fillRect(o)}function a8(){r&&clearInterval(r),r=null,m=null,e&&(e=null,E.defrag())}function t(){if(a2===!1)return;u(a),u(b),u(o),u(a3),u(s),S()}function a9(){const d=_.toUpperCase();const e='v'+$;const c=5;const f=g.stringWidth(d);g.setColor(n).setFontAlign(-1,-1,0).setFontMonofonto16().drawString(d,b.x1,a.y1+8),g.setColor(z).setFontAlign(-1,-1,0).setFont('6x8').drawString(e,b.x1+f+c,a.y1+16),g.setColor(D).drawLine(b.x1,b.y1-c,b.x2,b.y1-c)}function u(a){g.setColor(D).drawRect(a.x1,a.y1,a.x2,a.y2)}function aa(){Q(),y=setInterval(drawFooter,a7)}function ab(c){const a=c.replace(/\.wav$/i,'');const b=a.length>19?a.slice(0,16)+'...':a;g.setColor(n).setFontAlign(1,-1,0).setFontMonofonto16().drawString(b,o.x2,o.y1+20)}function ac(){g.setColor(z).setFontAlign(1,1,0).setFont('6x8').drawString('Now Playing',o.x2,o.y1+15)}function R(){const a=i*k;const f=c.slice(a,a+k);g.setColor(P).fillRect(b),g.setFontMonofonto16().setFontAlign(-1,-1,0);const e=5;const h=20;f.forEach((f,j)=>{const i=b.y1+j*h+e;let a=ae(f);a=a.length>19?a.slice(0,16)+'...':a;const k=f.type==='ptl'?D:j===d?n:z;g.setColor(k);let c=b.x1+e;f.type==='folder'&&(g.drawImage(O,c,i),c+=O.width+4),g.drawString(a,c,i,!0)}),t()}function S(){const d=5;const h=3;const e=s.x1;const c=s.y1;const b=s.x2;const i=s.y2;const a=i-1;const f=b;for(let j=0;j<40;j++){const k=j%d===0?n:z;const b=j%d===0?2:1;const i=e+j*h;const l=a-b;g.setColor(k),g.drawLine(i,l,i,a),g.drawLine(f-b,c+j*3,f,c+j*3)}g.setColor(n),g.drawLine(e,a,b,a),g.drawLine(b,a,b,c)}function ad(){C=0,e=Graphics.createArrayBuffer(120,120,2,{msb:!0}),E.getAddressOf(e,0)===0&&(e=undefined,E.defrag(),e=Graphics.createArrayBuffer(120,120,2,{msb:!0})),m=new Uint16Array(60);for(let a=0;a<60;a+=2)m[a]=a*2;r&&clearInterval(r),r=setInterval(()=>{if(!e)return;if(e.clearRect(0,0,119,119),Pip.radioClipPlaying)Pip.getAudioWaveform(m,20,100);else if(Pip.radioOn&&(typeof RADIO_AUDIO)[0]!='u'){const a=analogRead(RADIO_AUDIO);const b=E.clip(60+(a-.263)*600,0,119)|0;for(let a=1;a<60;a+=2)m[a]=b}else{let a=C;for(let b=1;b<60;b+=2)m[b]=60+Math.sin(a)*45*Math.sin((a+=.6)*.13)}e.drawPolyAA(m),C+=.3,Pip.blitImage(e,285,75,{noScanEffect:!0})},a6)}function ae(a){let b=a.displayName||a.fsName||a.name;return a.type!=='folder'&&(b=b.replace(/\.wav$/i,'')),b}function af(b){const a=b.lastIndexOf('/');return a<=0?w:b.slice(0,a)}function ag(e){const b=Date.now();if(b-M<a4)return;if(M=b,e!==0)return U(e*-1);const g=i*k;const a=c[g+d];if(!a)return;if(a.type==='random'){j?(j=!1,B()):p!==null?(j=!0,f='RANDOM',B()):Y();return}if(a.type==='ptl')return;if(a.type==='up'){V(af(h));return}if(a.type==='folder'){V(v(h,a.fsName));return}if(a.type==='file'){const b='/'+v(h,a.fsName);p===b?(f=null,B()):(j=!1,p!==null?(f=a,B()):G(a));return}}function ah(){Q(),a8(),X(),settings.idleTimeout=I,E.reboot()}function ai(a){U(a)}function aj(){const a=[1,5,10,15,20];const b=a.findIndex(a=>a===Pip.brightness);const c=(b+1)%a.length;Pip.brightness=a[c],Pip.updateBrightness()}function ak(a){try{return fs.readdir('/'+a),!0}catch(a){return!1}}function T(g){let a=g||h;an();let b=[];try{b=fs.readdir('/'+a).filter(a=>a!=='.'&&a!=='..').sort()}catch(c){print('Failed to read dir:',a,c),b=[]}const e=[];const f=[];for(let c=0;c<b.length;c++){const d=b[c];const g=v(a,d);ak(g)?e.push(d):/\.wav$/i.test(d)&&f.push(d)}c.push({type:'random',name:'RANDOM'}),a!==w&&c.push({type:'up',name:'< BACK'}),e.forEach(b=>{Z(a,b)?c.push({type:'ptl',fsName:b,displayName:'PTL: '+A(b)}):c.push({type:'folder',fsName:b,displayName:A(b)})}),f.forEach(b=>{Z(a,b)?c.push({type:'ptl',fsName:b,displayName:'PTL: '+A(b)}):c.push({type:'file',fsName:b,displayName:A(b)})}),q=c.filter(a=>a.type==='file'),print('Loaded folder '+a+': '+f.length+' songs, '+e.length+' folders.'),i=0,d=0,R()}function U(f){const a=i*k;const b=c.slice(a,a+k);const e=Math.floor((c.length-1)/k);d+=f,d<0?i>0?(i--,d=k-1):d=0:d>=b.length&&(i<e?(i++,d=0):d=b.length-1),R()}function V(a){j=!1,f=null,h=a,T(h)}function al(){if(p=null,Pip.radioClipPlaying=!1,j){W();return}if(f==='RANDOM'){f=null,Y();return}if(f){const a=f;f=null,G(a);return}F(),t()}function v(a,b){return a?b?a+'/'+b:a:b}function G(a){const b='/'+v(h,a.fsName);p=b,Pip.audioStart(b),Pip.radioClipPlaying=!0,F(),ac(),ab(a.displayName||a.fsName),t()}function W(){if(!q.length){j=!1;return}(!l||x>=l.length)&&(l=q.slice().sort(()=>Math.random()-.5),x=0),G(l[x++])}function X(){Pip.removeAllListeners(J),Pip.removeAllListeners(K),Pip.removeAllListeners(L),Pip.removeAllListeners(N)}function A(a){return a.replace(/[^0-9A-Za-z._-]/g,'_')}function am(){Pip.on(J,ag),Pip.on(K,ai),Pip.on(L,aj),Pip.on(N,al),setWatch(()=>ah(),BTN_POWER,{debounce:50,edge:'rising',repeat:!0})}function Y(){j=!0,l=q.slice().sort(()=>Math.random()-.5),x=0,W()}function B(){Pip.audioStop(),p=null,Pip.radioClipPlaying=!1,F(),t()}function Z(a,b){return('/'+v(a,b)).length>a5}function an(){c=null,q=null,l=null,c=[],q=[],l=[]}const H={};const _='Custom Radio';const $='3.3.1';const a0=g.getWidth();const a1=g.getHeight();const a2=!1;let I=settings.idleTimeout;const a={x1:60,y1:40,x2:a0-60,y2:a1-20};const b={x1:a.x1+10,y1:a.y1+30,x2:(a.x2+a.x1)/2+15,y2:a.y2-20};const a3={x1:b.x2+10,y1:a.y1+30,x2:a.x2-10,y2:a.y2-20};const o={x1:b.x2+10,y1:a.y2-100,x2:a.x2-10,y2:a.y2-60};const s={x1:b.x2+45,y1:a.y1+37,x2:a.x2-12,y2:a.y2-101};const J='knob1';const K='knob2';const L='torch';const a4=10;let M=0;const N='audioStopped';const w='RADIO';let p=null;let f=null;const O=Graphics.createImage(`
    .........XXXXX..
    XXXXXXXXX.....XX
    X..............X
    X..............X
    X..............X
    X..............X
    X..............X
    X..............X
    XXXXXXXXXXXXXXXX
  `);const a5=60;let h=w;let q=[];const k=10;let i=0;let d=0;let c=null;let j=!1;let l=[];let x=0;const a6=50;let C=0;let e=null;let r=null;let m=null;const a7=49.99923706054;let y=null;const P='#000000';const n=g.theme.fg;const z=g.blendColor('#000',n,.5);const D=g.blendColor('#000',n,.75);return H.run=function(){I=settings.idleTimeout,settings.idleTimeout=0,Pip.mode=MODE.RADIO,drawHeader(Pip.mode),X(),am(),h=w,T(h),ad(),S(),a9(),aa(),t()},H}CustomRadio().run()