<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>

    <h2>Custom Map</h2>
    <p></p>

    <p>Upload an image (2000x2000pc): <input class="form-input" id="customfile" type="file"></p>
    <div style="float:right">Preview:<br/><canvas width="256" height="256" id="preview"></canvas></div>
    <img class="thumbnail" id="customimage" src="" face="custom" style="display:none"/>
    <p>Click <button id="upload" class="btn btn-primary disabled" style>Upload</button></p>

    <script src="../../core/lib/customize.js"></script>
    <script src="../../webtools/imageconverter.js"></script>

    <script>

      function drawPreview() {
        var img = document.getElementById("customimage");
        var zoom = document.getElementById("box_zoom").value;
        var dither = document.getElementById("box_dither").value;
        if (dither=="" && img.dither) dither="bayer2";
        if (dither=="no" || dither=="") dither=undefined;
        var mirror = document.getElementById("box_mirror").checked;
        var brightness = 0|document.getElementById("box_bright").value;
        const canvas = document.getElementById("preview");
        canvas.width = 2048; // setting size clears canvas
        canvas.height = 2048;
        const ctx = canvas.getContext("2d");
        var y = 0;
        console.log(selectedImage);
        let imgW = selectedImage.naturalWidth;
        let imgH = selectedImage.naturalHeight;
        let border = 0;
        let imgMin = Math.min(imgW,imgH);
        switch (zoom) {
          case "0": border = 0; break;
          case "1": border = Math.round(imgMin*0.1); break;
          case "1.5": border = Math.round(imgMin*0.15); break;
          case "2": border = Math.round(imgMin*0.2); break;
        }
        ctx.save(); // Save the current state
        if (mirror) {
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
        }
        ctx.drawImage(selectedImage, border, border, imgW-border*2, imgH-border*2, 0, y, canvas.width, canvas.height);
        ctx.restore();
        var options = {
          mode:"3bit",
          output:"raw",
          compression:false,
          updateCanvas:true,
          transparent:false,
          diffusion:dither,
          contrast: brightness ? -64 : 64,
          brightness:64*brightness
        };
        bgImageData = imageconverter.canvastoString(canvas, options);
        document.getElementById("upload").classList.remove("disabled")
      }

      // If options changed
      /*document.getElementById("///").addEventListener("click", function() {
        drawPreview();
      });*/


      // Custom image upload
      document.getElementById('customfile').onchange = function (evt) {
      var tgt = evt.target || window.event.srcElement, files = tgt.files;
      if (FileReader && files && files.length) {
        var fr = new FileReader();
        fr.onload = function () {
          document.getElementById("customimage").src = fr.result;
          drawPreview();
        }
        fr.readAsDataURL(files[0]);
      }
    }
      // When the 'upload' button is clicked...
      document.getElementById("upload").addEventListener("click", function() {
        var js = "";

        sendCustomizedApp({
          storage:[
            {name:"MAP/MAP.img", content:bgImageData},
          ]
        });
      });


      // Called when we know what device we're using
      function onInit(device) {
      }

    </script>
  </body>
</html>
